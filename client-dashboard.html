<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Content Dashboard | Karma Marketing + Media</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="/static/js/unified-header.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap');
        * { font-family: 'Inter', sans-serif; }
        body { background: #0f172a; }
        .glass { background: rgba(255,255,255,0.03); backdrop-filter: blur(20px); border: 1px solid rgba(255,255,255,0.1); }
        .glass-light { background: rgba(255,255,255,0.95); }
        .gradient-text { background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .gradient-border { border: 2px solid transparent; background: linear-gradient(#1e293b, #1e293b) padding-box, linear-gradient(135deg, #667eea, #764ba2, #f093fb) border-box; }
        .stat-card { transition: all 0.3s; }
        .stat-card:hover { transform: translateY(-4px); box-shadow: 0 20px 40px rgba(102,126,234,0.2); }
        .content-card { transition: all 0.3s; }
        .content-card:hover { transform: translateY(-2px); }
        .pulse-dot { animation: pulse 2s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        .blog-content { line-height: 1.8; }
        .blog-content h2 { font-size: 1.5rem; font-weight: 700; margin: 1.5rem 0 1rem; color: #1e293b; }
        .blog-content h3 { font-size: 1.25rem; font-weight: 600; margin: 1.25rem 0 0.75rem; color: #334155; }
        .blog-content p { margin-bottom: 1rem; color: #475569; }
        .blog-content ul, .blog-content ol { margin: 1rem 0; padding-left: 1.5rem; }
        .blog-content li { margin-bottom: 0.5rem; color: #475569; }
        .blog-content a { color: #667eea; text-decoration: underline; }
        .internal-link { background: linear-gradient(135deg, #667eea20, #764ba220); padding: 2px 6px; border-radius: 4px; }
        .tab-active { background: linear-gradient(135deg, #667eea, #764ba2); color: white; }
        .fade-in { animation: fadeIn 0.5s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .spinner { border: 3px solid rgba(255,255,255,0.1); border-top-color: #667eea; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .social-gbp { border-left: 4px solid #4285f4; }
        .social-facebook { border-left: 4px solid #1877f2; }
        .social-instagram { border-left: 4px solid #e4405f; }
        
        /* Onboarding Tour Styles */
        .tour-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.7); z-index: 9998; }
        .tour-highlight { position: relative; z-index: 9999; box-shadow: 0 0 0 4px #8b5cf6, 0 0 0 9999px rgba(0,0,0,0.7); border-radius: 8px; }
        .tour-tooltip { position: fixed; z-index: 10000; background: white; border-radius: 12px; padding: 20px; max-width: 320px; box-shadow: 0 20px 50px rgba(0,0,0,0.3); }
        .tour-tooltip::before { content: ''; position: absolute; width: 12px; height: 12px; background: white; transform: rotate(45deg); }
        .tour-tooltip.top::before { bottom: -6px; left: 50%; margin-left: -6px; }
        .tour-tooltip.bottom::before { top: -6px; left: 50%; margin-left: -6px; }
        .tour-tooltip.left::before { right: -6px; top: 50%; margin-top: -6px; }
        .tour-tooltip.right::before { left: -6px; top: 50%; margin-top: -6px; }
        .tour-progress { display: flex; gap: 4px; margin-top: 16px; }
        .tour-progress-dot { width: 8px; height: 8px; border-radius: 50%; background: #e2e8f0; }
        .tour-progress-dot.active { background: #8b5cf6; }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.0.6/purify.min.js"></script>
</head>
<body class="min-h-screen">
    <!-- Auth Modal -->
    <div id="authModal" class="fixed inset-0 bg-black/80 flex items-center justify-center z-50">
        <div class="glass rounded-2xl p-8 w-full max-w-md mx-4 fade-in">
            <div class="text-center mb-6">
                <h1 class="text-3xl font-bold gradient-text mb-2" data-brand="name">Karma Marketing + Media</h1>
                <p class="text-gray-400">Content Dashboard</p>
            </div>
            <div class="space-y-4">
                <input type="hidden" id="apiUrl" value="">
                <input type="email" id="loginEmail" class="w-full px-4 py-3 bg-white/10 border border-white/20 rounded-xl text-white placeholder-gray-400 focus:outline-none focus:border-purple-500" placeholder="Email">
                <input type="password" id="loginPassword" autocomplete="current-password" class="w-full px-4 py-3 bg-white/10 border border-white/20 rounded-xl text-white placeholder-gray-400 focus:outline-none focus:border-purple-500" placeholder="Password">
                <button onclick="doLogin()" class="w-full py-3 bg-gradient-to-r from-purple-600 to-pink-600 rounded-xl text-white font-semibold hover:opacity-90 transition">
                    Sign In
                </button>
                <p id="authError" class="text-red-400 text-sm text-center hidden"></p>
            </div>
        </div>
    </div>

    <!-- Main Dashboard -->
    <div id="dashboard" class="hidden">
        <!-- Navigation Bar -->
        <nav class="bg-slate-900 border-b border-white/10">
            <div class="max-w-7xl mx-auto px-4">
                <div class="flex items-center justify-between h-12">
                    <!-- Mobile menu button -->
                    <button onclick="toggleMobileNav()" class="md:hidden p-2 text-gray-400 hover:text-white">
                        <i class="fas fa-bars"></i>
                    </button>
                    
                    <!-- Desktop nav -->
                    <div class="hidden md:flex items-center gap-6 text-sm">
                        <a href="/intake" class="text-gray-400 hover:text-white transition flex items-center gap-2">
                            <i class="fas fa-plus-circle"></i> New Client
                        </a>
                        <a href="/agency" class="text-gray-400 hover:text-white transition flex items-center gap-2">
                            <i class="fas fa-building"></i> Agency
                        </a>
                        <a href="/client" class="text-white font-medium flex items-center gap-2">
                            <i class="fas fa-file-alt"></i> Content
                        </a>
                        <a href="/elite" class="text-gray-400 hover:text-white transition flex items-center gap-2">
                            <i class="fas fa-chart-line"></i> SEO Elite
                        </a>
                        <a href="/admin" class="text-gray-400 hover:text-white transition flex items-center gap-2">
                            <i class="fas fa-cog"></i> Admin
                        </a>
                    </div>
                    <div class="text-xs text-gray-500">
                        <span class="text-purple-400">MCP</span> Framework
                    </div>
                </div>
                
                <!-- Mobile nav dropdown -->
                <div id="mobileNav" class="hidden md:hidden pb-4">
                    <div class="flex flex-col gap-2 text-sm">
                        <a href="/intake" class="text-gray-400 hover:text-white transition flex items-center gap-2 py-2">
                            <i class="fas fa-plus-circle w-5"></i> New Client
                        </a>
                        <a href="/agency" class="text-gray-400 hover:text-white transition flex items-center gap-2 py-2">
                            <i class="fas fa-building w-5"></i> Agency
                        </a>
                        <a href="/client" class="text-white font-medium flex items-center gap-2 py-2">
                            <i class="fas fa-file-alt w-5"></i> Content
                        </a>
                        <a href="/elite" class="text-gray-400 hover:text-white transition flex items-center gap-2 py-2">
                            <i class="fas fa-chart-line w-5"></i> SEO Elite
                        </a>
                        <a href="/admin" class="text-gray-400 hover:text-white transition flex items-center gap-2 py-2">
                            <i class="fas fa-cog w-5"></i> Admin
                        </a>
                    </div>
                </div>
            </div>
        </nav>

        <!-- Header -->
        <header class="glass border-b border-white/10 sticky top-0 z-40">
            <div class="max-w-7xl mx-auto px-4 py-4">
                <div class="flex flex-col sm:flex-row sm:items-center justify-between gap-4">
                    <div class="flex items-center gap-4">
                        <div class="w-10 h-10 rounded-xl bg-gradient-to-br from-purple-600 to-pink-600 flex items-center justify-center flex-shrink-0">
                            <i class="fas fa-rocket text-white"></i>
                        </div>
                        <div class="min-w-0">
                            <h1 id="clientName" class="text-lg sm:text-xl font-bold text-white truncate">Loading...</h1>
                            <p id="clientMeta" class="text-xs sm:text-sm text-gray-400 truncate">Content Dashboard</p>
                        </div>
                    </div>
                    <div class="flex items-center gap-2 sm:gap-4">
                        <select id="clientSelector" onchange="loadClient(this.value)" class="flex-1 sm:flex-none px-3 sm:px-4 py-2 bg-white/10 border border-white/20 rounded-lg text-white text-sm focus:outline-none truncate max-w-[200px]">
                            <option value="">Select Client</option>
                        </select>
                        <button onclick="showEditClient()" class="p-2 glass rounded-lg text-gray-400 hover:text-blue-400 transition flex-shrink-0" title="Edit Client">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button onclick="confirmDeleteClient()" class="p-2 glass rounded-lg text-gray-400 hover:text-red-400 transition flex-shrink-0" title="Delete Client">
                            <i class="fas fa-trash"></i>
                        </button>
                        <button onclick="refreshData()" class="p-2 glass rounded-lg text-gray-400 hover:text-white transition flex-shrink-0" title="Refresh">
                            <i class="fas fa-sync-alt"></i>
                        </button>
                        <button onclick="startTour()" class="p-2 glass rounded-lg text-gray-400 hover:text-white transition flex-shrink-0" title="Help Tour">
                            <i class="fas fa-question-circle"></i>
                        </button>
                    </div>
                </div>
            </div>
        </header>

        <!-- Stats Bar -->
        <div class="max-w-7xl mx-auto px-4 py-6">
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                <div class="stat-card glass rounded-xl p-4">
                    <div class="flex items-center gap-3">
                        <div class="w-12 h-12 rounded-xl bg-gradient-to-br from-green-500 to-emerald-600 flex items-center justify-center">
                            <i class="fas fa-file-alt text-white text-xl"></i>
                        </div>
                        <div>
                            <p id="statBlogs" class="text-2xl font-bold text-white">0</p>
                            <p class="text-sm text-gray-400">Blog Posts</p>
                        </div>
                    </div>
                </div>
                <div class="stat-card glass rounded-xl p-4">
                    <div class="flex items-center gap-3">
                        <div class="w-12 h-12 rounded-xl bg-gradient-to-br from-blue-500 to-cyan-600 flex items-center justify-center">
                            <i class="fas fa-share-alt text-white text-xl"></i>
                        </div>
                        <div>
                            <p id="statSocial" class="text-2xl font-bold text-white">0</p>
                            <p class="text-sm text-gray-400">Social Posts</p>
                        </div>
                    </div>
                </div>
                <div class="stat-card glass rounded-xl p-4">
                    <div class="flex items-center gap-3">
                        <div class="w-12 h-12 rounded-xl bg-gradient-to-br from-purple-500 to-violet-600 flex items-center justify-center">
                            <i class="fas fa-key text-white text-xl"></i>
                        </div>
                        <div>
                            <p id="statKeywords" class="text-2xl font-bold text-white">0</p>
                            <p class="text-sm text-gray-400">Keywords</p>
                        </div>
                    </div>
                </div>
                <div class="stat-card glass rounded-xl p-4">
                    <div class="flex items-center gap-3">
                        <div class="w-12 h-12 rounded-xl bg-gradient-to-br from-orange-500 to-red-600 flex items-center justify-center">
                            <i class="fas fa-users text-white text-xl"></i>
                        </div>
                        <div>
                            <p id="statCompetitors" class="text-2xl font-bold text-white">0</p>
                            <p class="text-sm text-gray-400">Competitors</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tabs -->
        <div class="max-w-7xl mx-auto px-4 mb-6">
            <div class="flex gap-2 overflow-x-auto pb-2 scrollbar-thin">
                <button onclick="showTab('generate')" id="tab-generate" class="px-3 sm:px-6 py-2 rounded-lg text-xs sm:text-sm font-medium text-gray-400 hover:text-white transition whitespace-nowrap glass bg-gradient-to-r from-green-600 to-emerald-600 text-white">
                    <i class="fas fa-magic sm:mr-2"></i><span class="hidden sm:inline">Generate Content</span><span class="sm:hidden">Generate</span>
                </button>
                <button onclick="showTab('blogs')" id="tab-blogs" class="tab-active px-3 sm:px-6 py-2 rounded-lg text-xs sm:text-sm font-medium transition whitespace-nowrap">
                    <i class="fas fa-file-alt sm:mr-2"></i><span class="hidden sm:inline">Blog Posts</span><span class="sm:hidden">Blogs</span>
                </button>
                <button onclick="showTab('social')" id="tab-social" class="px-3 sm:px-6 py-2 rounded-lg text-xs sm:text-sm font-medium text-gray-400 hover:text-white transition whitespace-nowrap glass">
                    <i class="fas fa-share-alt sm:mr-2"></i><span class="hidden sm:inline">Social Posts</span><span class="sm:hidden">Social</span>
                </button>
                <button onclick="showTab('seo')" id="tab-seo" class="px-3 sm:px-6 py-2 rounded-lg text-xs sm:text-sm font-medium text-gray-400 hover:text-white transition whitespace-nowrap glass">
                    <i class="fas fa-chart-line sm:mr-2"></i><span class="hidden sm:inline">SEO Overview</span><span class="sm:hidden">SEO</span>
                </button>
                <button onclick="showTab('calendar')" id="tab-calendar" class="px-3 sm:px-6 py-2 rounded-lg text-xs sm:text-sm font-medium text-gray-400 hover:text-white transition whitespace-nowrap glass">
                    <i class="fas fa-calendar-alt sm:mr-2"></i><span class="hidden sm:inline">Calendar</span><span class="sm:hidden">Cal</span>
                </button>
                <button onclick="showTab('reports')" id="tab-reports" class="px-3 sm:px-6 py-2 rounded-lg text-xs sm:text-sm font-medium text-gray-400 hover:text-white transition whitespace-nowrap glass">
                    <i class="fas fa-file-pdf sm:mr-2"></i><span class="hidden sm:inline">Reports</span><span class="sm:hidden">PDF</span>
                </button>
                <button onclick="showTab('rankings')" id="tab-rankings" class="px-3 sm:px-6 py-2 rounded-lg text-xs sm:text-sm font-medium text-gray-400 hover:text-white transition whitespace-nowrap glass">
                    <i class="fas fa-trophy sm:mr-2"></i><span class="hidden sm:inline">Rankings</span><span class="sm:hidden">Rank</span>
                </button>
                <button onclick="showTab('competitors')" id="tab-competitors" class="px-3 sm:px-6 py-2 rounded-lg text-xs sm:text-sm font-medium text-gray-400 hover:text-white transition whitespace-nowrap glass">
                    <i class="fas fa-users sm:mr-2"></i><span class="hidden sm:inline">Competitors</span><span class="sm:hidden">Comp</span>
                </button>
                <button onclick="showTab('settings')" id="tab-settings" class="px-3 sm:px-6 py-2 rounded-lg text-xs sm:text-sm font-medium text-gray-400 hover:text-white transition whitespace-nowrap glass">
                    <i class="fas fa-cog sm:mr-2"></i><span class="hidden sm:inline">Settings</span><span class="sm:hidden">Set</span>
                </button>
                <button onclick="showTab('chatbot')" id="tab-chatbot" class="px-3 sm:px-6 py-2 rounded-lg text-xs sm:text-sm font-medium text-gray-400 hover:text-white transition whitespace-nowrap glass">
                    <i class="fas fa-robot sm:mr-2"></i><span class="hidden sm:inline">AI Chatbot</span><span class="sm:hidden">Bot</span>
                </button>
            </div>
        </div>

        <!-- Content Panels -->
        <div class="max-w-7xl mx-auto px-4 pb-12">
            <!-- Generate Panel -->
            <div id="panel-generate" class="hidden fade-in">
                <div class="grid md:grid-cols-2 gap-6">
                    <!-- Blog Generation -->
                    <div class="glass rounded-2xl p-6">
                        <div class="flex items-center gap-3 mb-6">
                            <div class="w-12 h-12 rounded-xl bg-gradient-to-br from-green-500 to-emerald-600 flex items-center justify-center">
                                <i class="fas fa-file-alt text-white text-xl"></i>
                            </div>
                            <div>
                                <h3 class="text-lg font-bold text-white">Generate Blog Post</h3>
                                <p class="text-sm text-gray-400">1,500 words with FAQs & internal links</p>
                            </div>
                        </div>
                        
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-300 mb-2">Select Keyword</label>
                                <select id="blogKeyword" class="w-full px-4 py-3 bg-white/10 border border-white/20 rounded-xl text-white focus:outline-none focus:border-purple-500">
                                    <option value="">Choose a keyword...</option>
                                </select>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-300 mb-2">Or Enter Custom Keyword</label>
                                <input type="text" id="customBlogKeyword" placeholder="e.g., emergency AC repair" 
                                    class="w-full px-4 py-3 bg-white/10 border border-white/20 rounded-xl text-white placeholder-gray-500 focus:outline-none focus:border-purple-500">
                            </div>
                            
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-300 mb-2">Word Count</label>
                                    <select id="blogWordCount" class="w-full px-4 py-3 bg-white/10 border border-white/20 rounded-xl text-white focus:outline-none focus:border-purple-500">
                                        <option value="1500">1,500 words</option>
                                        <option value="1800" selected>1,800 words</option>
                                        <option value="2000">2,000 words</option>
                                        <option value="2500">2,500 words</option>
                                        <option value="2000">2,000 words</option>
                                        <option value="2500">2,500 words</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-300 mb-2">Include FAQs</label>
                                    <select id="blogFaqs" class="w-full px-4 py-3 bg-white/10 border border-white/20 rounded-xl text-white focus:outline-none focus:border-purple-500">
                                        <option value="5" selected>5 FAQs</option>
                                        <option value="3">3 FAQs</option>
                                        <option value="0">No FAQs</option>
                                    </select>
                                </div>
                            </div>
                            
                            <!-- Featured Image Option -->
                            <div class="p-4 bg-gradient-to-r from-amber-500/10 to-orange-500/10 border border-amber-500/20 rounded-xl">
                                <label class="flex items-center justify-between cursor-pointer">
                                    <div class="flex items-center gap-3">
                                        <div class="w-10 h-10 rounded-lg bg-amber-500/20 flex items-center justify-center">
                                            <i class="fas fa-image text-amber-400"></i>
                                        </div>
                                        <div>
                                            <span class="text-white font-medium">Generate Featured Image</span>
                                            <p class="text-xs text-gray-400">AI-powered image matching your topic</p>
                                        </div>
                                    </div>
                                    <input type="checkbox" id="blogGenerateImage" checked class="w-5 h-5 text-amber-600 rounded">
                                </label>
                            </div>
                            
                            <button onclick="generateBlog()" id="btnGenerateBlog" 
                                class="w-full py-4 bg-gradient-to-r from-green-600 to-emerald-600 rounded-xl text-white font-bold hover:opacity-90 transition flex items-center justify-center gap-2">
                                <i class="fas fa-magic"></i> Generate Blog Post
                            </button>
                        </div>
                        
                        <div id="blogProgress" class="hidden mt-4 p-4 bg-white/5 rounded-xl">
                            <div class="flex items-center gap-3">
                                <div class="spinner w-6 h-6"></div>
                                <span id="blogProgressText" class="text-gray-300">Generating...</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Social Generation -->
                    <div class="glass rounded-2xl p-6">
                        <div class="flex items-center gap-3 mb-6">
                            <div class="w-12 h-12 rounded-xl bg-gradient-to-br from-blue-500 to-cyan-600 flex items-center justify-center">
                                <i class="fas fa-share-alt text-white text-xl"></i>
                            </div>
                            <div>
                                <h3 class="text-lg font-bold text-white">Generate Social Posts</h3>
                                <p class="text-sm text-gray-400">GBP, Facebook & Instagram</p>
                            </div>
                        </div>
                        
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-300 mb-2">Topic / Keyword</label>
                                <input type="text" id="socialTopic" placeholder="e.g., summer AC maintenance tips" 
                                    class="w-full px-4 py-3 bg-white/10 border border-white/20 rounded-xl text-white placeholder-gray-500 focus:outline-none focus:border-purple-500">
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-300 mb-2">Platforms</label>
                                <div class="grid grid-cols-3 gap-2">
                                    <label class="flex items-center gap-2 p-3 bg-white/5 rounded-lg cursor-pointer hover:bg-white/10 transition">
                                        <input type="checkbox" id="platformGbp" checked class="w-4 h-4 text-blue-600 rounded">
                                        <i class="fab fa-google text-blue-400"></i>
                                        <span class="text-sm text-white">GBP</span>
                                    </label>
                                    <label class="flex items-center gap-2 p-3 bg-white/5 rounded-lg cursor-pointer hover:bg-white/10 transition">
                                        <input type="checkbox" id="platformFacebook" checked class="w-4 h-4 text-blue-600 rounded">
                                        <i class="fab fa-facebook text-blue-500"></i>
                                        <span class="text-sm text-white">FB</span>
                                    </label>
                                    <label class="flex items-center gap-2 p-3 bg-white/5 rounded-lg cursor-pointer hover:bg-white/10 transition">
                                        <input type="checkbox" id="platformInstagram" checked class="w-4 h-4 text-pink-600 rounded">
                                        <i class="fab fa-instagram text-pink-500"></i>
                                        <span class="text-sm text-white">IG</span>
                                    </label>
                                </div>
                            </div>
                            
                            <button onclick="generateSocial()" id="btnGenerateSocial" 
                                class="w-full py-4 bg-gradient-to-r from-blue-600 to-cyan-600 rounded-xl text-white font-bold hover:opacity-90 transition flex items-center justify-center gap-2">
                                <i class="fas fa-magic"></i> Generate Social Posts
                            </button>
                        </div>
                        
                        <div id="socialProgress" class="hidden mt-4 p-4 bg-white/5 rounded-xl">
                            <div class="flex items-center gap-3">
                                <div class="spinner w-6 h-6"></div>
                                <span id="socialProgressText" class="text-gray-300">Generating...</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- AI Image Generation -->
                    <div class="glass rounded-2xl p-6">
                        <div class="flex items-center gap-3 mb-6">
                            <div class="w-12 h-12 rounded-xl bg-gradient-to-br from-amber-500 to-orange-600 flex items-center justify-center">
                                <i class="fas fa-image text-white text-xl"></i>
                            </div>
                            <div>
                                <h3 class="text-lg font-bold text-white">AI Image Generator</h3>
                                <p class="text-sm text-gray-400">Create images with DALL-E & more</p>
                            </div>
                        </div>
                        
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-300 mb-2">Image Description</label>
                                <textarea id="imagePrompt" rows="3" placeholder="Describe the image you want to create..."
                                    class="w-full px-4 py-3 bg-white/10 border border-white/20 rounded-xl text-white placeholder-gray-500 focus:outline-none focus:border-amber-500 resize-none"></textarea>
                            </div>
                            
                            <div class="grid grid-cols-2 gap-3">
                                <div>
                                    <label class="block text-sm font-medium text-gray-300 mb-2">Style</label>
                                    <select id="imageStyle" class="w-full px-4 py-3 bg-white/10 border border-white/20 rounded-xl text-white focus:outline-none focus:border-amber-500">
                                        <option value="photorealistic">üì∑ Photorealistic</option>
                                        <option value="social_media">üì± Social Media</option>
                                        <option value="corporate">üíº Corporate</option>
                                        <option value="illustration">üé® Illustration</option>
                                        <option value="minimal">‚ú® Minimal</option>
                                        <option value="lifestyle">üè° Lifestyle</option>
                                        <option value="product">üõçÔ∏è Product</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-300 mb-2">Size</label>
                                    <select id="imageSize" class="w-full px-4 py-3 bg-white/10 border border-white/20 rounded-xl text-white focus:outline-none focus:border-amber-500">
                                        <option value="1024x1024">Square (1024x1024)</option>
                                        <option value="1792x1024">Landscape (1792x1024)</option>
                                        <option value="1024x1792">Portrait (1024x1792)</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div class="flex gap-2">
                                <button onclick="generateImage()" id="btnGenerateImage" 
                                    class="flex-1 py-4 bg-gradient-to-r from-amber-600 to-orange-600 rounded-xl text-white font-bold hover:opacity-90 transition flex items-center justify-center gap-2">
                                    <i class="fas fa-wand-magic-sparkles"></i> Generate Image
                                </button>
                                <button onclick="generateSocialImages()" id="btnGenerateSocialImages" 
                                    class="px-4 py-4 bg-white/10 hover:bg-white/20 rounded-xl text-white transition" title="Generate for all platforms">
                                    <i class="fas fa-layer-group"></i>
                                </button>
                            </div>
                        </div>
                        
                        <!-- Generated Image Preview -->
                        <div id="imagePreview" class="hidden mt-4">
                            <div class="relative rounded-xl overflow-hidden bg-white/5">
                                <img id="generatedImage" src="" alt="Generated Image" class="w-full h-auto">
                                <div class="absolute bottom-0 left-0 right-0 p-3 bg-gradient-to-t from-black/80 to-transparent">
                                    <div class="flex items-center justify-between">
                                        <span id="imageProvider" class="text-xs text-gray-400">Generated with DALL-E</span>
                                        <div class="flex gap-2">
                                            <a id="imageDownload" href="#" download class="p-2 bg-white/20 hover:bg-white/30 rounded-lg transition">
                                                <i class="fas fa-download text-white text-sm"></i>
                                            </a>
                                            <button onclick="copyImageUrl()" class="p-2 bg-white/20 hover:bg-white/30 rounded-lg transition">
                                                <i class="fas fa-copy text-white text-sm"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div id="imageProgress" class="hidden mt-4 p-4 bg-white/5 rounded-xl">
                            <div class="flex items-center gap-3">
                                <div class="spinner w-6 h-6"></div>
                                <span id="imageProgressText" class="text-gray-300">Generating image...</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Bulk Generation -->
                <div class="glass rounded-2xl p-6 mt-6">
                    <div class="flex items-center gap-3 mb-6">
                        <div class="w-12 h-12 rounded-xl bg-gradient-to-br from-purple-500 to-pink-600 flex items-center justify-center">
                            <i class="fas fa-layer-group text-white text-xl"></i>
                        </div>
                        <div>
                            <h3 class="text-lg font-bold text-white">Bulk Generate</h3>
                            <p class="text-sm text-gray-400">Generate multiple posts at once</p>
                        </div>
                    </div>
                    
                    <div class="grid md:grid-cols-3 gap-4 mb-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-300 mb-2">Blog Posts to Generate</label>
                            <select id="bulkBlogCount" class="w-full px-4 py-3 bg-white/10 border border-white/20 rounded-xl text-white focus:outline-none focus:border-purple-500">
                                <option value="0">0 blogs</option>
                                <option value="3">3 blogs</option>
                                <option value="5" selected>5 blogs</option>
                                <option value="10">10 blogs</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-300 mb-2">Social Posts Per Platform</label>
                            <select id="bulkSocialCount" class="w-full px-4 py-3 bg-white/10 border border-white/20 rounded-xl text-white focus:outline-none focus:border-purple-500">
                                <option value="0">0 social</option>
                                <option value="3">3 per platform</option>
                                <option value="5" selected>5 per platform</option>
                                <option value="10">10 per platform</option>
                            </select>
                        </div>
                        <div class="flex items-end">
                            <button onclick="generateBulk()" id="btnGenerateBulk" 
                                class="w-full py-3 bg-gradient-to-r from-purple-600 to-pink-600 rounded-xl text-white font-bold hover:opacity-90 transition flex items-center justify-center gap-2">
                                <i class="fas fa-rocket"></i> Generate All
                            </button>
                        </div>
                    </div>
                    
                    <div id="bulkProgress" class="hidden">
                        <div class="bg-white/5 rounded-xl p-4">
                            <div class="flex items-center justify-between mb-2">
                                <span class="text-gray-300">Generating content...</span>
                                <span id="bulkProgressCount" class="text-purple-400 font-bold">0 / 0</span>
                            </div>
                            <div class="w-full bg-white/10 rounded-full h-2">
                                <div id="bulkProgressBar" class="bg-gradient-to-r from-purple-500 to-pink-500 h-2 rounded-full transition-all" style="width: 0%"></div>
                            </div>
                            <div id="bulkProgressLog" class="mt-3 text-sm text-gray-400 max-h-32 overflow-y-auto"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Blogs Panel -->
            <div id="panel-blogs" class="fade-in">
                <!-- Bulk Action Bar -->
                <div id="bulkActionBar" class="hidden mb-4 p-3 bg-purple-500/20 border border-purple-500/50 rounded-xl flex items-center justify-between">
                    <div class="flex items-center gap-3">
                        <input type="checkbox" id="selectAllBlogs" onchange="toggleSelectAllBlogs()" class="w-5 h-5 rounded">
                        <span class="text-white font-medium"><span id="selectedCount">0</span> selected</span>
                    </div>
                    <div class="flex items-center gap-2">
                        <button onclick="bulkApproveBlogs()" class="px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg text-sm font-medium transition">
                            <i class="fas fa-check mr-1"></i>Approve
                        </button>
                        <button onclick="bulkDeleteBlogs()" class="px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded-lg text-sm font-medium transition">
                            <i class="fas fa-trash mr-1"></i>Delete
                        </button>
                        <button onclick="cancelBulkSelect()" class="px-4 py-2 bg-gray-600 hover:bg-gray-500 text-white rounded-lg text-sm font-medium transition">
                            <i class="fas fa-times mr-1"></i>Cancel
                        </button>
                    </div>
                </div>
                
                <!-- Toggle Bulk Select Button -->
                <div class="flex justify-end mb-4">
                    <button onclick="toggleBulkSelect()" id="bulkSelectBtn" class="px-4 py-2 bg-white/10 hover:bg-white/20 text-gray-300 rounded-lg text-sm transition">
                        <i class="fas fa-check-square mr-1"></i>Bulk Select
                    </button>
                </div>
                
                <div id="blogsList" class="space-y-4">
                    <div class="text-center py-12">
                        <div class="spinner mx-auto mb-4"></div>
                        <p class="text-gray-400">Loading blog posts...</p>
                    </div>
                </div>
            </div>

            <!-- Social Panel -->
            <div id="panel-social" class="hidden fade-in">
                <div class="grid md:grid-cols-3 gap-4 mb-6">
                    <button onclick="filterSocial('all')" id="social-all" class="glass rounded-xl p-4 text-left hover:bg-white/5 transition border-2 border-purple-500">
                        <p class="text-white font-semibold">All Platforms</p>
                        <p id="countAll" class="text-2xl font-bold gradient-text">0</p>
                    </button>
                    <button onclick="filterSocial('gbp')" id="social-gbp" class="glass rounded-xl p-4 text-left hover:bg-white/5 transition">
                        <div class="flex items-center gap-2">
                            <i class="fab fa-google text-blue-400"></i>
                            <p class="text-white font-semibold">Google Business</p>
                        </div>
                        <p id="countGbp" class="text-2xl font-bold text-blue-400">0</p>
                    </button>
                    <button onclick="filterSocial('facebook')" id="social-facebook" class="glass rounded-xl p-4 text-left hover:bg-white/5 transition">
                        <div class="flex items-center gap-2">
                            <i class="fab fa-facebook text-blue-500"></i>
                            <p class="text-white font-semibold">Facebook</p>
                        </div>
                        <p id="countFacebook" class="text-2xl font-bold text-blue-500">0</p>
                    </button>
                </div>
                <div id="socialList" class="grid md:grid-cols-2 gap-4">
                    <div class="text-center py-12 col-span-2">
                        <div class="spinner mx-auto mb-4"></div>
                        <p class="text-gray-400">Loading social posts...</p>
                    </div>
                </div>
            </div>

            <!-- SEO Panel -->
            <div id="panel-seo" class="hidden fade-in">
                <div class="grid md:grid-cols-2 gap-6 mb-6">
                    <div class="glass rounded-xl p-6">
                        <h3 class="text-lg font-semibold text-white mb-4"><i class="fas fa-bullseye mr-2 text-purple-400"></i>Target Keywords</h3>
                        <div id="keywordsList" class="space-y-2"></div>
                    </div>
                    <div class="glass rounded-xl p-6">
                        <h3 class="text-lg font-semibold text-white mb-4"><i class="fas fa-crosshairs mr-2 text-orange-400"></i>Competitors</h3>
                        <div id="competitorsList" class="space-y-2"></div>
                    </div>
                    <div class="glass rounded-xl p-6">
                        <h3 class="text-lg font-semibold text-white mb-4"><i class="fas fa-link mr-2 text-green-400"></i>Service Pages</h3>
                        <div id="servicePagesList" class="space-y-2"></div>
                    </div>
                    <div class="glass rounded-xl p-6">
                        <h3 class="text-lg font-semibold text-white mb-4"><i class="fas fa-star mr-2 text-yellow-400"></i>Unique Selling Points</h3>
                        <div id="uspsList" class="space-y-2"></div>
                    </div>
                </div>
                
                <!-- Competitor Insights Section -->
                <div class="glass rounded-xl p-6">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-lg font-semibold text-white"><i class="fas fa-chart-bar mr-2 text-cyan-400"></i>Competitor Insights</h3>
                        <a href="/elite" class="text-sm text-cyan-400 hover:text-cyan-300">
                            <i class="fas fa-external-link-alt mr-1"></i>Full Analysis
                        </a>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm">
                            <thead>
                                <tr class="text-gray-400 border-b border-white/10">
                                    <th class="text-left py-3">Keyword</th>
                                    <th class="text-center py-3">Your Rank</th>
                                    <th class="text-center py-3">Top Competitor</th>
                                    <th class="text-center py-3">Gap</th>
                                </tr>
                            </thead>
                            <tbody id="competitorInsightsTable">
                                <tr>
                                    <td colspan="4" class="text-center py-6 text-gray-500">
                                        <i class="fas fa-chart-line text-3xl mb-2 block"></i>
                                        Loading competitor insights...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <!-- Calendar Panel -->
            <div id="panel-calendar" class="hidden fade-in">
                <div class="glass rounded-2xl p-6 mb-6">
                    <div class="flex items-center justify-between mb-6">
                        <div class="flex items-center gap-3">
                            <button onclick="changeMonth(-1)" class="p-2 glass rounded-lg hover:bg-white/10 transition">
                                <i class="fas fa-chevron-left text-white"></i>
                            </button>
                            <h2 id="calendarMonth" class="text-xl font-bold text-white">December 2024</h2>
                            <button onclick="changeMonth(1)" class="p-2 glass rounded-lg hover:bg-white/10 transition">
                                <i class="fas fa-chevron-right text-white"></i>
                            </button>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="autoSchedule()" class="px-4 py-2 bg-gradient-to-r from-purple-600 to-pink-600 rounded-lg text-white text-sm font-medium hover:opacity-90 transition">
                                <i class="fas fa-magic mr-2"></i>Auto-Schedule
                            </button>
                        </div>
                    </div>
                    
                    <!-- Calendar Grid -->
                    <div class="grid grid-cols-7 gap-2 mb-4">
                        <div class="text-center text-gray-400 text-sm font-medium py-2">Sun</div>
                        <div class="text-center text-gray-400 text-sm font-medium py-2">Mon</div>
                        <div class="text-center text-gray-400 text-sm font-medium py-2">Tue</div>
                        <div class="text-center text-gray-400 text-sm font-medium py-2">Wed</div>
                        <div class="text-center text-gray-400 text-sm font-medium py-2">Thu</div>
                        <div class="text-center text-gray-400 text-sm font-medium py-2">Fri</div>
                        <div class="text-center text-gray-400 text-sm font-medium py-2">Sat</div>
                    </div>
                    <div id="calendarGrid" class="grid grid-cols-7 gap-2">
                        <!-- Calendar days populated by JS -->
                    </div>
                    
                    <!-- Legend -->
                    <div class="flex items-center gap-6 mt-6 pt-4 border-t border-white/10">
                        <div class="flex items-center gap-2">
                            <div class="w-3 h-3 rounded-full bg-green-500"></div>
                            <span class="text-sm text-gray-400">Blog Post</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <div class="w-3 h-3 rounded-full bg-blue-500"></div>
                            <span class="text-sm text-gray-400">GBP Post</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <div class="w-3 h-3 rounded-full bg-indigo-500"></div>
                            <span class="text-sm text-gray-400">Facebook</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <div class="w-3 h-3 rounded-full bg-pink-500"></div>
                            <span class="text-sm text-gray-400">Instagram</span>
                        </div>
                    </div>
                </div>
                
                <!-- Scheduled Content List -->
                <div class="glass rounded-2xl p-6">
                    <h3 class="text-lg font-semibold text-white mb-4"><i class="fas fa-list mr-2 text-purple-400"></i>Scheduled Content</h3>
                    <div id="scheduledList" class="space-y-3">
                        <p class="text-gray-500 text-sm">No content scheduled yet. Click "Auto-Schedule" to create a posting schedule.</p>
                    </div>
                </div>
            </div>
            
            <!-- Reports Panel -->
            <div id="panel-reports" class="hidden fade-in">
                <div class="grid md:grid-cols-2 gap-6">
                    <!-- Monthly Report -->
                    <div class="glass rounded-2xl p-6">
                        <div class="flex items-center gap-3 mb-6">
                            <div class="w-12 h-12 rounded-xl bg-gradient-to-br from-red-500 to-pink-600 flex items-center justify-center">
                                <i class="fas fa-file-pdf text-white text-xl"></i>
                            </div>
                            <div>
                                <h3 class="text-lg font-bold text-white">Monthly Report</h3>
                                <p class="text-sm text-gray-400">Content performance summary</p>
                            </div>
                        </div>
                        <div class="space-y-3 mb-6">
                            <div class="flex items-center justify-between p-3 glass rounded-lg">
                                <span class="text-gray-400">Blog Posts Created</span>
                                <span id="reportBlogs" class="text-white font-bold">0</span>
                            </div>
                            <div class="flex items-center justify-between p-3 glass rounded-lg">
                                <span class="text-gray-400">Social Posts Created</span>
                                <span id="reportSocial" class="text-white font-bold">0</span>
                            </div>
                            <div class="flex items-center justify-between p-3 glass rounded-lg">
                                <span class="text-gray-400">Total Word Count</span>
                                <span id="reportWords" class="text-white font-bold">0</span>
                            </div>
                            <div class="flex items-center justify-between p-3 glass rounded-lg">
                                <span class="text-gray-400">Avg SEO Score</span>
                                <span id="reportSeoScore" class="text-white font-bold">--</span>
                            </div>
                        </div>
                        <button onclick="generateMonthlyReport()" class="w-full py-3 bg-gradient-to-r from-red-500 to-pink-600 rounded-xl text-white font-semibold hover:opacity-90 transition">
                            <i class="fas fa-download mr-2"></i>Download PDF Report
                        </button>
                    </div>
                    
                    <!-- Content Inventory -->
                    <div class="glass rounded-2xl p-6">
                        <div class="flex items-center gap-3 mb-6">
                            <div class="w-12 h-12 rounded-xl bg-gradient-to-br from-blue-500 to-cyan-600 flex items-center justify-center">
                                <i class="fas fa-list-alt text-white text-xl"></i>
                            </div>
                            <div>
                                <h3 class="text-lg font-bold text-white">Content Inventory</h3>
                                <p class="text-sm text-gray-400">Export all content data</p>
                            </div>
                        </div>
                        <div class="space-y-3 mb-6">
                            <label class="flex items-center gap-3 p-3 glass rounded-lg cursor-pointer">
                                <input type="checkbox" id="exportBlogs" checked class="w-5 h-5 rounded">
                                <span class="text-white">Include Blog Posts</span>
                            </label>
                            <label class="flex items-center gap-3 p-3 glass rounded-lg cursor-pointer">
                                <input type="checkbox" id="exportSocial" checked class="w-5 h-5 rounded">
                                <span class="text-white">Include Social Posts</span>
                            </label>
                            <label class="flex items-center gap-3 p-3 glass rounded-lg cursor-pointer">
                                <input type="checkbox" id="exportKeywords" checked class="w-5 h-5 rounded">
                                <span class="text-white">Include Keywords</span>
                            </label>
                        </div>
                        <div class="grid grid-cols-2 gap-3">
                            <button onclick="exportInventoryCSV()" class="py-3 glass rounded-xl text-white font-semibold hover:bg-white/10 transition">
                                <i class="fas fa-file-csv mr-2"></i>CSV
                            </button>
                            <button onclick="exportInventoryHTML()" class="py-3 glass rounded-xl text-white font-semibold hover:bg-white/10 transition">
                                <i class="fas fa-file-code mr-2"></i>HTML
                            </button>
                        </div>
                    </div>
                    
                    <!-- Client Summary Card -->
                    <div class="glass rounded-2xl p-6 md:col-span-2">
                        <div class="flex items-center gap-3 mb-6">
                            <div class="w-12 h-12 rounded-xl bg-gradient-to-br from-purple-500 to-violet-600 flex items-center justify-center">
                                <i class="fas fa-chart-pie text-white text-xl"></i>
                            </div>
                            <div>
                                <h3 class="text-lg font-bold text-white">Client Summary</h3>
                                <p class="text-sm text-gray-400">One-page overview for client meetings</p>
                            </div>
                        </div>
                        <p class="text-gray-400 mb-4">Generate a professional one-page summary showing content created, keywords targeted, and next steps. Perfect for client review meetings.</p>
                        <button onclick="generateClientSummary()" class="px-6 py-3 bg-gradient-to-r from-purple-600 to-pink-600 rounded-xl text-white font-semibold hover:opacity-90 transition">
                            <i class="fas fa-file-alt mr-2"></i>Generate Client Summary
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Rankings Panel -->
            <div id="panel-rankings" class="hidden fade-in">
                <div class="grid md:grid-cols-4 gap-6 mb-8">
                    <!-- Average Position -->
                    <div class="glass rounded-2xl p-6">
                        <div class="flex items-center gap-3 mb-4">
                            <div class="w-10 h-10 rounded-xl bg-gradient-to-br from-amber-500 to-orange-600 flex items-center justify-center">
                                <i class="fas fa-trophy text-white"></i>
                            </div>
                            <span class="text-gray-400 text-sm">Avg Position</span>
                        </div>
                        <div class="text-3xl font-bold text-white" id="rankAvgPosition">#--</div>
                        <div class="text-sm text-gray-500 mt-1" id="rankPositionChange">-- vs last check</div>
                    </div>
                    
                    <!-- Top 3 Keywords -->
                    <div class="glass rounded-2xl p-6">
                        <div class="flex items-center gap-3 mb-4">
                            <div class="w-10 h-10 rounded-xl bg-gradient-to-br from-green-500 to-emerald-600 flex items-center justify-center">
                                <i class="fas fa-medal text-white"></i>
                            </div>
                            <span class="text-gray-400 text-sm">Top 3</span>
                        </div>
                        <div class="text-3xl font-bold text-green-400" id="rankTop3">0</div>
                        <div class="text-sm text-gray-500 mt-1">keywords in top 3</div>
                    </div>
                    
                    <!-- Top 10 Keywords -->
                    <div class="glass rounded-2xl p-6">
                        <div class="flex items-center gap-3 mb-4">
                            <div class="w-10 h-10 rounded-xl bg-gradient-to-br from-blue-500 to-cyan-600 flex items-center justify-center">
                                <i class="fas fa-chart-line text-white"></i>
                            </div>
                            <span class="text-gray-400 text-sm">Top 10</span>
                        </div>
                        <div class="text-3xl font-bold text-blue-400" id="rankTop10">0</div>
                        <div class="text-sm text-gray-500 mt-1">keywords in top 10</div>
                    </div>
                    
                    <!-- Traffic Value -->
                    <div class="glass rounded-2xl p-6">
                        <div class="flex items-center gap-3 mb-4">
                            <div class="w-10 h-10 rounded-xl bg-gradient-to-br from-purple-500 to-pink-600 flex items-center justify-center">
                                <i class="fas fa-dollar-sign text-white"></i>
                            </div>
                            <span class="text-gray-400 text-sm">Traffic Value</span>
                        </div>
                        <div class="text-3xl font-bold text-purple-400" id="rankTrafficValue">$0</div>
                        <div class="text-sm text-gray-500 mt-1">monthly SEO value</div>
                    </div>
                </div>
                
                <div class="grid lg:grid-cols-3 gap-6">
                    <!-- Keywords Table -->
                    <div class="lg:col-span-2 glass rounded-2xl p-6">
                        <div class="flex items-center justify-between mb-6">
                            <h3 class="text-lg font-bold text-white">Keyword Rankings</h3>
                            <button onclick="refreshRankings()" class="px-4 py-2 bg-purple-600 hover:bg-purple-700 text-white text-sm font-medium rounded-lg transition" id="refreshRankBtn">
                                <i class="fas fa-sync-alt mr-2"></i>Check Rankings
                            </button>
                        </div>
                        
                        <div class="overflow-x-auto">
                            <table class="w-full">
                                <thead>
                                    <tr class="text-left text-sm text-gray-400 border-b border-white/10">
                                        <th class="pb-3">Keyword</th>
                                        <th class="pb-3 text-center">Position</th>
                                        <th class="pb-3 text-center">Change</th>
                                        <th class="pb-3 text-right">Volume</th>
                                    </tr>
                                </thead>
                                <tbody id="rankingsTable">
                                    <tr>
                                        <td colspan="4" class="py-8 text-center text-gray-500">
                                            <i class="fas fa-search text-2xl mb-2"></i>
                                            <p>Click "Check Rankings" to scan Google</p>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <!-- Position History Chart -->
                    <div class="glass rounded-2xl p-6">
                        <h3 class="text-lg font-bold text-white mb-4">Position History</h3>
                        <div class="h-64">
                            <canvas id="rankHistoryChart"></canvas>
                        </div>
                        <div class="mt-4 space-y-2" id="rankHistoryList">
                            <p class="text-gray-500 text-sm text-center">Historical data will appear after multiple checks</p>
                        </div>
                    </div>
                </div>
                
                <!-- Movement Analysis -->
                <div class="grid md:grid-cols-2 gap-6 mt-6">
                    <!-- Improved -->
                    <div class="glass rounded-2xl p-6">
                        <h3 class="text-lg font-bold text-green-400 mb-4">
                            <i class="fas fa-arrow-up mr-2"></i>Improved Rankings
                        </h3>
                        <div id="improvedKeywords" class="space-y-2">
                            <p class="text-gray-500 text-sm">No improvements detected yet</p>
                        </div>
                    </div>
                    
                    <!-- Declined -->
                    <div class="glass rounded-2xl p-6">
                        <h3 class="text-lg font-bold text-red-400 mb-4">
                            <i class="fas fa-arrow-down mr-2"></i>Declined Rankings
                        </h3>
                        <div id="declinedKeywords" class="space-y-2">
                            <p class="text-gray-500 text-sm">No declines detected</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Competitors Panel -->
            <div id="panel-competitors" class="hidden fade-in">
                <!-- Header -->
                <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 mb-6">
                    <div>
                        <h2 class="text-2xl font-bold text-white">Competitor Intelligence</h2>
                        <p class="text-gray-400">Track and outrank your competition</p>
                    </div>
                    <button onclick="refreshCompetitorDashboard()" class="px-4 py-2 bg-gradient-to-r from-purple-600 to-pink-600 text-white rounded-xl font-medium hover:opacity-90 transition flex items-center gap-2">
                        <i class="fas fa-sync-alt"></i>
                        Refresh Data
                    </button>
                </div>

                <!-- Stats Cards -->
                <div class="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
                    <div class="glass rounded-2xl p-4 text-center">
                        <div class="text-3xl font-bold text-purple-400" id="compCount">0</div>
                        <div class="text-sm text-gray-400">Competitors Tracked</div>
                    </div>
                    <div class="glass rounded-2xl p-4 text-center">
                        <div class="text-3xl font-bold text-green-400" id="compWinRate">0%</div>
                        <div class="text-sm text-gray-400">Win Rate</div>
                    </div>
                    <div class="glass rounded-2xl p-4 text-center">
                        <div class="text-3xl font-bold text-blue-400" id="compGaps">0</div>
                        <div class="text-sm text-gray-400">Content Gaps</div>
                    </div>
                    <div class="glass rounded-2xl p-4 text-center">
                        <div class="text-3xl font-bold text-amber-400" id="compKeywords">0</div>
                        <div class="text-sm text-gray-400">Keywords Tracked</div>
                    </div>
                </div>

                <!-- Main Content Grid -->
                <div class="grid lg:grid-cols-2 gap-6">
                    <!-- Competitor Cards -->
                    <div class="glass rounded-2xl p-6">
                        <h3 class="text-lg font-bold text-white mb-4">
                            <i class="fas fa-building mr-2 text-purple-400"></i>Your Competitors
                        </h3>
                        <div id="competitorCards" class="space-y-3">
                            <p class="text-gray-500 text-sm">No competitors added yet. Add competitors in the intake wizard.</p>
                        </div>
                    </div>

                    <!-- Ranking Battles -->
                    <div class="glass rounded-2xl p-6">
                        <h3 class="text-lg font-bold text-white mb-4">
                            <i class="fas fa-swords mr-2 text-amber-400"></i>Ranking Battles
                        </h3>
                        <div id="rankingBattles" class="space-y-3 max-h-80 overflow-y-auto">
                            <p class="text-gray-500 text-sm">Check rankings to see battles</p>
                        </div>
                    </div>
                </div>

                <!-- Content Gap Analysis -->
                <div class="glass rounded-2xl p-6 mt-6">
                    <h3 class="text-lg font-bold text-white mb-4">
                        <i class="fas fa-lightbulb mr-2 text-yellow-400"></i>Content Gap Opportunities
                    </h3>
                    <p class="text-gray-400 text-sm mb-4">Topics your competitors cover that you don't. Click to generate content.</p>
                    <div id="contentGaps" class="grid md:grid-cols-2 lg:grid-cols-3 gap-3">
                        <p class="text-gray-500 text-sm col-span-full">Analyzing competitor content...</p>
                    </div>
                </div>

                <!-- Social Connections -->
                <div class="glass rounded-2xl p-6 mt-6">
                    <h3 class="text-lg font-bold text-white mb-4">
                        <i class="fas fa-share-nodes mr-2 text-blue-400"></i>Social Media Connections
                    </h3>
                    <p class="text-gray-400 text-sm mb-4">Connect your social accounts for automated publishing</p>
                    <div id="socialConnections" class="grid md:grid-cols-2 lg:grid-cols-4 gap-4">
                        <!-- GBP -->
                        <div class="bg-white/5 rounded-xl p-4 border border-white/10" data-platform="gbp">
                            <div class="flex items-center gap-3 mb-3">
                                <div class="w-10 h-10 rounded-lg flex items-center justify-center" style="background: #4285F4;">
                                    <i class="fab fa-google text-white"></i>
                                </div>
                                <div>
                                    <div class="font-medium text-white text-sm">Google Business</div>
                                    <div class="text-xs text-gray-500" id="gbp-status">Not connected</div>
                                </div>
                            </div>
                            <button onclick="connectSocial('gbp')" class="w-full py-2 px-3 bg-white/10 hover:bg-white/20 rounded-lg text-sm text-white transition" id="gbp-btn">
                                Connect
                            </button>
                        </div>
                        
                        <!-- Facebook -->
                        <div class="bg-white/5 rounded-xl p-4 border border-white/10" data-platform="facebook">
                            <div class="flex items-center gap-3 mb-3">
                                <div class="w-10 h-10 rounded-lg flex items-center justify-center" style="background: #1877F2;">
                                    <i class="fab fa-facebook text-white"></i>
                                </div>
                                <div>
                                    <div class="font-medium text-white text-sm">Facebook</div>
                                    <div class="text-xs text-gray-500" id="facebook-status">Not connected</div>
                                </div>
                            </div>
                            <button onclick="connectSocial('facebook')" class="w-full py-2 px-3 bg-white/10 hover:bg-white/20 rounded-lg text-sm text-white transition" id="facebook-btn">
                                Connect
                            </button>
                        </div>
                        
                        <!-- Instagram -->
                        <div class="bg-white/5 rounded-xl p-4 border border-white/10" data-platform="instagram">
                            <div class="flex items-center gap-3 mb-3">
                                <div class="w-10 h-10 rounded-lg flex items-center justify-center" style="background: linear-gradient(45deg, #f09433, #e6683c, #dc2743, #cc2366, #bc1888);">
                                    <i class="fab fa-instagram text-white"></i>
                                </div>
                                <div>
                                    <div class="font-medium text-white text-sm">Instagram</div>
                                    <div class="text-xs text-gray-500" id="instagram-status">Not connected</div>
                                </div>
                            </div>
                            <button onclick="connectSocial('instagram')" class="w-full py-2 px-3 bg-white/10 hover:bg-white/20 rounded-lg text-sm text-white transition" id="instagram-btn">
                                Connect
                            </button>
                        </div>
                        
                        <!-- LinkedIn -->
                        <div class="bg-white/5 rounded-xl p-4 border border-white/10" data-platform="linkedin">
                            <div class="flex items-center gap-3 mb-3">
                                <div class="w-10 h-10 rounded-lg flex items-center justify-center" style="background: #0A66C2;">
                                    <i class="fab fa-linkedin text-white"></i>
                                </div>
                                <div>
                                    <div class="font-medium text-white text-sm">LinkedIn</div>
                                    <div class="text-xs text-gray-500" id="linkedin-status">Not connected</div>
                                </div>
                            </div>
                            <button onclick="connectSocial('linkedin')" class="w-full py-2 px-3 bg-white/10 hover:bg-white/20 rounded-lg text-sm text-white transition" id="linkedin-btn">
                                Connect
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Settings Panel -->
            <div id="panel-settings" class="hidden fade-in">
                <div class="grid lg:grid-cols-3 gap-6">
                    <!-- Notification Preferences -->
                    <div class="lg:col-span-2 space-y-6">
                        <div class="glass rounded-2xl p-6">
                            <div class="flex items-center justify-between mb-6">
                                <div class="flex items-center gap-3">
                                    <div class="w-12 h-12 rounded-xl bg-gradient-to-br from-purple-500 to-pink-600 flex items-center justify-center">
                                        <i class="fas fa-bell text-white text-xl"></i>
                                    </div>
                                    <div>
                                        <h3 class="text-lg font-bold text-white">Email Notifications</h3>
                                        <p class="text-sm text-gray-400">Choose what emails you receive</p>
                                    </div>
                                </div>
                                <button onclick="saveNotificationPrefs()" class="px-4 py-2 bg-purple-600 hover:bg-purple-700 text-white rounded-lg text-sm font-medium transition">
                                    Save Changes
                                </button>
                            </div>
                            
                            <!-- Master Toggle -->
                            <div class="flex items-center justify-between p-4 bg-white/5 rounded-xl mb-6">
                                <div>
                                    <div class="font-medium text-white">Email Notifications</div>
                                    <div class="text-sm text-gray-400">Master toggle for all email notifications</div>
                                </div>
                                <label class="relative inline-flex items-center cursor-pointer">
                                    <input type="checkbox" id="notifEmailEnabled" class="sr-only peer" checked>
                                    <div class="w-11 h-6 bg-gray-600 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-purple-600"></div>
                                </label>
                            </div>
                            
                            <!-- Content Notifications -->
                            <div class="mb-6">
                                <h4 class="text-white font-medium mb-3 flex items-center gap-2">
                                    <i class="fas fa-file-alt text-blue-400"></i> Content Notifications
                                </h4>
                                <div class="space-y-3">
                                    <label class="flex items-center justify-between p-3 bg-white/5 rounded-lg cursor-pointer hover:bg-white/10 transition">
                                        <span class="text-gray-300 text-sm">Content scheduled for publishing</span>
                                        <input type="checkbox" id="notifContentScheduled" class="w-4 h-4 text-purple-600 rounded" checked>
                                    </label>
                                    <label class="flex items-center justify-between p-3 bg-white/5 rounded-lg cursor-pointer hover:bg-white/10 transition">
                                        <span class="text-gray-300 text-sm">Content due today (morning reminder)</span>
                                        <input type="checkbox" id="notifContentDueToday" class="w-4 h-4 text-purple-600 rounded" checked>
                                    </label>
                                    <label class="flex items-center justify-between p-3 bg-white/5 rounded-lg cursor-pointer hover:bg-white/10 transition">
                                        <span class="text-gray-300 text-sm">Content published successfully</span>
                                        <input type="checkbox" id="notifContentPublished" class="w-4 h-4 text-purple-600 rounded" checked>
                                    </label>
                                    <label class="flex items-center justify-between p-3 bg-white/5 rounded-lg cursor-pointer hover:bg-white/10 transition">
                                        <span class="text-gray-300 text-sm">Content needs approval</span>
                                        <input type="checkbox" id="notifApprovalNeeded" class="w-4 h-4 text-purple-600 rounded" checked>
                                    </label>
                                    <label class="flex items-center justify-between p-3 bg-white/5 rounded-lg cursor-pointer hover:bg-white/10 transition">
                                        <span class="text-gray-300 text-sm">Client feedback received</span>
                                        <input type="checkbox" id="notifContentFeedback" class="w-4 h-4 text-purple-600 rounded" checked>
                                    </label>
                                </div>
                            </div>
                            
                            <!-- Competitor & Ranking Notifications -->
                            <div class="mb-6">
                                <h4 class="text-white font-medium mb-3 flex items-center gap-2">
                                    <i class="fas fa-chart-line text-green-400"></i> Competitor & Ranking Alerts
                                </h4>
                                <div class="space-y-3">
                                    <label class="flex items-center justify-between p-3 bg-white/5 rounded-lg cursor-pointer hover:bg-white/10 transition">
                                        <span class="text-gray-300 text-sm">Competitor publishes new content</span>
                                        <input type="checkbox" id="notifCompetitorContent" class="w-4 h-4 text-purple-600 rounded" checked>
                                    </label>
                                    <label class="flex items-center justify-between p-3 bg-white/5 rounded-lg cursor-pointer hover:bg-white/10 transition">
                                        <span class="text-gray-300 text-sm">Ranking improved</span>
                                        <input type="checkbox" id="notifRankingImproved" class="w-4 h-4 text-purple-600 rounded" checked>
                                    </label>
                                    <label class="flex items-center justify-between p-3 bg-white/5 rounded-lg cursor-pointer hover:bg-white/10 transition">
                                        <span class="text-gray-300 text-sm">Ranking dropped</span>
                                        <input type="checkbox" id="notifRankingDropped" class="w-4 h-4 text-purple-600 rounded" checked>
                                    </label>
                                </div>
                            </div>
                            
                            <!-- Publishing Notifications -->
                            <div class="mb-6">
                                <h4 class="text-white font-medium mb-3 flex items-center gap-2">
                                    <i class="fas fa-globe text-purple-400"></i> Publishing Notifications
                                </h4>
                                <div class="space-y-3">
                                    <label class="flex items-center justify-between p-3 bg-white/5 rounded-lg cursor-pointer hover:bg-white/10 transition">
                                        <span class="text-gray-300 text-sm">WordPress publishing success</span>
                                        <input type="checkbox" id="notifWpPublished" class="w-4 h-4 text-purple-600 rounded" checked>
                                    </label>
                                    <label class="flex items-center justify-between p-3 bg-white/5 rounded-lg cursor-pointer hover:bg-white/10 transition">
                                        <span class="text-gray-300 text-sm">WordPress publishing failed</span>
                                        <input type="checkbox" id="notifWpFailed" class="w-4 h-4 text-purple-600 rounded" checked>
                                    </label>
                                    <label class="flex items-center justify-between p-3 bg-white/5 rounded-lg cursor-pointer hover:bg-white/10 transition">
                                        <span class="text-gray-300 text-sm">Social media publishing success</span>
                                        <input type="checkbox" id="notifSocialPublished" class="w-4 h-4 text-purple-600 rounded">
                                    </label>
                                    <label class="flex items-center justify-between p-3 bg-white/5 rounded-lg cursor-pointer hover:bg-white/10 transition">
                                        <span class="text-gray-300 text-sm">Social media publishing failed</span>
                                        <input type="checkbox" id="notifSocialFailed" class="w-4 h-4 text-purple-600 rounded" checked>
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Delivery Preferences -->
                    <div class="space-y-6">
                        <div class="glass rounded-2xl p-6">
                            <h3 class="text-lg font-bold text-white mb-4">
                                <i class="fas fa-paper-plane mr-2 text-blue-400"></i>Delivery Settings
                            </h3>
                            
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-300 mb-2">Delivery Frequency</label>
                                    <select id="notifDigestFreq" class="w-full px-4 py-3 bg-white/5 border border-white/10 rounded-xl text-white focus:outline-none focus:border-purple-500">
                                        <option value="instant">Instant (send immediately)</option>
                                        <option value="daily">Daily Digest</option>
                                        <option value="weekly">Weekly Digest</option>
                                    </select>
                                </div>
                                
                                <div id="digestTimeWrapper" class="hidden">
                                    <label class="block text-sm font-medium text-gray-300 mb-2">Digest Time</label>
                                    <input type="time" id="notifDigestTime" value="08:00" 
                                        class="w-full px-4 py-3 bg-white/5 border border-white/10 rounded-xl text-white focus:outline-none focus:border-purple-500">
                                </div>
                                
                                <div id="digestDayWrapper" class="hidden">
                                    <label class="block text-sm font-medium text-gray-300 mb-2">Digest Day (Weekly)</label>
                                    <select id="notifDigestDay" class="w-full px-4 py-3 bg-white/5 border border-white/10 rounded-xl text-white focus:outline-none focus:border-purple-500">
                                        <option value="0">Monday</option>
                                        <option value="1">Tuesday</option>
                                        <option value="2">Wednesday</option>
                                        <option value="3">Thursday</option>
                                        <option value="4">Friday</option>
                                        <option value="5">Saturday</option>
                                        <option value="6">Sunday</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Quiet Hours -->
                        <div class="glass rounded-2xl p-6">
                            <h3 class="text-lg font-bold text-white mb-4">
                                <i class="fas fa-moon mr-2 text-indigo-400"></i>Quiet Hours
                            </h3>
                            <p class="text-sm text-gray-400 mb-4">Pause notifications during these hours</p>
                            
                            <label class="flex items-center justify-between p-3 bg-white/5 rounded-lg cursor-pointer hover:bg-white/10 transition mb-4">
                                <span class="text-gray-300 text-sm">Enable Quiet Hours</span>
                                <input type="checkbox" id="notifQuietEnabled" class="w-4 h-4 text-purple-600 rounded">
                            </label>
                            
                            <div id="quietHoursConfig" class="space-y-3 opacity-50">
                                <div>
                                    <label class="block text-xs text-gray-400 mb-1">Start Time</label>
                                    <input type="time" id="notifQuietStart" value="22:00" 
                                        class="w-full px-3 py-2 bg-white/5 border border-white/10 rounded-lg text-white text-sm" disabled>
                                </div>
                                <div>
                                    <label class="block text-xs text-gray-400 mb-1">End Time</label>
                                    <input type="time" id="notifQuietEnd" value="07:00" 
                                        class="w-full px-3 py-2 bg-white/5 border border-white/10 rounded-lg text-white text-sm" disabled>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Test Notification -->
                        <div class="glass rounded-2xl p-6">
                            <h3 class="text-lg font-bold text-white mb-4">
                                <i class="fas fa-vial mr-2 text-amber-400"></i>Test Email
                            </h3>
                            <p class="text-sm text-gray-400 mb-4">Send a test notification to verify email delivery</p>
                            <button onclick="sendTestNotification()" id="testNotifBtn" class="w-full py-3 bg-amber-600 hover:bg-amber-700 text-white rounded-xl font-medium transition">
                                Send Test Email
                            </button>
                        </div>
                        
                        <!-- Notification History -->
                        <div class="glass rounded-2xl p-6">
                            <h3 class="text-lg font-bold text-white mb-4">
                                <i class="fas fa-history mr-2 text-gray-400"></i>Recent Notifications
                            </h3>
                            <div id="notificationHistory" class="space-y-2 max-h-60 overflow-y-auto">
                                <p class="text-gray-500 text-sm">Loading...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Chatbot Panel -->
            <div id="panel-chatbot" class="hidden fade-in">
                <div class="grid lg:grid-cols-3 gap-6">
                    <!-- Chatbot Config -->
                    <div class="lg:col-span-2 space-y-6">
                        <!-- Status Card -->
                        <div class="glass rounded-2xl p-6">
                            <div class="flex items-center justify-between mb-6">
                                <div class="flex items-center gap-3">
                                    <div class="w-12 h-12 rounded-xl bg-gradient-to-br from-purple-500 to-pink-600 flex items-center justify-center">
                                        <i class="fas fa-robot text-white text-xl"></i>
                                    </div>
                                    <div>
                                        <h3 class="text-lg font-bold text-white">AI Website Chatbot</h3>
                                        <p class="text-sm text-gray-400">24/7 Lead capture for your website</p>
                                    </div>
                                </div>
                                <label class="relative inline-flex items-center cursor-pointer">
                                    <input type="checkbox" id="chatbotEnabled" class="sr-only peer" onchange="toggleChatbot()">
                                    <div class="w-14 h-7 bg-gray-600 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-6 after:w-6 after:transition-all peer-checked:bg-green-500"></div>
                                </label>
                            </div>
                            
                            <div id="chatbotStats" class="grid grid-cols-3 gap-4 mb-6">
                                <div class="text-center p-3 glass rounded-xl">
                                    <p id="chatbotConversations" class="text-2xl font-bold text-white">0</p>
                                    <p class="text-xs text-gray-400">Conversations</p>
                                </div>
                                <div class="text-center p-3 glass rounded-xl">
                                    <p id="chatbotLeads" class="text-2xl font-bold text-green-400">0</p>
                                    <p class="text-xs text-gray-400">Leads Captured</p>
                                </div>
                                <div class="text-center p-3 glass rounded-xl">
                                    <p id="chatbotRating" class="text-2xl font-bold text-yellow-400">--</p>
                                    <p class="text-xs text-gray-400">Avg Rating</p>
                                </div>
                            </div>
                            
                            <div class="p-4 bg-gradient-to-r from-purple-500/10 to-pink-500/10 border border-purple-500/30 rounded-xl">
                                <p class="text-sm text-gray-300 mb-2"><i class="fas fa-info-circle text-purple-400 mr-2"></i>Your chatbot is trained on:</p>
                                <ul class="text-sm text-gray-400 space-y-1 ml-6">
                                    <li>‚Ä¢ Business name, services, and location</li>
                                    <li>‚Ä¢ Your target keywords and service areas</li>
                                    <li>‚Ä¢ Unique selling points and FAQs</li>
                                </ul>
                            </div>
                        </div>
                        
                        <!-- Appearance Settings -->
                        <div class="glass rounded-2xl p-6">
                            <h3 class="text-lg font-bold text-white mb-4"><i class="fas fa-palette mr-2 text-pink-400"></i>Appearance</h3>
                            <div class="grid sm:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm text-gray-400 mb-2">Bot Name</label>
                                    <input type="text" id="chatbotName" value="Support Assistant" class="w-full px-4 py-2 glass rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-purple-500">
                                </div>
                                <div>
                                    <label class="block text-sm text-gray-400 mb-2">Position</label>
                                    <select id="chatbotPosition" class="w-full px-4 py-2 glass rounded-lg text-white focus:outline-none">
                                        <option value="bottom-right">Bottom Right</option>
                                        <option value="bottom-left">Bottom Left</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm text-gray-400 mb-2">Primary Color</label>
                                    <div class="flex gap-2">
                                        <input type="color" id="chatbotColor" value="#8b5cf6" class="w-12 h-10 rounded cursor-pointer">
                                        <input type="text" id="chatbotColorText" value="#8b5cf6" class="flex-1 px-4 py-2 glass rounded-lg text-white focus:outline-none">
                                    </div>
                                </div>
                                <div>
                                    <label class="block text-sm text-gray-400 mb-2">Secondary Color</label>
                                    <div class="flex gap-2">
                                        <input type="color" id="chatbotColor2" value="#ec4899" class="w-12 h-10 rounded cursor-pointer">
                                        <input type="text" id="chatbotColor2Text" value="#ec4899" class="flex-1 px-4 py-2 glass rounded-lg text-white focus:outline-none">
                                    </div>
                                </div>
                            </div>
                            <div class="mt-4">
                                <label class="block text-sm text-gray-400 mb-2">Welcome Message</label>
                                <textarea id="chatbotWelcome" rows="2" class="w-full px-4 py-2 glass rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-purple-500" placeholder="Hi! How can I help you today?"></textarea>
                            </div>
                        </div>
                        
                        <!-- Lead Capture Settings -->
                        <div class="glass rounded-2xl p-6">
                            <h3 class="text-lg font-bold text-white mb-4"><i class="fas fa-user-plus mr-2 text-green-400"></i>Lead Capture</h3>
                            <div class="space-y-3">
                                <label class="flex items-center justify-between p-3 glass rounded-lg cursor-pointer">
                                    <span class="text-white">Collect Name</span>
                                    <input type="checkbox" id="chatbotCollectName" checked class="w-5 h-5 rounded">
                                </label>
                                <label class="flex items-center justify-between p-3 glass rounded-lg cursor-pointer">
                                    <span class="text-white">Collect Email</span>
                                    <input type="checkbox" id="chatbotCollectEmail" checked class="w-5 h-5 rounded">
                                </label>
                                <label class="flex items-center justify-between p-3 glass rounded-lg cursor-pointer">
                                    <span class="text-white">Collect Phone</span>
                                    <input type="checkbox" id="chatbotCollectPhone" checked class="w-5 h-5 rounded">
                                </label>
                                <div class="pt-3">
                                    <label class="block text-sm text-gray-400 mb-2">Prompt for info after</label>
                                    <select id="chatbotLeadTrigger" class="w-full px-4 py-2 glass rounded-lg text-white focus:outline-none">
                                        <option value="after_1_message">1 message</option>
                                        <option value="after_3_messages" selected>3 messages</option>
                                        <option value="after_5_messages">5 messages</option>
                                        <option value="never">Never (manual only)</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Notifications -->
                        <div class="glass rounded-2xl p-6">
                            <h3 class="text-lg font-bold text-white mb-4"><i class="fas fa-bell mr-2 text-yellow-400"></i>Notifications</h3>
                            <div class="space-y-4">
                                <label class="flex items-center justify-between p-3 glass rounded-lg cursor-pointer">
                                    <span class="text-white">Email notifications for new leads</span>
                                    <input type="checkbox" id="chatbotEmailNotify" checked class="w-5 h-5 rounded">
                                </label>
                                <div>
                                    <label class="block text-sm text-gray-400 mb-2">Notification Email</label>
                                    <input type="email" id="chatbotNotifyEmail" placeholder="your@email.com" class="w-full px-4 py-2 glass rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-purple-500">
                                </div>
                            </div>
                        </div>
                        
                        <!-- Save Button -->
                        <button onclick="saveChatbotConfig()" class="w-full py-4 bg-gradient-to-r from-purple-600 to-pink-600 rounded-xl text-white font-bold text-lg hover:opacity-90 transition">
                            <i class="fas fa-save mr-2"></i>Save Chatbot Settings
                        </button>
                    </div>
                    
                    <!-- Preview & Embed Code -->
                    <div class="space-y-6">
                        <!-- Live Preview -->
                        <div class="glass rounded-2xl p-6">
                            <h3 class="text-lg font-bold text-white mb-4"><i class="fas fa-eye mr-2 text-cyan-400"></i>Preview</h3>
                            <div class="relative bg-gradient-to-br from-gray-800 to-gray-900 rounded-xl p-4 h-[400px] overflow-hidden">
                                <!-- Mini chat preview -->
                                <div id="chatbotPreview" class="absolute bottom-4 right-4 w-[280px]">
                                    <!-- Bubble -->
                                    <div id="previewBubble" class="w-14 h-14 rounded-full flex items-center justify-center shadow-lg cursor-pointer ml-auto" style="background: linear-gradient(135deg, #8b5cf6, #ec4899);">
                                        <svg class="w-7 h-7 text-white" fill="currentColor" viewBox="0 0 24 24">
                                            <path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2z"/>
                                        </svg>
                                    </div>
                                    <!-- Window -->
                                    <div id="previewWindow" class="hidden absolute bottom-16 right-0 w-full bg-white rounded-2xl shadow-2xl overflow-hidden">
                                        <div id="previewHeader" class="p-3 text-white" style="background: linear-gradient(135deg, #8b5cf6, #ec4899);">
                                            <div class="flex items-center gap-2">
                                                <div class="w-8 h-8 bg-white/20 rounded-full flex items-center justify-center">
                                                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2z"/></svg>
                                                </div>
                                                <div>
                                                    <div id="previewName" class="font-semibold text-sm">Support Assistant</div>
                                                    <div class="text-xs opacity-75">Online</div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="p-3 bg-gray-50 h-[120px]">
                                            <div id="previewMessage" class="bg-gray-200 text-gray-800 text-xs p-2 rounded-lg rounded-bl-none max-w-[80%]">
                                                Hi! How can I help you today?
                                            </div>
                                        </div>
                                        <div class="p-2 border-t flex gap-2">
                                            <input type="text" placeholder="Type a message..." class="flex-1 text-xs px-3 py-2 border rounded-full text-gray-600">
                                            <button class="w-8 h-8 rounded-full flex items-center justify-center" style="background: #8b5cf6;">
                                                <svg class="w-4 h-4 text-white" fill="currentColor" viewBox="0 0 24 24"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/></svg>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                <p class="text-gray-500 text-sm text-center pt-2">Click bubble to preview</p>
                            </div>
                        </div>
                        
                        <!-- Embed Code -->
                        <div class="glass rounded-2xl p-6">
                            <h3 class="text-lg font-bold text-white mb-4"><i class="fas fa-code mr-2 text-green-400"></i>Embed Code</h3>
                            <p class="text-sm text-gray-400 mb-4">Add this code to your website before the closing <code class="text-pink-400">&lt;/body&gt;</code> tag:</p>
                            <div class="relative">
                                <pre id="chatbotEmbedCode" class="bg-gray-900 p-4 rounded-xl text-xs text-green-400 overflow-x-auto whitespace-pre-wrap break-all">Loading embed code...</pre>
                                <button onclick="copyEmbedCode()" class="absolute top-2 right-2 px-3 py-1 bg-purple-600 rounded text-white text-xs hover:bg-purple-700 transition">
                                    <i class="fas fa-copy mr-1"></i>Copy
                                </button>
                            </div>
                        </div>
                        
                        <!-- Recent Conversations -->
                        <div class="glass rounded-2xl p-6">
                            <div class="flex items-center justify-between mb-4">
                                <h3 class="text-lg font-bold text-white"><i class="fas fa-comments mr-2 text-blue-400"></i>Recent Chats</h3>
                                <a href="#" onclick="viewAllConversations()" class="text-sm text-purple-400 hover:text-purple-300">View All ‚Üí</a>
                            </div>
                            <div id="recentConversations" class="space-y-3">
                                <p class="text-gray-500 text-sm text-center py-4">No conversations yet</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Blog Preview Modal -->
    <div id="blogModal" class="hidden fixed inset-0 bg-black/90 z-50 overflow-y-auto">
        <div class="max-w-4xl mx-auto py-8 px-4">
            <div class="glass-light rounded-2xl overflow-hidden fade-in">
                <div class="bg-gradient-to-r from-purple-600 to-pink-600 p-6">
                    <div class="flex items-start justify-between">
                        <div class="flex-1">
                            <span id="modalKeyword" class="inline-block px-3 py-1 bg-white/20 rounded-full text-white text-sm mb-2"></span>
                            <h1 id="modalTitle" class="text-2xl md:text-3xl font-bold text-white"></h1>
                            <!-- Edit mode title input -->
                            <input type="text" id="modalTitleEdit" class="hidden w-full text-2xl font-bold bg-white/20 border border-white/30 rounded-lg px-3 py-2 text-white placeholder-white/50 mt-2">
                        </div>
                        <button onclick="closeBlogModal()" class="p-2 hover:bg-white/20 rounded-lg transition ml-4">
                            <i class="fas fa-times text-white text-xl"></i>
                        </button>
                    </div>
                    <div class="flex items-center gap-4 mt-4 text-white/80 text-sm">
                        <span><i class="fas fa-clock mr-1"></i><span id="modalWordCount">0</span> words</span>
                        <span><i class="fas fa-link mr-1"></i><span id="modalLinkCount">0</span> internal links</span>
                        <span id="modalStatus" class="px-2 py-1 bg-white/20 rounded"></span>
                    </div>
                </div>
                <div class="p-6 md:p-8">
                    <!-- SEO Score Card -->
                    <div id="seoScoreCard" class="mb-6 p-4 bg-gradient-to-r from-slate-800 to-slate-900 rounded-xl text-white">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="font-bold text-lg"><i class="fas fa-chart-line mr-2 text-green-400"></i>SEO Score</h3>
                            <div class="flex items-center gap-2">
                                <span id="seoScoreValue" class="text-3xl font-bold text-green-400">--</span>
                                <span class="text-gray-400">/100</span>
                            </div>
                        </div>
                        <div class="w-full bg-gray-700 rounded-full h-2 mb-4">
                            <div id="seoScoreBar" class="bg-gradient-to-r from-green-500 to-emerald-400 h-2 rounded-full transition-all" style="width: 0%"></div>
                        </div>
                        <div class="grid grid-cols-2 md:grid-cols-3 gap-3 text-sm">
                            <div id="seoWordCount" class="flex items-center gap-2 p-2 rounded-lg bg-white/5">
                                <i class="fas fa-check-circle text-green-400"></i>
                                <span>Word Count</span>
                            </div>
                            <div id="seoKeywordDensity" class="flex items-center gap-2 p-2 rounded-lg bg-white/5">
                                <i class="fas fa-check-circle text-green-400"></i>
                                <span>Keyword Density</span>
                            </div>
                            <div id="seoInternalLinks" class="flex items-center gap-2 p-2 rounded-lg bg-white/5">
                                <i class="fas fa-check-circle text-green-400"></i>
                                <span>Internal Links</span>
                            </div>
                            <div id="seoMetaTitle" class="flex items-center gap-2 p-2 rounded-lg bg-white/5">
                                <i class="fas fa-check-circle text-green-400"></i>
                                <span>Meta Title</span>
                            </div>
                            <div id="seoMetaDesc" class="flex items-center gap-2 p-2 rounded-lg bg-white/5">
                                <i class="fas fa-check-circle text-green-400"></i>
                                <span>Meta Description</span>
                            </div>
                            <div id="seoHeadings" class="flex items-center gap-2 p-2 rounded-lg bg-white/5">
                                <i class="fas fa-check-circle text-green-400"></i>
                                <span>Heading Structure</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Meta fields - View mode -->
                    <div id="metaViewMode" class="mb-6 p-4 bg-gray-50 rounded-xl">
                        <p class="text-sm text-gray-500 mb-1">Meta Title</p>
                        <p id="modalMetaTitle" class="font-medium text-gray-800"></p>
                        <p class="text-sm text-gray-500 mt-3 mb-1">Meta Description</p>
                        <p id="modalMetaDesc" class="text-gray-600"></p>
                    </div>
                    
                    <!-- Meta fields - Edit mode -->
                    <div id="metaEditMode" class="hidden mb-6 p-4 bg-gray-50 rounded-xl space-y-4">
                        <div>
                            <label class="text-sm text-gray-500 mb-1 block">Meta Title <span id="metaTitleCount" class="text-xs">(0/60)</span></label>
                            <input type="text" id="modalMetaTitleEdit" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:border-purple-500 focus:ring-2 focus:ring-purple-200" maxlength="70">
                        </div>
                        <div>
                            <label class="text-sm text-gray-500 mb-1 block">Meta Description <span id="metaDescCount" class="text-xs">(0/160)</span></label>
                            <textarea id="modalMetaDescEdit" rows="2" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:border-purple-500 focus:ring-2 focus:ring-purple-200" maxlength="170"></textarea>
                        </div>
                    </div>
                    
                    <!-- Featured Image Section -->
                    <div id="featuredImageSection" class="mb-6 p-4 bg-gradient-to-r from-amber-50 to-orange-50 border border-amber-200 rounded-xl">
                        <div class="flex items-center justify-between mb-3">
                            <h4 class="font-medium text-gray-800 flex items-center gap-2">
                                <i class="fas fa-image text-amber-500"></i>Featured Image
                            </h4>
                            <button onclick="generateBlogImage()" id="btnGenerateBlogImage" class="px-3 py-1.5 bg-amber-500 hover:bg-amber-600 text-white text-sm rounded-lg transition flex items-center gap-2">
                                <i class="fas fa-wand-magic-sparkles"></i> Generate
                            </button>
                        </div>
                        <div id="featuredImagePreview" class="hidden">
                            <img id="modalFeaturedImage" src="" alt="Featured Image" class="w-full h-48 object-cover rounded-lg mb-2">
                            <div class="flex gap-2">
                                <button onclick="removeFeaturedImage()" class="text-xs text-red-600 hover:text-red-700">
                                    <i class="fas fa-trash mr-1"></i>Remove
                                </button>
                            </div>
                        </div>
                        <div id="featuredImageEmpty" class="text-center py-6 text-gray-400">
                            <i class="fas fa-image text-3xl mb-2 opacity-50"></i>
                            <p class="text-sm">No featured image yet</p>
                            <p class="text-xs">Click "Generate" to create one with AI</p>
                        </div>
                        <div id="featuredImageLoading" class="hidden text-center py-6">
                            <div class="spinner w-8 h-8 mx-auto mb-2 border-amber-500"></div>
                            <p class="text-sm text-amber-600">Generating image...</p>
                        </div>
                    </div>
                    
                    <!-- Body - View mode -->
                    <div id="modalBody" class="blog-content"></div>
                    
                    <!-- Body - Edit mode -->
                    <div id="bodyEditMode" class="hidden">
                        <label class="text-sm text-gray-500 mb-2 block">Blog Content (HTML)</label>
                        <textarea id="modalBodyEdit" rows="20" class="w-full px-3 py-2 border border-gray-300 rounded-lg font-mono text-sm focus:border-purple-500 focus:ring-2 focus:ring-purple-200"></textarea>
                        <p class="text-xs text-gray-400 mt-1">Word count: <span id="editWordCount">0</span></p>
                    </div>
                    
                    <div id="modalFaq" class="mt-8 hidden">
                        <h3 class="text-xl font-bold text-gray-800 mb-4"><i class="fas fa-question-circle mr-2 text-purple-500"></i>Frequently Asked Questions</h3>
                        <div id="faqContent" class="space-y-4"></div>
                    </div>
                </div>
                
                <!-- Footer - View mode -->
                <div id="footerViewMode" class="border-t p-4 flex justify-between items-center bg-gray-50 flex-wrap gap-2">
                    <div class="flex gap-2 flex-wrap">
                        <button onclick="copyBlogContent()" class="px-4 py-2 bg-gray-200 hover:bg-gray-300 rounded-lg text-sm font-medium transition">
                            <i class="fas fa-copy mr-1"></i>Copy
                        </button>
                        <button onclick="downloadBlog()" class="px-4 py-2 bg-gray-200 hover:bg-gray-300 rounded-lg text-sm font-medium transition">
                            <i class="fas fa-file-alt mr-1"></i>Markdown
                        </button>
                        <button onclick="downloadBlogHTML()" class="px-4 py-2 bg-blue-100 hover:bg-blue-200 text-blue-700 rounded-lg text-sm font-medium transition">
                            <i class="fas fa-code mr-1"></i>HTML
                        </button>
                        <button onclick="downloadBlogWord()" class="px-4 py-2 bg-indigo-100 hover:bg-indigo-200 text-indigo-700 rounded-lg text-sm font-medium transition">
                            <i class="fas fa-file-word mr-1"></i>Word
                        </button>
                    </div>
                    <div class="flex gap-2 flex-wrap">
                        <button onclick="enterEditMode()" class="px-4 py-2 bg-amber-100 hover:bg-amber-200 text-amber-700 rounded-lg text-sm font-medium transition">
                            <i class="fas fa-edit mr-1"></i>Edit
                        </button>
                        <button onclick="confirmDeleteBlog()" class="px-4 py-2 bg-red-100 hover:bg-red-200 text-red-700 rounded-lg text-sm font-medium transition">
                            <i class="fas fa-trash mr-1"></i>Delete
                        </button>
                        <button onclick="showScheduleModal()" class="px-4 py-2 bg-blue-100 hover:bg-blue-200 text-blue-700 rounded-lg text-sm font-medium transition">
                            <i class="fas fa-calendar mr-1"></i>Schedule
                        </button>
                        <button onclick="publishToWordPress()" class="px-4 py-2 bg-sky-100 hover:bg-sky-200 text-sky-700 rounded-lg text-sm font-medium transition" title="Publish to WordPress">
                            <i class="fab fa-wordpress mr-1"></i>WordPress
                        </button>
                        <button onclick="approveBlog()" class="px-6 py-2 bg-gradient-to-r from-green-500 to-emerald-600 text-white rounded-lg text-sm font-medium hover:opacity-90 transition">
                            <i class="fas fa-check mr-1"></i>Approve
                        </button>
                    </div>
                </div>
                
                <!-- Footer - Edit mode -->
                <div id="footerEditMode" class="hidden border-t p-4 flex justify-between items-center bg-amber-50">
                    <div class="flex items-center gap-2 text-amber-700">
                        <i class="fas fa-edit"></i>
                        <span class="font-medium">Edit Mode</span>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="cancelEditMode()" class="px-4 py-2 bg-gray-200 hover:bg-gray-300 rounded-lg text-sm font-medium transition">
                            <i class="fas fa-times mr-1"></i>Cancel
                        </button>
                        <button onclick="saveBlogEdits()" class="px-6 py-2 bg-gradient-to-r from-green-500 to-emerald-600 text-white rounded-lg text-sm font-medium hover:opacity-90 transition">
                            <i class="fas fa-save mr-1"></i>Save Changes
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Schedule Modal -->
    <div id="scheduleModal" class="hidden fixed inset-0 bg-black/80 z-[60] flex items-center justify-center">
        <div class="glass-light rounded-2xl p-6 w-full max-w-md mx-4">
            <h3 class="text-xl font-bold text-gray-800 mb-4"><i class="fas fa-calendar-alt mr-2 text-blue-500"></i>Schedule Content</h3>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm text-gray-600 mb-1">Publish Date</label>
                    <input type="date" id="scheduleDate" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:border-blue-500 focus:ring-2 focus:ring-blue-200">
                </div>
                <div>
                    <label class="block text-sm text-gray-600 mb-1">Publish Time</label>
                    <input type="time" id="scheduleTime" value="09:00" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:border-blue-500 focus:ring-2 focus:ring-blue-200">
                </div>
            </div>
            <div class="flex gap-2 mt-6">
                <button onclick="closeScheduleModal()" class="flex-1 px-4 py-2 bg-gray-200 hover:bg-gray-300 rounded-lg font-medium transition">Cancel</button>
                <button onclick="saveSchedule()" class="flex-1 px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-medium transition">Schedule</button>
            </div>
        </div>
    </div>

    <!-- Edit Client Modal -->
    <div id="editClientModal" class="hidden fixed inset-0 bg-black/90 z-50 overflow-y-auto">
        <div class="max-w-3xl mx-auto py-8 px-4">
            <div class="glass-light rounded-2xl overflow-hidden fade-in">
                <div class="bg-gradient-to-r from-blue-600 to-indigo-600 p-6">
                    <div class="flex items-center justify-between">
                        <div>
                            <h2 class="text-2xl font-bold text-white">Edit Client</h2>
                            <p class="text-white/70 text-sm">Update client information and SEO settings</p>
                        </div>
                        <button onclick="closeEditClient()" class="p-2 hover:bg-white/20 rounded-lg transition">
                            <i class="fas fa-times text-white text-xl"></i>
                        </button>
                    </div>
                </div>
                <div class="p-6 space-y-6 bg-gray-900 max-h-[70vh] overflow-y-auto">
                    <!-- Business Info Section -->
                    <div class="border-b border-white/10 pb-4">
                        <h3 class="text-sm font-semibold text-gray-400 uppercase tracking-wide mb-4">
                            <i class="fas fa-building mr-2"></i>Business Information
                        </h3>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm text-gray-400 mb-1">Business Name *</label>
                                <input type="text" id="editBusinessName" class="w-full px-4 py-2 bg-white/10 border border-white/20 rounded-lg text-white focus:border-blue-500 focus:ring-1 focus:ring-blue-500">
                            </div>
                            <div>
                                <label class="block text-sm text-gray-400 mb-1">Industry</label>
                                <input type="text" id="editIndustry" class="w-full px-4 py-2 bg-white/10 border border-white/20 rounded-lg text-white focus:border-blue-500">
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-4 mt-4">
                            <div>
                                <label class="block text-sm text-gray-400 mb-1">Location (City, State)</label>
                                <input type="text" id="editGeo" class="w-full px-4 py-2 bg-white/10 border border-white/20 rounded-lg text-white focus:border-blue-500">
                            </div>
                            <div>
                                <label class="block text-sm text-gray-400 mb-1">Website URL</label>
                                <input type="text" id="editWebsite" class="w-full px-4 py-2 bg-white/10 border border-white/20 rounded-lg text-white focus:border-blue-500" placeholder="https://">
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-4 mt-4">
                            <div>
                                <label class="block text-sm text-gray-400 mb-1">Phone</label>
                                <input type="text" id="editPhone" class="w-full px-4 py-2 bg-white/10 border border-white/20 rounded-lg text-white focus:border-blue-500">
                            </div>
                            <div>
                                <label class="block text-sm text-gray-400 mb-1">Email</label>
                                <input type="email" id="editEmail" class="w-full px-4 py-2 bg-white/10 border border-white/20 rounded-lg text-white focus:border-blue-500">
                            </div>
                        </div>
                    </div>
                    
                    <!-- Content Settings Section -->
                    <div class="border-b border-white/10 pb-4">
                        <h3 class="text-sm font-semibold text-gray-400 uppercase tracking-wide mb-4">
                            <i class="fas fa-pen-fancy mr-2"></i>Content Settings
                        </h3>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm text-gray-400 mb-1">Writing Tone</label>
                                <select id="editTone" class="w-full px-4 py-2 bg-white/10 border border-white/20 rounded-lg text-white focus:border-blue-500">
                                    <option value="professional">Professional</option>
                                    <option value="friendly">Friendly</option>
                                    <option value="casual">Casual</option>
                                    <option value="formal">Formal</option>
                                    <option value="conversational">Conversational</option>
                                    <option value="authoritative">Authoritative</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm text-gray-400 mb-1">Service Areas (comma separated)</label>
                                <input type="text" id="editServiceAreas" class="w-full px-4 py-2 bg-white/10 border border-white/20 rounded-lg text-white focus:border-blue-500" placeholder="Miami, Fort Lauderdale, Palm Beach">
                            </div>
                        </div>
                        <div class="mt-4">
                            <label class="block text-sm text-gray-400 mb-1">Unique Selling Points (comma separated)</label>
                            <textarea id="editUSPs" rows="2" class="w-full px-4 py-2 bg-white/10 border border-white/20 rounded-lg text-white focus:border-blue-500" placeholder="24/7 service, Licensed & insured, 20+ years experience"></textarea>
                        </div>
                    </div>
                    
                    <!-- SEO Keywords Section -->
                    <div class="border-b border-white/10 pb-4">
                        <h3 class="text-sm font-semibold text-gray-400 uppercase tracking-wide mb-4">
                            <i class="fas fa-search mr-2"></i>SEO Keywords
                        </h3>
                        <div>
                            <label class="block text-sm text-gray-400 mb-1">Primary Keywords (comma separated)</label>
                            <textarea id="editPrimaryKeywords" rows="2" class="w-full px-4 py-2 bg-white/10 border border-white/20 rounded-lg text-white focus:border-blue-500" placeholder="HVAC repair, AC installation, heating service"></textarea>
                            <p class="text-xs text-gray-500 mt-1">Main keywords for blog content generation</p>
                        </div>
                        <div class="mt-4">
                            <label class="block text-sm text-gray-400 mb-1">Secondary Keywords (comma separated)</label>
                            <textarea id="editSecondaryKeywords" rows="2" class="w-full px-4 py-2 bg-white/10 border border-white/20 rounded-lg text-white focus:border-blue-500" placeholder="air conditioning maintenance, furnace repair, ductwork"></textarea>
                            <p class="text-xs text-gray-500 mt-1">Supporting keywords and long-tail variations</p>
                        </div>
                    </div>
                    
                    <!-- Competitors Section -->
                    <div>
                        <h3 class="text-sm font-semibold text-gray-400 uppercase tracking-wide mb-4">
                            <i class="fas fa-users mr-2"></i>Competitors
                        </h3>
                        <div>
                            <label class="block text-sm text-gray-400 mb-1">Competitor Websites (comma separated)</label>
                            <textarea id="editCompetitors" rows="2" class="w-full px-4 py-2 bg-white/10 border border-white/20 rounded-lg text-white focus:border-blue-500" placeholder="competitor1.com, competitor2.com"></textarea>
                            <p class="text-xs text-gray-500 mt-1">Used for competitive analysis and content gap identification</p>
                        </div>
                    </div>
                    
                    <!-- WordPress Integration Section -->
                    <div class="border-t border-white/10 pt-4">
                        <h3 class="text-sm font-semibold text-gray-400 uppercase tracking-wide mb-4">
                            <i class="fab fa-wordpress mr-2"></i>WordPress Integration
                        </h3>
                        <div class="grid grid-cols-1 gap-4">
                            <div>
                                <label class="block text-sm text-gray-400 mb-1">WordPress Site URL</label>
                                <input type="text" id="editWordpressUrl" class="w-full px-4 py-2 bg-white/10 border border-white/20 rounded-lg text-white focus:border-blue-500" placeholder="https://yoursite.com">
                            </div>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm text-gray-400 mb-1">WordPress Username</label>
                                    <input type="text" id="editWordpressUser" class="w-full px-4 py-2 bg-white/10 border border-white/20 rounded-lg text-white focus:border-blue-500">
                                </div>
                                <div>
                                    <label class="block text-sm text-gray-400 mb-1">App Password</label>
                                    <input type="password" id="editWordpressPassword" autocomplete="off" class="w-full px-4 py-2 bg-white/10 border border-white/20 rounded-lg text-white focus:border-blue-500" placeholder="xxxx xxxx xxxx xxxx">
                                </div>
                            </div>
                            <div class="flex items-center gap-3">
                                <button type="button" onclick="testWordPressConnection()" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg text-sm transition">
                                    <i class="fas fa-plug mr-1"></i>Test Connection
                                </button>
                                <span id="wpTestResult" class="text-sm"></span>
                            </div>
                            <p class="text-xs text-gray-500">
                                <i class="fas fa-info-circle mr-1"></i>
                                Generate an App Password in WordPress: Users ‚Üí Profile ‚Üí Application Passwords
                            </p>
                        </div>
                    </div>
                    
                    <!-- Action Buttons -->
                    <div class="flex gap-3 pt-4 border-t border-white/10">
                        <button onclick="saveClientEdits()" class="flex-1 py-3 bg-gradient-to-r from-blue-600 to-indigo-600 text-white rounded-lg font-semibold hover:opacity-90 transition">
                            <i class="fas fa-save mr-2"></i>Save Changes
                        </button>
                        <button onclick="closeEditClient()" class="px-6 py-3 bg-gray-700 text-white rounded-lg hover:bg-gray-600 transition">
                            Cancel
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Debug logging - disabled in production
        const DEBUG = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';
        if (!DEBUG) { console.log = () => {}; console.error = () => {}; }
        
        // ==========================================
        // LOADING STATE UTILITY
        // ==========================================
        function withLoading(btn, asyncFn) {
            return async function(...args) {
                const originalHTML = btn.innerHTML;
                const originalDisabled = btn.disabled;
                btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Processing...';
                btn.disabled = true;
                try {
                    return await asyncFn.apply(this, args);
                } finally {
                    btn.innerHTML = originalHTML;
                    btn.disabled = originalDisabled;
                }
            };
        }
        
        function setButtonLoading(btn, loading, loadingText = 'Processing...') {
            if (loading) {
                btn.dataset.originalHtml = btn.innerHTML;
                btn.innerHTML = `<i class="fas fa-spinner fa-spin mr-2"></i>${loadingText}`;
                btn.disabled = true;
            } else {
                btn.innerHTML = btn.dataset.originalHtml || btn.innerHTML;
                btn.disabled = false;
            }
        }
        
        // Mobile navigation toggle
        function toggleMobileNav() {
            const nav = document.getElementById('mobileNav');
            nav.classList.toggle('hidden');
        }
        
        // ==========================================
        // WHITE-LABEL BRANDING
        // ==========================================
        function loadBranding() {
            const saved = localStorage.getItem('mcp_branding');
            if (!saved) return;
            
            try {
                const branding = JSON.parse(saved);
                
                // Update page title
                document.title = `Content Dashboard | ${branding.agencyName}`;
                
                // Update login screen branding
                const loginTitle = document.querySelector('.gradient-text');
                if (loginTitle) loginTitle.textContent = branding.agencyName;
                
                // Update any brand name elements
                document.querySelectorAll('[data-brand="name"]').forEach(el => {
                    el.textContent = branding.agencyName;
                });
                
                // Apply brand colors via CSS variables
                if (branding.primaryColor) {
                    document.documentElement.style.setProperty('--brand-primary', branding.primaryColor);
                }
                if (branding.secondaryColor) {
                    document.documentElement.style.setProperty('--brand-secondary', branding.secondaryColor);
                }
            } catch (e) {
                console.warn('Could not load branding:', e);
            }
        }
        
        // Load branding on page load
        document.addEventListener('DOMContentLoaded', loadBranding);
        
        let API_URL = window.location.origin;
        let AUTH_TOKEN = '';
        let currentClient = null;
        let allBlogs = [];
        let allSocial = [];

        // ==========================================
        // AUTH
        // ==========================================
        
        // Check if bootstrap is needed on page load
        (async function checkBootstrap() {
            try {
                const res = await fetch(`${API_URL}/api/auth/health`);
                const health = await res.json();
                
                if (!health.admin_exists) {
                    // Show bootstrap UI
                    showBootstrapUI();
                }
            } catch (e) {
                console.log('Health check failed:', e);
            }
        })();
        
        function showBootstrapUI() {
            const authContent = document.querySelector('#authModal .relative.bg-white');
            if (authContent) {
                authContent.innerHTML = `
                    <div class="p-8">
                        <div class="text-center mb-8">
                            <div class="w-16 h-16 bg-gradient-to-br from-amber-500 to-orange-600 rounded-2xl flex items-center justify-center mx-auto mb-4">
                                <i class="fas fa-cog text-2xl text-white"></i>
                            </div>
                            <h1 class="text-2xl font-bold text-gray-800">System Setup</h1>
                            <p class="text-gray-500 mt-2">Create your admin account</p>
                        </div>
                        
                        <div id="bootstrapError" class="hidden mb-4 p-3 bg-red-50 border border-red-200 rounded-lg text-red-600 text-sm"></div>
                        
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Email</label>
                                <input type="email" id="bootstrapEmail" value="admin@karma.marketing"
                                    class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-purple-500 focus:border-purple-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Password</label>
                                <input type="password" id="bootstrapPassword" autocomplete="new-password" placeholder="Min 8 characters"
                                    class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-purple-500 focus:border-purple-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Confirm Password</label>
                                <input type="password" id="bootstrapConfirm" autocomplete="new-password"
                                    class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-purple-500 focus:border-purple-500">
                            </div>
                            <button onclick="doBootstrap()" id="bootstrapBtn" 
                                class="w-full py-3 bg-gradient-to-r from-amber-500 to-orange-600 text-white rounded-xl font-semibold hover:opacity-90">
                                Create Admin Account
                            </button>
                        </div>
                    </div>
                `;
            }
        }
        
        async function doBootstrap() {
            const email = document.getElementById('bootstrapEmail').value;
            const password = document.getElementById('bootstrapPassword').value;
            const confirm = document.getElementById('bootstrapConfirm').value;
            const errorEl = document.getElementById('bootstrapError');
            const btn = document.getElementById('bootstrapBtn');
            
            if (!email || !password) {
                errorEl.textContent = 'Email and password required';
                errorEl.classList.remove('hidden');
                return;
            }
            if (password !== confirm) {
                errorEl.textContent = 'Passwords do not match';
                errorEl.classList.remove('hidden');
                return;
            }
            if (password.length < 8) {
                errorEl.textContent = 'Password must be at least 8 characters';
                errorEl.classList.remove('hidden');
                return;
            }
            
            btn.disabled = true;
            btn.textContent = 'Creating...';
            
            try {
                const res = await fetch(`${API_URL}/api/auth/bootstrap`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password, name: 'Admin' })
                });
                const data = await res.json();
                
                if (res.ok && data.token) {
                    AUTH_TOKEN = data.token;
                    alert('‚úì Admin created! Email: ' + email);
                    document.getElementById('authModal').classList.add('hidden');
                    document.getElementById('dashboard').classList.remove('hidden');
                    loadClients();
                } else {
                    errorEl.textContent = data.error || 'Setup failed';
                    errorEl.classList.remove('hidden');
                    btn.textContent = 'Create Admin Account';
                    btn.disabled = false;
                }
            } catch (e) {
                errorEl.textContent = e.message;
                errorEl.classList.remove('hidden');
                btn.textContent = 'Create Admin Account';
                btn.disabled = false;
            }
        }
        
        async function doLogin() {
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            const errorEl = document.getElementById('authError');

            try {
                const res = await fetch(`${API_URL}/api/auth/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password })
                });
                
                if (!res.ok) {
                    const errorText = await res.text();
                    try {
                        const errorData = JSON.parse(errorText);
                        throw new Error(errorData.error || `Login failed: ${res.status}`);
                    } catch {
                        throw new Error(`Server error: ${res.status}`);
                    }
                }
                
                const data = await res.json();

                if (data.token) {
                    AUTH_TOKEN = data.token;
                    document.getElementById('authModal').classList.add('hidden');
                    document.getElementById('dashboard').classList.remove('hidden');
                    loadClients();
                } else {
                    errorEl.textContent = data.error || 'Login failed';
                    errorEl.classList.remove('hidden');
                }
            } catch (e) {
                errorEl.textContent = e.message || 'Connection failed';
                errorEl.classList.remove('hidden');
            }
        }

        // ==========================================
        // DATA LOADING
        // ==========================================
        async function loadClients() {
            try {
                const res = await fetch(`${API_URL}/api/clients/`, {
                    headers: { 'Authorization': `Bearer ${AUTH_TOKEN}` }
                });
                if (!res.ok) {
                    throw new Error(`Failed to load clients: ${res.status}`);
                }
                const data = await res.json();
                const clients = data.clients || [];

                const selector = document.getElementById('clientSelector');
                selector.innerHTML = '<option value="">Select Client</option>';
                clients.forEach(c => {
                    selector.innerHTML += `<option value="${c.id}">${c.business_name}</option>`;
                });

                if (clients.length > 0) {
                    selector.value = clients[0].id;
                    loadClient(clients[0].id);
                }
            } catch (e) {
                console.error('Failed to load clients:', e);
            }
        }

        async function loadClient(clientId) {
            if (!clientId) return;

            try {
                // Load client details
                const clientRes = await fetch(`${API_URL}/api/clients/${clientId}`, {
                    headers: { 'Authorization': `Bearer ${AUTH_TOKEN}` }
                });
                if (!clientRes.ok) {
                    throw new Error(`Failed to load client: ${clientRes.status}`);
                }
                currentClient = await clientRes.json();

                // Update header
                document.getElementById('clientName').textContent = currentClient.business_name || 'Client';
                document.getElementById('clientMeta').textContent = `${currentClient.industry || ''} ‚Ä¢ ${currentClient.geo || ''}`;

                // Load blogs
                const blogsRes = await fetch(`${API_URL}/api/content/client/${clientId}`, {
                    headers: { 'Authorization': `Bearer ${AUTH_TOKEN}` }
                });
                if (blogsRes.ok) {
                    const blogsData = await blogsRes.json();
                    allBlogs = blogsData.content || blogsData.blogs || [];
                } else {
                    allBlogs = [];
                }

                // Load social
                const socialRes = await fetch(`${API_URL}/api/social/client/${clientId}`, {
                    headers: { 'Authorization': `Bearer ${AUTH_TOKEN}` }
                });
                if (socialRes.ok) {
                    const socialData = await socialRes.json();
                    allSocial = socialData.posts || [];
                } else {
                    allSocial = [];
                }

                // Update stats
                updateStats();
                renderBlogs();
                renderSocial();
                renderSEO();

            } catch (e) {
                console.error('Failed to load client:', e);
                alert('Failed to load client data. Please try again.');
            }
        }

        function updateStats() {
            document.getElementById('statBlogs').textContent = allBlogs.length;
            document.getElementById('statSocial').textContent = allSocial.length;
            document.getElementById('statKeywords').textContent = 
                (currentClient?.primary_keywords?.length || 0) + (currentClient?.secondary_keywords?.length || 0);
            document.getElementById('statCompetitors').textContent = currentClient?.competitors?.length || 0;
        }

        function refreshData() {
            const clientId = document.getElementById('clientSelector').value;
            if (clientId) loadClient(clientId);
        }

        // ==========================================
        // CLIENT MANAGEMENT (Edit/Delete)
        // ==========================================
        function showEditClient() {
            if (!currentClient) {
                alert('Please select a client first');
                return;
            }
            
            // Populate form fields
            document.getElementById('editBusinessName').value = currentClient.business_name || '';
            document.getElementById('editIndustry').value = currentClient.industry || '';
            document.getElementById('editGeo').value = currentClient.geo || '';
            document.getElementById('editWebsite').value = currentClient.website_url || '';
            document.getElementById('editPhone').value = currentClient.phone || '';
            document.getElementById('editEmail').value = currentClient.email || '';
            document.getElementById('editTone').value = currentClient.tone || 'professional';
            document.getElementById('editPrimaryKeywords').value = (currentClient.primary_keywords || []).join(', ');
            document.getElementById('editSecondaryKeywords').value = (currentClient.secondary_keywords || []).join(', ');
            document.getElementById('editServiceAreas').value = (currentClient.service_areas || []).join(', ');
            document.getElementById('editUSPs').value = (currentClient.unique_selling_points || []).join(', ');
            document.getElementById('editCompetitors').value = (currentClient.competitors || []).join(', ');
            
            // WordPress fields
            document.getElementById('editWordpressUrl').value = currentClient.wordpress_url || '';
            document.getElementById('editWordpressUser').value = currentClient.wordpress_user || '';
            document.getElementById('editWordpressPassword').value = currentClient.wordpress_app_password || '';
            document.getElementById('wpTestResult').textContent = '';
            document.getElementById('wpTestResult').className = 'text-sm';
            
            document.getElementById('editClientModal').classList.remove('hidden');
        }
        
        function closeEditClient() {
            document.getElementById('editClientModal').classList.add('hidden');
        }
        
        async function testWordPressConnection() {
            const url = document.getElementById('editWordpressUrl').value.trim();
            const user = document.getElementById('editWordpressUser').value.trim();
            const pass = document.getElementById('editWordpressPassword').value.trim();
            
            if (!url || !user || !pass) {
                document.getElementById('wpTestResult').textContent = '‚ö†Ô∏è Fill in all WordPress fields first';
                document.getElementById('wpTestResult').className = 'text-sm text-amber-400';
                return;
            }
            
            document.getElementById('wpTestResult').textContent = 'üîÑ Testing...';
            document.getElementById('wpTestResult').className = 'text-sm text-blue-400';
            
            try {
                const response = await fetch(`${API_URL}/api/content/wordpress/test`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${AUTH_TOKEN}`
                    },
                    body: JSON.stringify({
                        wordpress_url: url,
                        wordpress_user: user,
                        wordpress_app_password: pass
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    document.getElementById('wpTestResult').textContent = `‚úÖ Connected as ${result.user || 'user'}`;
                    document.getElementById('wpTestResult').className = 'text-sm text-green-400';
                } else {
                    document.getElementById('wpTestResult').textContent = `‚ùå ${result.message}`;
                    document.getElementById('wpTestResult').className = 'text-sm text-red-400';
                }
            } catch (error) {
                document.getElementById('wpTestResult').textContent = `‚ùå ${error.message}`;
                document.getElementById('wpTestResult').className = 'text-sm text-red-400';
            }
        }
        
        async function saveClientEdits() {
            if (!currentClient) return;
            
            const businessName = document.getElementById('editBusinessName').value.trim();
            if (!businessName) {
                alert('Business name is required');
                return;
            }
            
            const updates = {
                business_name: businessName,
                industry: document.getElementById('editIndustry').value.trim(),
                geo: document.getElementById('editGeo').value.trim(),
                website_url: document.getElementById('editWebsite').value.trim(),
                phone: document.getElementById('editPhone').value.trim(),
                email: document.getElementById('editEmail').value.trim(),
                tone: document.getElementById('editTone').value,
                primary_keywords: document.getElementById('editPrimaryKeywords').value.split(',').map(k => k.trim()).filter(k => k),
                secondary_keywords: document.getElementById('editSecondaryKeywords').value.split(',').map(k => k.trim()).filter(k => k),
                service_areas: document.getElementById('editServiceAreas').value.split(',').map(s => s.trim()).filter(s => s),
                unique_selling_points: document.getElementById('editUSPs').value.split(',').map(u => u.trim()).filter(u => u),
                competitors: document.getElementById('editCompetitors').value.split(',').map(c => c.trim()).filter(c => c),
                // WordPress fields
                wordpress_url: document.getElementById('editWordpressUrl').value.trim(),
                wordpress_user: document.getElementById('editWordpressUser').value.trim(),
                wordpress_app_password: document.getElementById('editWordpressPassword').value.trim()
            };
            
            try {
                const response = await fetch(`${API_URL}/api/clients/${currentClient.id}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${AUTH_TOKEN}`
                    },
                    body: JSON.stringify(updates)
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Failed to update client');
                }
                
                const result = await response.json();
                currentClient = result.client;
                
                // Update UI
                document.getElementById('clientName').textContent = currentClient.business_name || 'Client';
                document.getElementById('clientMeta').textContent = `${currentClient.industry || ''} ‚Ä¢ ${currentClient.geo || ''}`;
                
                // Update selector option text
                const selector = document.getElementById('clientSelector');
                const option = selector.querySelector(`option[value="${currentClient.id}"]`);
                if (option) {
                    option.textContent = currentClient.business_name;
                }
                
                closeEditClient();
                alert('‚úì Client updated successfully!');
                
                // Refresh data and SEO panel
                loadClient(currentClient.id);
                renderSEO();
                
            } catch (error) {
                console.error('Failed to save client:', error);
                alert('Error: ' + error.message);
            }
        }
        
        function confirmDeleteClient() {
            if (!currentClient) {
                alert('Please select a client first');
                return;
            }
            
            const blogCount = allBlogs.length;
            const socialCount = allSocial.length;
            
            let warning = `Are you sure you want to delete "${currentClient.business_name}"?\n\n`;
            warning += `This will permanently delete:\n`;
            warning += `‚Ä¢ ${blogCount} blog posts\n`;
            warning += `‚Ä¢ ${socialCount} social posts\n`;
            warning += `‚Ä¢ All keywords and settings\n\n`;
            warning += `This action cannot be undone!`;
            
            if (confirm(warning)) {
                // Double confirm for safety
                const confirmText = prompt(`Type "DELETE" to confirm deletion of ${currentClient.business_name}:`);
                if (confirmText === 'DELETE') {
                    deleteClient();
                } else if (confirmText !== null) {
                    alert('Deletion cancelled. You must type DELETE exactly to confirm.');
                }
            }
        }
        
        async function deleteClient() {
            if (!currentClient) return;
            
            try {
                // Use hard delete to permanently remove client and content
                const response = await fetch(`${API_URL}/api/clients/${currentClient.id}?hard=true`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${AUTH_TOKEN}`
                    }
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Failed to delete client');
                }
                
                alert(`‚úì "${currentClient.business_name}" has been permanently deleted.`);
                
                // Reset state
                currentClient = null;
                allBlogs = [];
                allSocial = [];
                
                // Reset UI
                document.getElementById('clientName').textContent = 'Select Client';
                document.getElementById('clientMeta').textContent = 'Content Dashboard';
                document.getElementById('clientSelector').value = '';
                updateStats();
                renderBlogs();
                renderSocial();
                
                // Reload client list
                await loadClients();
                
            } catch (error) {
                console.error('Failed to delete client:', error);
                alert('Error: ' + error.message);
            }
        }

        // ==========================================
        // TABS
        // ==========================================
        function showTab(tab) {
            ['generate', 'blogs', 'social', 'seo', 'calendar', 'reports', 'rankings', 'competitors', 'settings', 'chatbot'].forEach(t => {
                document.getElementById(`panel-${t}`).classList.add('hidden');
                document.getElementById(`tab-${t}`).classList.remove('tab-active');
                if (t !== 'generate') {
                    document.getElementById(`tab-${t}`).classList.add('glass', 'text-gray-400');
                }
            });
            document.getElementById(`panel-${tab}`).classList.remove('hidden');
            document.getElementById(`tab-${tab}`).classList.add('tab-active');
            if (tab !== 'generate') {
                document.getElementById(`tab-${tab}`).classList.remove('glass', 'text-gray-400');
            }
            
            // Populate keyword dropdown when generate tab is shown
            if (tab === 'generate') {
                populateKeywordDropdown();
            }
            
            // Render calendar when calendar tab is shown
            if (tab === 'calendar') {
                renderCalendar();
            }
            
            // Update report stats when reports tab is shown
            if (tab === 'reports') {
                updateReportStats();
            }
            
            // Load chatbot config when chatbot tab is shown
            if (tab === 'chatbot') {
                loadChatbotConfig();
            }
            
            // Load rankings when rankings tab is shown
            if (tab === 'rankings') {
                loadRankingHistory();
            }
            
            // Load competitor dashboard when competitors tab is shown
            if (tab === 'competitors') {
                refreshCompetitorDashboard();
            }
            
            // Load notification settings when settings tab is shown
            if (tab === 'settings') {
                loadNotificationPrefs();
                loadNotificationHistory();
            }
        }
        
        // ==========================================
        // NOTIFICATION SETTINGS
        // ==========================================
        
        let notificationPrefs = null;
        
        async function loadNotificationPrefs() {
            try {
                const response = await fetch(`${API_URL}/api/notifications/preferences`, {
                    headers: { 'Authorization': `Bearer ${AUTH_TOKEN}` }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    notificationPrefs = data.preferences;
                    populateNotificationForm(notificationPrefs);
                }
            } catch (error) {
                console.error('Failed to load notification prefs:', error);
            }
        }
        
        function populateNotificationForm(prefs) {
            // Master toggle
            document.getElementById('notifEmailEnabled').checked = prefs.delivery?.email_enabled !== false;
            
            // Content notifications
            document.getElementById('notifContentScheduled').checked = prefs.content?.scheduled !== false;
            document.getElementById('notifContentDueToday').checked = prefs.content?.due_today !== false;
            document.getElementById('notifContentPublished').checked = prefs.content?.published !== false;
            document.getElementById('notifApprovalNeeded').checked = prefs.content?.approval_needed !== false;
            document.getElementById('notifContentFeedback').checked = prefs.content?.feedback !== false;
            
            // Competitor notifications
            document.getElementById('notifCompetitorContent').checked = prefs.competitor?.new_content !== false;
            document.getElementById('notifRankingImproved').checked = prefs.competitor?.ranking_improved !== false;
            document.getElementById('notifRankingDropped').checked = prefs.competitor?.ranking_dropped !== false;
            
            // Publishing notifications
            document.getElementById('notifWpPublished').checked = prefs.publishing?.wordpress_published !== false;
            document.getElementById('notifWpFailed').checked = prefs.publishing?.wordpress_failed !== false;
            document.getElementById('notifSocialPublished').checked = prefs.publishing?.social_published === true;
            document.getElementById('notifSocialFailed').checked = prefs.publishing?.social_failed !== false;
            
            // Delivery settings
            document.getElementById('notifDigestFreq').value = prefs.delivery?.digest_frequency || 'instant';
            document.getElementById('notifDigestTime').value = prefs.delivery?.digest_time || '08:00';
            document.getElementById('notifDigestDay').value = prefs.delivery?.digest_day || 0;
            
            // Show/hide digest options
            updateDigestVisibility();
            
            // Quiet hours
            document.getElementById('notifQuietEnabled').checked = prefs.quiet_hours?.enabled === true;
            document.getElementById('notifQuietStart').value = prefs.quiet_hours?.start || '22:00';
            document.getElementById('notifQuietEnd').value = prefs.quiet_hours?.end || '07:00';
            updateQuietHoursVisibility();
        }
        
        function updateDigestVisibility() {
            const freq = document.getElementById('notifDigestFreq').value;
            const timeWrapper = document.getElementById('digestTimeWrapper');
            const dayWrapper = document.getElementById('digestDayWrapper');
            
            if (freq === 'instant') {
                timeWrapper.classList.add('hidden');
                dayWrapper.classList.add('hidden');
            } else if (freq === 'daily') {
                timeWrapper.classList.remove('hidden');
                dayWrapper.classList.add('hidden');
            } else {
                timeWrapper.classList.remove('hidden');
                dayWrapper.classList.remove('hidden');
            }
        }
        
        function updateQuietHoursVisibility() {
            const enabled = document.getElementById('notifQuietEnabled').checked;
            const config = document.getElementById('quietHoursConfig');
            const inputs = config.querySelectorAll('input');
            
            if (enabled) {
                config.classList.remove('opacity-50');
                inputs.forEach(i => i.disabled = false);
            } else {
                config.classList.add('opacity-50');
                inputs.forEach(i => i.disabled = true);
            }
        }
        
        // Add event listeners for digest and quiet hours toggles
        document.addEventListener('DOMContentLoaded', function() {
            const digestFreq = document.getElementById('notifDigestFreq');
            const quietEnabled = document.getElementById('notifQuietEnabled');
            
            if (digestFreq) digestFreq.addEventListener('change', updateDigestVisibility);
            if (quietEnabled) quietEnabled.addEventListener('change', updateQuietHoursVisibility);
            
            // Handle OAuth callback if present
            handleOAuthCallback();
        });
        
        async function saveNotificationPrefs() {
            const prefs = {
                email_enabled: document.getElementById('notifEmailEnabled').checked,
                
                // Content
                content_scheduled: document.getElementById('notifContentScheduled').checked,
                content_due_today: document.getElementById('notifContentDueToday').checked,
                content_published: document.getElementById('notifContentPublished').checked,
                content_approval_needed: document.getElementById('notifApprovalNeeded').checked,
                content_feedback: document.getElementById('notifContentFeedback').checked,
                
                // Competitor
                competitor_new_content: document.getElementById('notifCompetitorContent').checked,
                ranking_improved: document.getElementById('notifRankingImproved').checked,
                ranking_dropped: document.getElementById('notifRankingDropped').checked,
                
                // Publishing
                wordpress_published: document.getElementById('notifWpPublished').checked,
                wordpress_failed: document.getElementById('notifWpFailed').checked,
                social_published: document.getElementById('notifSocialPublished').checked,
                social_failed: document.getElementById('notifSocialFailed').checked,
                
                // Delivery
                digest_frequency: document.getElementById('notifDigestFreq').value,
                digest_time: document.getElementById('notifDigestTime').value,
                digest_day: parseInt(document.getElementById('notifDigestDay').value),
                
                // Quiet hours
                quiet_hours_enabled: document.getElementById('notifQuietEnabled').checked,
                quiet_start: document.getElementById('notifQuietStart').value,
                quiet_end: document.getElementById('notifQuietEnd').value
            };
            
            try {
                const response = await fetch(`${API_URL}/api/notifications/preferences`, {
                    method: 'PUT',
                    headers: { 
                        'Authorization': `Bearer ${AUTH_TOKEN}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(prefs)
                });
                
                if (response.ok) {
                    alert('‚úì Notification preferences saved!');
                } else {
                    const data = await response.json();
                    alert('Error: ' + (data.error || 'Failed to save preferences'));
                }
            } catch (error) {
                alert('Error saving preferences: ' + error.message);
            }
        }
        
        async function sendTestNotification() {
            const btn = document.getElementById('testNotifBtn');
            btn.disabled = true;
            btn.textContent = 'Sending...';
            
            try {
                const response = await fetch(`${API_URL}/api/notifications/test`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${AUTH_TOKEN}` }
                });
                
                const data = await response.json();
                
                if (response.ok && data.success) {
                    alert('‚úì Test email sent! Check your inbox.');
                } else {
                    alert('Error: ' + (data.error || 'Failed to send test email'));
                }
            } catch (error) {
                alert('Error: ' + error.message);
            } finally {
                btn.disabled = false;
                btn.textContent = 'Send Test Email';
            }
        }
        
        async function loadNotificationHistory() {
            try {
                const response = await fetch(`${API_URL}/api/notifications/history?limit=10`, {
                    headers: { 'Authorization': `Bearer ${AUTH_TOKEN}` }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    renderNotificationHistory(data.notifications);
                }
            } catch (error) {
                console.error('Failed to load notification history:', error);
            }
        }
        
        function renderNotificationHistory(notifications) {
            const container = document.getElementById('notificationHistory');
            
            if (!notifications || notifications.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-sm">No notifications sent yet</p>';
                return;
            }
            
            container.innerHTML = notifications.map(n => {
                const statusColor = n.status === 'sent' ? 'text-green-400' : 
                                   n.status === 'failed' ? 'text-red-400' : 'text-yellow-400';
                const statusIcon = n.status === 'sent' ? 'fa-check-circle' : 
                                  n.status === 'failed' ? 'fa-times-circle' : 'fa-clock';
                const date = new Date(n.created_at).toLocaleDateString('en-US', { 
                    month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' 
                });
                
                return `
                    <div class="p-2 bg-white/5 rounded-lg">
                        <div class="flex items-center justify-between">
                            <span class="text-xs text-gray-400">${date}</span>
                            <i class="fas ${statusIcon} ${statusColor}"></i>
                        </div>
                        <div class="text-sm text-white truncate mt-1">${n.subject}</div>
                    </div>
                `;
            }).join('');
        }
        
        // ==========================================
        // CALENDAR
        // ==========================================
        let calendarDate = new Date();
        let scheduledContent = [];
        
        function changeMonth(delta) {
            calendarDate.setMonth(calendarDate.getMonth() + delta);
            renderCalendar();
        }
        
        function renderCalendar() {
            const year = calendarDate.getFullYear();
            const month = calendarDate.getMonth();
            
            // Update header
            const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 
                               'July', 'August', 'September', 'October', 'November', 'December'];
            document.getElementById('calendarMonth').textContent = `${monthNames[month]} ${year}`;
            
            // Get first day and days in month
            const firstDay = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const today = new Date();
            
            // Build calendar grid
            const grid = document.getElementById('calendarGrid');
            grid.innerHTML = '';
            
            // Empty cells before first day
            for (let i = 0; i < firstDay; i++) {
                grid.innerHTML += `<div class="h-24 rounded-lg bg-white/5"></div>`;
            }
            
            // Days of month
            for (let day = 1; day <= daysInMonth; day++) {
                const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                const isToday = today.getDate() === day && today.getMonth() === month && today.getFullYear() === year;
                const dayContent = getScheduledForDate(dateStr);
                
                grid.innerHTML += `
                    <div class="h-24 rounded-lg ${isToday ? 'bg-purple-500/20 border border-purple-500' : 'bg-white/5 hover:bg-white/10'} p-2 transition cursor-pointer" onclick="showDateContent('${dateStr}')">
                        <div class="text-sm font-medium ${isToday ? 'text-purple-400' : 'text-gray-300'}">${day}</div>
                        <div class="mt-1 space-y-1 overflow-hidden">
                            ${dayContent}
                        </div>
                    </div>
                `;
            }
            
            // Update scheduled list
            renderScheduledList();
        }
        
        function getScheduledForDate(dateStr) {
            const items = scheduledContent.filter(c => c.scheduled_date === dateStr);
            if (items.length === 0) return '';
            
            return items.slice(0, 3).map(item => {
                const colors = {
                    blog: 'bg-green-500',
                    gbp: 'bg-blue-500',
                    facebook: 'bg-indigo-500',
                    instagram: 'bg-pink-500'
                };
                return `<div class="w-full h-1.5 rounded ${colors[item.type] || 'bg-gray-500'}" title="${item.title || item.topic}"></div>`;
            }).join('');
        }
        
        function renderScheduledList() {
            const container = document.getElementById('scheduledList');
            
            // Combine blogs and social posts with REAL dates
            scheduledContent = [];
            
            // Add blogs - use actual scheduled_for from database
            allBlogs.forEach((blog) => {
                let scheduledDate = null;
                if (blog.scheduled_for) {
                    scheduledDate = blog.scheduled_for.split('T')[0];
                }
                scheduledContent.push({
                    id: blog.id,
                    type: 'blog',
                    title: blog.title,
                    scheduled_date: scheduledDate,
                    status: blog.status
                });
            });
            
            // Add social posts - use actual scheduled_for
            allSocial.forEach((post) => {
                let scheduledDate = null;
                if (post.scheduled_for) {
                    scheduledDate = post.scheduled_for.split('T')[0];
                }
                scheduledContent.push({
                    id: post.id,
                    type: post.platform,
                    topic: post.topic || post.content?.substring(0, 50),
                    scheduled_date: scheduledDate,
                    status: post.status
                });
            });
            
            // Filter to only scheduled items and sort by date
            const scheduledOnly = scheduledContent.filter(c => c.scheduled_date);
            scheduledOnly.sort((a, b) => a.scheduled_date.localeCompare(b.scheduled_date));
            
            // Stats
            const scheduledCount = scheduledOnly.length;
            const unscheduledCount = scheduledContent.length - scheduledCount;
            
            if (scheduledContent.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-sm">No content yet. Generate content first.</p>';
                return;
            }
            
            if (scheduledCount === 0) {
                container.innerHTML = `
                    <div class="text-center py-4">
                        <p class="text-gray-400 text-sm mb-3">${unscheduledCount} items not scheduled</p>
                        <button onclick="autoScheduleContent()" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg text-sm font-medium transition">
                            <i class="fas fa-magic mr-1"></i>Auto-Schedule All
                        </button>
                    </div>
                `;
                return;
            }
            
            // Show scheduled items
            let html = '';
            if (unscheduledCount > 0) {
                html += `
                    <div class="mb-4 p-3 bg-amber-500/20 border border-amber-500/50 rounded-lg">
                        <p class="text-amber-400 text-sm">${unscheduledCount} items not scheduled</p>
                        <button onclick="autoScheduleContent()" class="mt-2 px-3 py-1 bg-amber-500 hover:bg-amber-600 text-white rounded text-xs font-medium transition">
                            <i class="fas fa-magic mr-1"></i>Auto-Schedule
                        </button>
                    </div>
                `;
            }
            
            html += scheduledOnly.slice(0, 10).map(item => {
                const colors = {
                    blog: 'from-green-500 to-emerald-600',
                    gbp: 'from-blue-500 to-cyan-600',
                    facebook: 'from-indigo-500 to-blue-600',
                    instagram: 'from-pink-500 to-rose-600'
                };
                const icons = {
                    blog: 'fa-file-alt',
                    gbp: 'fab fa-google',
                    facebook: 'fab fa-facebook',
                    instagram: 'fab fa-instagram'
                };
                const statusColors = {
                    'draft': 'bg-gray-500/20 text-gray-400',
                    'scheduled': 'bg-blue-500/20 text-blue-400',
                    'approved': 'bg-green-500/20 text-green-400',
                    'published': 'bg-emerald-500/20 text-emerald-400'
                };
                return `
                    <div class="flex items-center gap-4 p-3 glass rounded-lg">
                        <div class="w-10 h-10 rounded-lg bg-gradient-to-br ${colors[item.type] || 'from-gray-500 to-gray-600'} flex items-center justify-center">
                            <i class="${icons[item.type] || 'fas fa-file'} text-white"></i>
                        </div>
                        <div class="flex-1 min-w-0">
                            <p class="text-white font-medium text-sm truncate">${item.title || item.topic || 'Untitled'}</p>
                            <p class="text-gray-400 text-xs">${item.type.charAt(0).toUpperCase() + item.type.slice(1)} ‚Ä¢ ${formatDate(item.scheduled_date)}</p>
                        </div>
                        <span class="px-2 py-1 ${statusColors[item.status] || statusColors.draft} rounded text-xs whitespace-nowrap">
                            ${item.status || 'draft'}
                        </span>
                    </div>
                `;
            }).join('');
            
            container.innerHTML = html;
        }
        
        function formatDate(dateStr) {
            if (!dateStr) return 'Not scheduled';
            const date = new Date(dateStr + 'T00:00:00');
            return date.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });
        }
        
        async function autoScheduleContent() {
            if (!currentClient) return;
            
            const unscheduledBlogs = allBlogs.filter(b => !b.scheduled_for);
            const unscheduledSocial = allSocial.filter(s => !s.scheduled_for);
            
            if (unscheduledBlogs.length === 0 && unscheduledSocial.length === 0) {
                alert('All content is already scheduled!');
                return;
            }
            
            const confirmMsg = `This will schedule:\n‚Ä¢ ${unscheduledBlogs.length} blogs (every 3 days)\n‚Ä¢ ${unscheduledSocial.length} social posts (daily)\n\nContinue?`;
            if (!confirm(confirmMsg)) return;
            
            const today = new Date();
            let blogDay = 1;
            let socialDay = 1;
            let errors = 0;
            
            // Schedule blogs
            for (const blog of unscheduledBlogs) {
                const scheduleDate = new Date(today);
                scheduleDate.setDate(scheduleDate.getDate() + (blogDay * 3));
                scheduleDate.setHours(9, 0, 0, 0);
                
                try {
                    const response = await fetch(`${API_URL}/api/content/${blog.id}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${AUTH_TOKEN}`
                        },
                        body: JSON.stringify({
                            status: 'scheduled',
                            scheduled_for: scheduleDate.toISOString()
                        })
                    });
                    
                    if (response.ok) {
                        blog.status = 'scheduled';
                        blog.scheduled_for = scheduleDate.toISOString();
                        blogDay++;
                    } else {
                        errors++;
                    }
                } catch (e) {
                    errors++;
                }
            }
            
            // Schedule social posts
            for (const post of unscheduledSocial) {
                const scheduleDate = new Date(today);
                scheduleDate.setDate(scheduleDate.getDate() + socialDay);
                scheduleDate.setHours(10, 0, 0, 0);
                
                try {
                    const response = await fetch(`${API_URL}/api/social/${post.id}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${AUTH_TOKEN}`
                        },
                        body: JSON.stringify({
                            status: 'scheduled',
                            scheduled_for: scheduleDate.toISOString()
                        })
                    });
                    
                    if (response.ok) {
                        post.status = 'scheduled';
                        post.scheduled_for = scheduleDate.toISOString();
                        socialDay++;
                    } else {
                        errors++;
                    }
                } catch (e) {
                    errors++;
                }
            }
            
            renderCalendar();
            renderBlogs();
            renderSocial();
            
            if (errors > 0) {
                alert(`Scheduled ${blogDay - 1} blogs and ${socialDay - 1} social posts.\n${errors} items failed.`);
            } else {
                alert(`‚úì Scheduled ${blogDay - 1} blogs and ${socialDay - 1} social posts!`);
            }
        }
        
        // Legacy function name
        function autoSchedule() {
            autoScheduleContent();
        }
        
        function showDateContent(dateStr) {
            const items = scheduledContent.filter(c => c.scheduled_date === dateStr);
            if (items.length === 0) {
                alert(`No content scheduled for ${formatDate(dateStr)}\n\nClick on a blog or social post to schedule it.`);
                return;
            }
            
            const content = items.map(i => `‚Ä¢ ${i.type}: ${i.title || i.topic}`).join('\n');
            alert(`Content for ${formatDate(dateStr)}:\n\n${content}`);
        }

        // ==========================================
        // BLOGS
        // ==========================================
        let bulkSelectMode = false;
        let selectedBlogs = new Set();
        
        function toggleBulkSelect() {
            bulkSelectMode = !bulkSelectMode;
            selectedBlogs.clear();
            
            if (bulkSelectMode) {
                document.getElementById('bulkActionBar').classList.remove('hidden');
                document.getElementById('bulkSelectBtn').innerHTML = '<i class="fas fa-times mr-1"></i>Cancel Select';
                document.getElementById('bulkSelectBtn').className = 'px-4 py-2 bg-purple-600 hover:bg-purple-700 text-white rounded-lg text-sm transition';
            } else {
                document.getElementById('bulkActionBar').classList.add('hidden');
                document.getElementById('bulkSelectBtn').innerHTML = '<i class="fas fa-check-square mr-1"></i>Bulk Select';
                document.getElementById('bulkSelectBtn').className = 'px-4 py-2 bg-white/10 hover:bg-white/20 text-gray-300 rounded-lg text-sm transition';
            }
            
            updateSelectedCount();
            renderBlogs();
        }
        
        function cancelBulkSelect() {
            bulkSelectMode = false;
            selectedBlogs.clear();
            document.getElementById('bulkActionBar').classList.add('hidden');
            document.getElementById('bulkSelectBtn').innerHTML = '<i class="fas fa-check-square mr-1"></i>Bulk Select';
            document.getElementById('bulkSelectBtn').className = 'px-4 py-2 bg-white/10 hover:bg-white/20 text-gray-300 rounded-lg text-sm transition';
            renderBlogs();
        }
        
        function toggleBlogSelect(blogId, event) {
            if (event) event.stopPropagation();
            
            if (selectedBlogs.has(blogId)) {
                selectedBlogs.delete(blogId);
            } else {
                selectedBlogs.add(blogId);
            }
            updateSelectedCount();
        }
        
        function toggleSelectAllBlogs() {
            const selectAll = document.getElementById('selectAllBlogs').checked;
            
            if (selectAll) {
                allBlogs.forEach(b => selectedBlogs.add(b.id));
            } else {
                selectedBlogs.clear();
            }
            
            updateSelectedCount();
            renderBlogs();
        }
        
        function updateSelectedCount() {
            document.getElementById('selectedCount').textContent = selectedBlogs.size;
            document.getElementById('selectAllBlogs').checked = selectedBlogs.size === allBlogs.length && allBlogs.length > 0;
        }
        
        async function bulkApproveBlogs() {
            if (selectedBlogs.size === 0) {
                alert('No blogs selected');
                return;
            }
            
            if (!confirm(`Approve ${selectedBlogs.size} blogs?`)) return;
            
            try {
                const response = await fetch(`${API_URL}/api/content/bulk-approve`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${AUTH_TOKEN}`
                    },
                    body: JSON.stringify({ ids: Array.from(selectedBlogs) })
                });
                
                const result = await response.json();
                
                // Update local data
                selectedBlogs.forEach(id => {
                    const blog = allBlogs.find(b => b.id === id);
                    if (blog) blog.status = 'approved';
                });
                
                alert(`‚úì ${result.approved} blogs approved`);
                cancelBulkSelect();
                renderBlogs();
                
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }
        
        async function bulkDeleteBlogs() {
            if (selectedBlogs.size === 0) {
                alert('No blogs selected');
                return;
            }
            
            if (!confirm(`Delete ${selectedBlogs.size} blogs?\n\nThis action cannot be undone.`)) return;
            
            try {
                const response = await fetch(`${API_URL}/api/content/bulk-delete`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${AUTH_TOKEN}`
                    },
                    body: JSON.stringify({ ids: Array.from(selectedBlogs) })
                });
                
                const result = await response.json();
                
                // Remove from local data
                allBlogs = allBlogs.filter(b => !selectedBlogs.has(b.id));
                
                alert(`‚úì ${result.deleted} blogs deleted`);
                cancelBulkSelect();
                renderBlogs();
                updateStats();
                
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }
        
        function renderBlogs() {
            const container = document.getElementById('blogsList');

            if (allBlogs.length === 0) {
                container.innerHTML = `
                    <div class="glass rounded-xl p-12 text-center">
                        <i class="fas fa-file-alt text-4xl text-gray-600 mb-4"></i>
                        <p class="text-gray-400">No blog posts yet</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = allBlogs.map(blog => {
                const statusColors = {
                    'draft': 'bg-gray-500/20 text-gray-300',
                    'scheduled': 'bg-blue-500/20 text-blue-300',
                    'approved': 'bg-green-500/20 text-green-300',
                    'published': 'bg-emerald-500/20 text-emerald-300'
                };
                const scheduledInfo = blog.scheduled_for 
                    ? `<span class="text-blue-400 text-xs"><i class="fas fa-calendar mr-1"></i>${new Date(blog.scheduled_for).toLocaleDateString()}</span>` 
                    : '';
                
                const isSelected = selectedBlogs.has(blog.id);
                const checkbox = bulkSelectMode 
                    ? `<input type="checkbox" ${isSelected ? 'checked' : ''} onclick="toggleBlogSelect('${blog.id}', event)" class="w-5 h-5 rounded mr-3 flex-shrink-0">`
                    : '';
                
                // Featured image thumbnail
                const featuredImage = blog.featured_image_url 
                    ? `<div class="w-20 h-20 rounded-lg overflow-hidden flex-shrink-0 bg-white/5">
                         <img src="${blog.featured_image_url}" alt="" class="w-full h-full object-cover">
                       </div>`
                    : '';
                
                return `
                <div class="content-card glass rounded-xl p-6 ${isSelected ? 'ring-2 ring-purple-500' : ''}">
                    <div class="flex items-start gap-4">
                        ${checkbox}
                        ${featuredImage}
                        <div class="flex-1 cursor-pointer" onclick="${bulkSelectMode ? `toggleBlogSelect('${blog.id}')` : `openBlogModal('${blog.id}')`}">
                            <div class="flex items-center gap-2 mb-2 flex-wrap">
                                <span class="px-2 py-1 bg-purple-500/20 text-purple-300 rounded text-xs font-medium">
                                    ${blog.primary_keyword || 'Blog'}
                                </span>
                                <span class="px-2 py-1 ${statusColors[blog.status] || statusColors.draft} rounded text-xs">
                                    ${blog.status || 'draft'}
                                </span>
                                ${scheduledInfo}
                                ${blog.featured_image_url ? '<span class="text-amber-400 text-xs"><i class="fas fa-image"></i></span>' : ''}
                            </div>
                            <h3 class="text-lg font-semibold text-white mb-2">${blog.title || 'Untitled'}</h3>
                            <p class="text-gray-400 text-sm line-clamp-2">${blog.meta_description || ''}</p>
                        </div>
                        <div class="text-right">
                            <p class="text-2xl font-bold gradient-text">${blog.word_count || 0}</p>
                            <p class="text-xs text-gray-500">words</p>
                        </div>
                    </div>
                    ${!bulkSelectMode ? `
                    <div class="flex items-center justify-between mt-4 pt-4 border-t border-white/10">
                        <div class="flex items-center gap-4 text-sm text-gray-500">
                            <span><i class="fas fa-link mr-1"></i>${countInternalLinks(blog.body)} links</span>
                            <span><i class="fas fa-question-circle mr-1"></i>${blog.faq_content?.length || 0} FAQs</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <button onclick="event.stopPropagation(); openBlogModal('${blog.id}')" class="p-2 text-gray-400 hover:text-white hover:bg-white/10 rounded-lg transition" title="View">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button onclick="event.stopPropagation(); quickEditBlog('${blog.id}')" class="p-2 text-gray-400 hover:text-blue-400 hover:bg-blue-500/10 rounded-lg transition" title="Edit">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button onclick="event.stopPropagation(); quickDeleteBlog('${blog.id}', '${(blog.title || '').replace(/'/g, "\\'")}')" class="p-2 text-gray-400 hover:text-red-400 hover:bg-red-500/10 rounded-lg transition" title="Delete">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                    ` : ''}
                </div>
            `}).join('');
        }
        
        function quickEditBlog(blogId) {
            openBlogModal(blogId);
            // Wait for modal to open then enter edit mode
            setTimeout(() => enterEditMode(), 100);
        }
        
        function quickDeleteBlog(blogId, title) {
            if (confirm(`Delete "${title}"?\n\nThis action cannot be undone.`)) {
                deleteBlogById(blogId);
            }
        }
        
        async function deleteBlogById(blogId) {
            try {
                const response = await fetch(`${API_URL}/api/content/${blogId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${AUTH_TOKEN}`
                    }
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Failed to delete');
                }
                
                allBlogs = allBlogs.filter(b => b.id !== blogId);
                renderBlogs();
                updateStats();
                
            } catch (error) {
                console.error('Delete error:', error);
                alert('Error: ' + error.message);
            }
        }

        function countInternalLinks(body) {
            if (!body) return 0;
            const matches = body.match(/<a[^>]*href=[^>]*>/gi);
            return matches ? matches.length : 0;
        }
        
        function calculateSEOScore(blog) {
            if (!blog) return { score: 0, checks: {} };
            
            const checks = {};
            let score = 0;
            
            // Word count (20 points) - target 1800+
            const wordCount = blog.word_count || 0;
            checks.wordCount = wordCount >= 1500;
            if (wordCount >= 1800) score += 20;
            else if (wordCount >= 1500) score += 17;
            else if (wordCount >= 1200) score += 12;
            else if (wordCount >= 800) score += 7;
            else if (wordCount >= 500) score += 3;
            
            // Keyword density (15 points) - target 1-2%
            const body = blog.body || '';
            const bodyText = body.replace(/<[^>]*>/g, '').toLowerCase();
            const keyword = (blog.primary_keyword || '').toLowerCase();
            if (keyword && bodyText) {
                const keywordCount = (bodyText.match(new RegExp(keyword.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), 'g')) || []).length;
                const totalWords = bodyText.split(/\s+/).filter(w => w.length > 0).length;
                const density = totalWords > 0 ? (keywordCount / totalWords) * 100 : 0;
                checks.keywordDensity = density >= 0.5 && density <= 3;
                if (density >= 1 && density <= 2) score += 15;
                else if (density >= 0.5 && density <= 3) score += 10;
                else if (density > 0) score += 5;
            } else {
                checks.keywordDensity = false;
            }
            
            // Internal links (15 points) - target 5+
            const linkCount = countInternalLinks(body);
            checks.internalLinks = linkCount >= 3;
            if (linkCount >= 6) score += 15;
            else if (linkCount >= 4) score += 12;
            else if (linkCount >= 2) score += 8;
            else if (linkCount >= 1) score += 4;
            
            // Meta title (15 points) - target 50-60 chars with keyword
            const metaTitle = blog.meta_title || '';
            const titleLen = metaTitle.length;
            const titleHasKeyword = keyword && metaTitle.toLowerCase().includes(keyword);
            checks.metaTitle = titleLen >= 50 && titleLen <= 60 && titleHasKeyword;
            if (titleLen >= 50 && titleLen <= 60) score += 8;
            else if (titleLen >= 40 && titleLen <= 70) score += 5;
            if (titleHasKeyword) score += 7;
            
            // Meta description (15 points) - target 150-160 chars
            const metaDesc = blog.meta_description || '';
            const descLen = metaDesc.length;
            const descHasKeyword = keyword && metaDesc.toLowerCase().includes(keyword);
            checks.metaDesc = descLen >= 150 && descLen <= 160 && descHasKeyword;
            if (descLen >= 150 && descLen <= 160) score += 8;
            else if (descLen >= 120 && descLen <= 180) score += 5;
            if (descHasKeyword) score += 7;
            
            // Heading structure (20 points) - H2s and H3s with location
            const h2Count = (body.match(/<h2/gi) || []).length;
            const h3Count = (body.match(/<h3/gi) || []).length;
            checks.headings = h2Count >= 4 && h3Count >= 3;
            if (h2Count >= 5) score += 10;
            else if (h2Count >= 4) score += 8;
            else if (h2Count >= 3) score += 6;
            else if (h2Count >= 2) score += 4;
            if (h3Count >= 4) score += 10;
            else if (h3Count >= 3) score += 8;
            else if (h3Count >= 2) score += 6;
            else if (h3Count >= 1) score += 3;
            
            return { score: Math.min(100, score), checks };
        }
        
        function updateSEOScoreDisplay(seoResult) {
            const { score, checks } = seoResult;
            
            // Update score value and bar
            const scoreValueEl = document.getElementById('seoScoreValue');
            const scoreBarEl = document.getElementById('seoScoreBar');
            
            if (scoreValueEl) scoreValueEl.textContent = score;
            if (scoreBarEl) scoreBarEl.style.width = `${score}%`;
            
            // Update color based on score
            const scoreEl = document.getElementById('seoScoreValue');
            const barEl = document.getElementById('seoScoreBar');
            if (scoreEl && barEl) {
                if (score >= 80) {
                    scoreEl.className = 'text-3xl font-bold text-green-400';
                    barEl.className = 'bg-gradient-to-r from-green-500 to-emerald-400 h-2 rounded-full transition-all';
                } else if (score >= 60) {
                    scoreEl.className = 'text-3xl font-bold text-yellow-400';
                    barEl.className = 'bg-gradient-to-r from-yellow-500 to-orange-400 h-2 rounded-full transition-all';
                } else {
                    scoreEl.className = 'text-3xl font-bold text-red-400';
                    barEl.className = 'bg-gradient-to-r from-red-500 to-orange-400 h-2 rounded-full transition-all';
                }
            }
            
            // Update check indicators
            const updateCheck = (id, passed) => {
                const el = document.getElementById(id);
                if (!el) return;
                const icon = el.querySelector('i');
                if (!icon) return;
                if (passed) {
                    icon.className = 'fas fa-check-circle text-green-400';
                } else {
                    icon.className = 'fas fa-times-circle text-red-400';
                }
            };
            
            updateCheck('seoWordCount', checks.wordCount);
            updateCheck('seoKeywordDensity', checks.keywordDensity);
            updateCheck('seoInternalLinks', checks.internalLinks);
            updateCheck('seoMetaTitle', checks.metaTitle);
            updateCheck('seoMetaDesc', checks.metaDesc);
            updateCheck('seoHeadings', checks.headings);
        }

        let currentBlog = null;

        function openBlogModal(blogId) {
            currentBlog = allBlogs.find(b => b.id === blogId);
            if (!currentBlog) return;

            document.getElementById('modalKeyword').textContent = currentBlog.primary_keyword || '';
            document.getElementById('modalTitle').textContent = currentBlog.title || 'Untitled';
            document.getElementById('modalWordCount').textContent = currentBlog.word_count || 0;
            document.getElementById('modalLinkCount').textContent = countInternalLinks(currentBlog.body);
            document.getElementById('modalStatus').textContent = currentBlog.status || 'draft';
            document.getElementById('modalMetaTitle').textContent = currentBlog.meta_title || '';
            document.getElementById('modalMetaDesc').textContent = currentBlog.meta_description || '';
            document.getElementById('modalBody').innerHTML = DOMPurify.sanitize(currentBlog.body || '');
            
            // Featured Image
            const imagePreview = document.getElementById('featuredImagePreview');
            const imageEmpty = document.getElementById('featuredImageEmpty');
            const imageLoading = document.getElementById('featuredImageLoading');
            
            imageLoading.classList.add('hidden');
            
            if (currentBlog.featured_image_url) {
                document.getElementById('modalFeaturedImage').src = currentBlog.featured_image_url;
                imagePreview.classList.remove('hidden');
                imageEmpty.classList.add('hidden');
            } else {
                imagePreview.classList.add('hidden');
                imageEmpty.classList.remove('hidden');
            }
            
            // Calculate and display SEO score
            const seoResult = calculateSEOScore(currentBlog);
            updateSEOScoreDisplay(seoResult);

            // FAQs
            const faqSection = document.getElementById('modalFaq');
            const faqContent = document.getElementById('faqContent');
            if (currentBlog.faq_content && currentBlog.faq_content.length > 0) {
                faqSection.classList.remove('hidden');
                faqContent.innerHTML = currentBlog.faq_content.map(faq => `
                    <div class="bg-gray-50 rounded-lg p-4">
                        <p class="font-semibold text-gray-800 mb-2">${faq.question || faq.q || ''}</p>
                        <p class="text-gray-600">${faq.answer || faq.a || ''}</p>
                    </div>
                `).join('');
            } else {
                faqSection.classList.add('hidden');
            }

            document.getElementById('blogModal').classList.remove('hidden');
            document.body.style.overflow = 'hidden';
        }

        function closeBlogModal() {
            document.getElementById('blogModal').classList.add('hidden');
            document.body.style.overflow = '';
        }
        
        async function generateBlogImage() {
            if (!currentBlog) return;
            
            const btn = document.getElementById('btnGenerateBlogImage');
            const imagePreview = document.getElementById('featuredImagePreview');
            const imageEmpty = document.getElementById('featuredImageEmpty');
            const imageLoading = document.getElementById('featuredImageLoading');
            
            btn.disabled = true;
            imageEmpty.classList.add('hidden');
            imagePreview.classList.add('hidden');
            imageLoading.classList.remove('hidden');
            
            try {
                // Generate image based on blog keyword/title
                const prompt = `${currentBlog.primary_keyword || currentBlog.title} - professional blog header image`;
                
                const response = await fetch(`${API_URL}/api/images/generate`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${AUTH_TOKEN}`
                    },
                    body: JSON.stringify({
                        prompt: prompt,
                        style: 'blog_header',
                        size: '1792x1024',
                        client_id: currentClient?.id
                    })
                });
                
                const result = await response.json();
                
                if (result.success && result.url) {
                    // Update blog with featured image
                    const updateResponse = await fetch(`${API_URL}/api/content/blog/${currentBlog.id}`, {
                        method: 'PATCH',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${AUTH_TOKEN}`
                        },
                        body: JSON.stringify({
                            featured_image_url: result.url
                        })
                    });
                    
                    if (updateResponse.ok) {
                        // Update UI
                        currentBlog.featured_image_url = result.url;
                        document.getElementById('modalFeaturedImage').src = result.url;
                        imagePreview.classList.remove('hidden');
                        
                        // Update the blog in allBlogs array
                        const blogIndex = allBlogs.findIndex(b => b.id === currentBlog.id);
                        if (blogIndex >= 0) {
                            allBlogs[blogIndex].featured_image_url = result.url;
                            renderBlogs(); // Refresh the list
                        }
                    }
                } else {
                    alert('Image generation failed: ' + (result.error || 'No image providers configured'));
                    imageEmpty.classList.remove('hidden');
                }
            } catch (error) {
                alert('Error generating image: ' + error.message);
                imageEmpty.classList.remove('hidden');
            } finally {
                btn.disabled = false;
                imageLoading.classList.add('hidden');
            }
        }
        
        async function removeFeaturedImage() {
            if (!currentBlog) return;
            
            if (!confirm('Remove the featured image from this blog post?')) return;
            
            try {
                const response = await fetch(`${API_URL}/api/content/blog/${currentBlog.id}`, {
                    method: 'PATCH',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${AUTH_TOKEN}`
                    },
                    body: JSON.stringify({
                        featured_image_url: null
                    })
                });
                
                if (response.ok) {
                    currentBlog.featured_image_url = null;
                    document.getElementById('featuredImagePreview').classList.add('hidden');
                    document.getElementById('featuredImageEmpty').classList.remove('hidden');
                    
                    // Update the blog in allBlogs array
                    const blogIndex = allBlogs.findIndex(b => b.id === currentBlog.id);
                    if (blogIndex >= 0) {
                        allBlogs[blogIndex].featured_image_url = null;
                        renderBlogs();
                    }
                }
            } catch (error) {
                alert('Error removing image: ' + error.message);
            }
        }

        function copyBlogContent() {
            if (!currentBlog) return;
            const content = `${currentBlog.title}\n\n${currentBlog.body?.replace(/<[^>]*>/g, '')}`;
            navigator.clipboard.writeText(content);
            alert('Content copied to clipboard!');
        }

        function downloadBlog() {
            if (!currentBlog) return;
            const content = `# ${currentBlog.title}\n\n${currentBlog.body?.replace(/<[^>]*>/g, '')}`;
            const blob = new Blob([content], { type: 'text/markdown' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${currentBlog.title?.replace(/[^a-z0-9]/gi, '-').toLowerCase() || 'blog'}.md`;
            a.click();
        }
        
        // Helper to escape HTML attributes
        function escapeHtml(str) {
            if (!str) return '';
            return str.replace(/&/g, '&amp;')
                     .replace(/</g, '&lt;')
                     .replace(/>/g, '&gt;')
                     .replace(/"/g, '&quot;')
                     .replace(/'/g, '&#39;');
        }
        
        function downloadBlogHTML() {
            if (!currentBlog) return;
            
            const safeTitle = escapeHtml(currentBlog.meta_title || currentBlog.title);
            const safeDesc = escapeHtml(currentBlog.meta_description || '');
            
            const html = `<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>${safeTitle}</title>
    <meta name="description" content="${safeDesc}">
    <style>
        body { font-family: system-ui, sans-serif; max-width: 800px; margin: 0 auto; padding: 2rem; line-height: 1.6; color: #333; }
        h1 { color: #1a1a1a; margin-bottom: 0.5rem; }
        h2 { color: #2a2a2a; margin-top: 2rem; }
        h3 { color: #3a3a3a; margin-top: 1.5rem; }
        a { color: #6366f1; }
        .meta { color: #666; font-size: 0.9rem; margin-bottom: 2rem; padding-bottom: 1rem; border-bottom: 1px solid #eee; }
        .faq { background: #f9fafb; padding: 1.5rem; border-radius: 8px; margin-top: 2rem; }
        .faq h3 { margin-top: 0; }
        .faq-item { margin-bottom: 1rem; }
        .faq-q { font-weight: 600; color: #1a1a1a; }
        .faq-a { color: #4a4a4a; margin-top: 0.25rem; }
    </style>
</head>
<body>
    <article>
        <h1>${currentBlog.title}</h1>
        <div class="meta">
            <strong>Keyword:</strong> ${escapeHtml(currentBlog.primary_keyword || '')} | 
            <strong>Words:</strong> ${currentBlog.word_count || 0}
        </div>
        ${currentBlog.body || ''}
        ${currentBlog.faq_content?.length > 0 ? `
        <div class="faq">
            <h3>Frequently Asked Questions</h3>
            ${currentBlog.faq_content.map(faq => `
            <div class="faq-item">
                <p class="faq-q">${escapeHtml(faq.question || faq.q)}</p>
                <p class="faq-a">${escapeHtml(faq.answer || faq.a)}</p>
            </div>
            `).join('')}
        </div>
        ` : ''}
    </article>
</body>
</html>`;
            
            const blob = new Blob([html], { type: 'text/html' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${currentBlog.title?.replace(/[^a-z0-9]/gi, '-').toLowerCase() || 'blog'}.html`;
            a.click();
        }
        
        function downloadBlogWord() {
            if (!currentBlog) return;
            
            // Create Word-compatible HTML
            const safeTitle = escapeHtml(currentBlog.title);
            const safeKeyword = escapeHtml(currentBlog.primary_keyword || '');
            const safeMetaTitle = escapeHtml(currentBlog.meta_title || '');
            const safeMetaDesc = escapeHtml(currentBlog.meta_description || '');
            
            const wordDoc = `
<html xmlns:o='urn:schemas-microsoft-com:office:office' xmlns:w='urn:schemas-microsoft-com:office:word'>
<head>
    <meta charset="UTF-8">
    <title>${safeTitle}</title>
    <style>
        body { font-family: Calibri, sans-serif; font-size: 11pt; line-height: 1.5; }
        h1 { font-size: 24pt; color: #1a1a1a; margin-bottom: 12pt; }
        h2 { font-size: 16pt; color: #2a2a2a; margin-top: 18pt; margin-bottom: 6pt; }
        h3 { font-size: 13pt; color: #3a3a3a; margin-top: 12pt; margin-bottom: 6pt; }
        p { margin-bottom: 10pt; }
        a { color: #0563C1; }
        .meta { color: #666; font-size: 10pt; border-bottom: 1pt solid #ccc; padding-bottom: 12pt; margin-bottom: 18pt; }
        .faq { background: #f5f5f5; padding: 12pt; margin-top: 24pt; }
        .faq-q { font-weight: bold; margin-bottom: 3pt; }
        .faq-a { margin-bottom: 12pt; color: #444; }
    </style>
</head>
<body>
    <h1>${safeTitle}</h1>
    <div class="meta">
        <b>Target Keyword:</b> ${safeKeyword}<br>
        <b>Meta Title:</b> ${safeMetaTitle}<br>
        <b>Meta Description:</b> ${safeMetaDesc}<br>
        <b>Word Count:</b> ${currentBlog.word_count || 0}
    </div>
    ${currentBlog.body || ''}
    ${currentBlog.faq_content?.length > 0 ? `
    <div class="faq">
        <h2>Frequently Asked Questions</h2>
        ${currentBlog.faq_content.map(faq => `
        <p class="faq-q">${escapeHtml(faq.question || faq.q)}</p>
        <p class="faq-a">${escapeHtml(faq.answer || faq.a)}</p>
        `).join('')}
    </div>
    ` : ''}
</body>
</html>`;
            
            const blob = new Blob([wordDoc], { type: 'application/msword' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${currentBlog.title?.replace(/[^a-z0-9]/gi, '-').toLowerCase() || 'blog'}.doc`;
            a.click();
        }
        
        // ==========================================
        // BLOG EDIT/DELETE/SCHEDULE
        // ==========================================
        let isEditMode = false;
        
        function enterEditMode() {
            if (!currentBlog) return;
            isEditMode = true;
            
            // Show edit fields, hide view fields
            document.getElementById('modalTitle').classList.add('hidden');
            document.getElementById('modalTitleEdit').classList.remove('hidden');
            document.getElementById('modalTitleEdit').value = currentBlog.title || '';
            
            document.getElementById('metaViewMode').classList.add('hidden');
            document.getElementById('metaEditMode').classList.remove('hidden');
            document.getElementById('modalMetaTitleEdit').value = currentBlog.meta_title || '';
            document.getElementById('modalMetaDescEdit').value = currentBlog.meta_description || '';
            updateMetaCounts();
            
            document.getElementById('modalBody').classList.add('hidden');
            document.getElementById('bodyEditMode').classList.remove('hidden');
            document.getElementById('modalBodyEdit').value = currentBlog.body || '';
            updateEditWordCount();
            
            document.getElementById('footerViewMode').classList.add('hidden');
            document.getElementById('footerEditMode').classList.remove('hidden');
            
            // Hide SEO card in edit mode
            document.getElementById('seoScoreCard').classList.add('hidden');
        }
        
        function cancelEditMode() {
            isEditMode = false;
            
            // Restore view mode
            document.getElementById('modalTitle').classList.remove('hidden');
            document.getElementById('modalTitleEdit').classList.add('hidden');
            
            document.getElementById('metaViewMode').classList.remove('hidden');
            document.getElementById('metaEditMode').classList.add('hidden');
            
            document.getElementById('modalBody').classList.remove('hidden');
            document.getElementById('bodyEditMode').classList.add('hidden');
            
            document.getElementById('footerViewMode').classList.remove('hidden');
            document.getElementById('footerEditMode').classList.add('hidden');
            
            document.getElementById('seoScoreCard').classList.remove('hidden');
        }
        
        function updateMetaCounts() {
            const titleLen = document.getElementById('modalMetaTitleEdit').value.length;
            const descLen = document.getElementById('modalMetaDescEdit').value.length;
            document.getElementById('metaTitleCount').textContent = `(${titleLen}/60)`;
            document.getElementById('metaDescCount').textContent = `(${descLen}/160)`;
            document.getElementById('metaTitleCount').className = titleLen > 60 ? 'text-xs text-red-500' : 'text-xs text-gray-500';
            document.getElementById('metaDescCount').className = descLen > 160 ? 'text-xs text-red-500' : 'text-xs text-gray-500';
        }
        
        function updateEditWordCount() {
            const text = document.getElementById('modalBodyEdit').value.replace(/<[^>]*>/g, ' ');
            const words = text.split(/\s+/).filter(w => w.length > 0).length;
            document.getElementById('editWordCount').textContent = words.toLocaleString();
        }
        
        // Add event listeners for edit fields
        document.addEventListener('DOMContentLoaded', function() {
            const metaTitle = document.getElementById('modalMetaTitleEdit');
            const metaDesc = document.getElementById('modalMetaDescEdit');
            const bodyEdit = document.getElementById('modalBodyEdit');
            
            if (metaTitle) metaTitle.addEventListener('input', updateMetaCounts);
            if (metaDesc) metaDesc.addEventListener('input', updateMetaCounts);
            if (bodyEdit) bodyEdit.addEventListener('input', updateEditWordCount);
        });
        
        async function saveBlogEdits() {
            if (!currentBlog) return;
            
            const newTitle = document.getElementById('modalTitleEdit').value.trim();
            const newMetaTitle = document.getElementById('modalMetaTitleEdit').value.trim();
            const newMetaDesc = document.getElementById('modalMetaDescEdit').value.trim();
            const newBody = document.getElementById('modalBodyEdit').value;
            
            if (!newTitle) {
                alert('Title is required');
                return;
            }
            
            try {
                const response = await fetch(`${API_URL}/api/content/${currentBlog.id}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${AUTH_TOKEN}`
                    },
                    body: JSON.stringify({
                        title: newTitle,
                        meta_title: newMetaTitle,
                        meta_description: newMetaDesc,
                        body: newBody
                    })
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Failed to save');
                }
                
                const result = await response.json();
                
                // Update local data
                const idx = allBlogs.findIndex(b => b.id === currentBlog.id);
                if (idx !== -1) {
                    allBlogs[idx] = result.content;
                }
                currentBlog = result.content;
                
                // Exit edit mode and refresh display
                cancelEditMode();
                
                // Update modal display
                document.getElementById('modalTitle').textContent = currentBlog.title;
                document.getElementById('modalMetaTitle').textContent = currentBlog.meta_title || '';
                document.getElementById('modalMetaDesc').textContent = currentBlog.meta_description || '';
                document.getElementById('modalBody').innerHTML = DOMPurify.sanitize(currentBlog.body || '');
                document.getElementById('modalWordCount').textContent = currentBlog.word_count || 0;
                
                // Recalculate SEO score
                calculateSEOScore(currentBlog);
                
                // Refresh blog list
                renderBlogs();
                
                alert('‚úì Blog saved successfully!');
                
            } catch (error) {
                console.error('Save error:', error);
                alert('Error: ' + error.message);
            }
        }
        
        function confirmDeleteBlog() {
            if (!currentBlog) return;
            
            if (confirm(`Are you sure you want to delete "${currentBlog.title}"?\n\nThis action cannot be undone.`)) {
                deleteBlog();
            }
        }
        
        async function deleteBlog() {
            if (!currentBlog) return;
            
            try {
                const response = await fetch(`${API_URL}/api/content/${currentBlog.id}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${AUTH_TOKEN}`
                    }
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Failed to delete');
                }
                
                // Remove from local array
                allBlogs = allBlogs.filter(b => b.id !== currentBlog.id);
                
                // Close modal and refresh
                closeBlogModal();
                renderBlogs();
                updateStats();
                
                alert('‚úì Blog deleted successfully');
                
            } catch (error) {
                console.error('Delete error:', error);
                alert('Error: ' + error.message);
            }
        }
        
        async function approveBlog() {
            if (!currentBlog) return;
            
            try {
                const response = await fetch(`${API_URL}/api/content/${currentBlog.id}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${AUTH_TOKEN}`
                    },
                    body: JSON.stringify({
                        status: 'approved'
                    })
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Failed to approve');
                }
                
                const result = await response.json();
                
                // Update local data
                const idx = allBlogs.findIndex(b => b.id === currentBlog.id);
                if (idx !== -1) {
                    allBlogs[idx].status = 'approved';
                }
                currentBlog.status = 'approved';
                
                // Update modal status display
                document.getElementById('modalStatus').textContent = 'Approved';
                document.getElementById('modalStatus').className = 'px-2 py-1 bg-green-500/30 text-green-300 rounded';
                
                // Refresh blog list
                renderBlogs();
                
                alert('‚úì Blog approved!');
                
            } catch (error) {
                console.error('Approve error:', error);
                alert('Error: ' + error.message);
            }
        }
        
        async function publishToWordPress() {
            if (!currentBlog) return;
            
            // Check if WordPress is configured
            if (!currentClient?.wordpress_url) {
                alert('WordPress not configured for this client.\n\nGo to Edit Client ‚Üí WordPress Integration to add your WordPress credentials.');
                return;
            }
            
            const status = currentBlog.status === 'approved' || currentBlog.status === 'published' 
                ? 'publish' 
                : 'draft';
            
            const confirmMsg = status === 'publish'
                ? `Publish "${currentBlog.title}" to WordPress?\n\nThis will publish the blog immediately on your WordPress site.`
                : `Save "${currentBlog.title}" as draft on WordPress?\n\nApprove the blog first to publish it directly.`;
            
            if (!confirm(confirmMsg)) return;
            
            // Find the WordPress button and show loading state
            const wpButtons = document.querySelectorAll('[onclick*="publishToWordPress"]');
            wpButtons.forEach(btn => setButtonLoading(btn, true, 'Publishing...'));
            
            try {
                const response = await fetch(`${API_URL}/api/content/${currentBlog.id}/publish-wordpress`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${AUTH_TOKEN}`
                    },
                    body: JSON.stringify({ status })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    // Update local data
                    if (result.post_id) {
                        currentBlog.wordpress_post_id = result.post_id;
                        const idx = allBlogs.findIndex(b => b.id === currentBlog.id);
                        if (idx !== -1) {
                            allBlogs[idx].wordpress_post_id = result.post_id;
                            if (result.blog_status) {
                                allBlogs[idx].status = result.blog_status;
                            }
                        }
                    }
                    
                    let msg = `‚úì ${result.message}`;
                    if (result.post_url) {
                        msg += `\n\nView post: ${result.post_url}`;
                    }
                    alert(msg);
                    
                    // Update status if published
                    if (status === 'publish') {
                        document.getElementById('modalStatus').textContent = 'Published';
                        document.getElementById('modalStatus').className = 'px-2 py-1 bg-emerald-500/30 text-emerald-300 rounded';
                        currentBlog.status = 'published';
                        renderBlogs();
                    }
                    
                } else {
                    alert(`‚ùå WordPress Error: ${result.message}`);
                }
                
            } catch (error) {
                console.error('WordPress publish error:', error);
                alert('Error: ' + error.message);
            } finally {
                // Reset loading state
                const wpButtons = document.querySelectorAll('[onclick*="publishToWordPress"]');
                wpButtons.forEach(btn => setButtonLoading(btn, false));
            }
        }
        
        // Schedule Modal
        function showScheduleModal() {
            if (!currentBlog) return;
            
            // Set default date to tomorrow
            const tomorrow = new Date();
            tomorrow.setDate(tomorrow.getDate() + 1);
            document.getElementById('scheduleDate').value = tomorrow.toISOString().split('T')[0];
            document.getElementById('scheduleTime').value = '09:00';
            
            document.getElementById('scheduleModal').classList.remove('hidden');
        }
        
        function closeScheduleModal() {
            document.getElementById('scheduleModal').classList.add('hidden');
        }
        
        async function saveSchedule() {
            if (!currentBlog) return;
            
            const date = document.getElementById('scheduleDate').value;
            const time = document.getElementById('scheduleTime').value;
            
            if (!date) {
                alert('Please select a date');
                return;
            }
            
            const scheduledFor = new Date(`${date}T${time || '09:00'}:00`);
            
            try {
                const response = await fetch(`${API_URL}/api/content/${currentBlog.id}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${AUTH_TOKEN}`
                    },
                    body: JSON.stringify({
                        status: 'scheduled',
                        scheduled_for: scheduledFor.toISOString()
                    })
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Failed to schedule');
                }
                
                // Update local data
                const idx = allBlogs.findIndex(b => b.id === currentBlog.id);
                if (idx !== -1) {
                    allBlogs[idx].status = 'scheduled';
                    allBlogs[idx].scheduled_for = scheduledFor.toISOString();
                }
                currentBlog.status = 'scheduled';
                currentBlog.scheduled_for = scheduledFor.toISOString();
                
                closeScheduleModal();
                
                // Update modal status
                document.getElementById('modalStatus').textContent = `Scheduled: ${scheduledFor.toLocaleDateString()}`;
                document.getElementById('modalStatus').className = 'px-2 py-1 bg-blue-500/30 text-blue-300 rounded';
                
                renderBlogs();
                renderCalendar();
                
                alert(`‚úì Scheduled for ${scheduledFor.toLocaleDateString()} at ${scheduledFor.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}`);
                
            } catch (error) {
                console.error('Schedule error:', error);
                alert('Error: ' + error.message);
            }
        }
        
        // Legacy function for backwards compatibility
        function publishBlog() {
            approveBlog();
        }

        // ==========================================
        // SOCIAL
        // ==========================================
        let socialFilter = 'all';

        function renderSocial() {
            const container = document.getElementById('socialList');

            // Update counts
            document.getElementById('countAll').textContent = allSocial.length;
            document.getElementById('countGbp').textContent = allSocial.filter(s => s.platform === 'gbp').length;
            document.getElementById('countFacebook').textContent = allSocial.filter(s => s.platform === 'facebook').length;

            const filtered = socialFilter === 'all' ? allSocial : allSocial.filter(s => s.platform === socialFilter);

            if (filtered.length === 0) {
                container.innerHTML = `
                    <div class="glass rounded-xl p-12 text-center col-span-2">
                        <i class="fas fa-share-alt text-4xl text-gray-600 mb-4"></i>
                        <p class="text-gray-400">No social posts yet</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = filtered.map(post => {
                const statusColors = {
                    'draft': 'bg-gray-500/20 text-gray-300',
                    'scheduled': 'bg-blue-500/20 text-blue-300',
                    'approved': 'bg-green-500/20 text-green-300',
                    'published': 'bg-emerald-500/20 text-emerald-300'
                };
                const scheduledInfo = post.scheduled_for 
                    ? `<span class="text-xs text-blue-400"><i class="fas fa-calendar mr-1"></i>${new Date(post.scheduled_for).toLocaleDateString()}</span>` 
                    : '';
                
                return `
                <div class="glass rounded-xl p-4 social-${post.platform}">
                    <div class="flex items-center gap-2 mb-3">
                        ${getPlatformIcon(post.platform)}
                        <span class="text-sm font-medium text-white">${getPlatformName(post.platform)}</span>
                        <span class="ml-auto px-2 py-1 ${statusColors[post.status] || statusColors.draft} rounded text-xs">
                            ${post.status || 'draft'}
                        </span>
                    </div>
                    <p class="text-gray-300 text-sm mb-3">${post.content || ''}</p>
                    ${post.hashtags?.length > 0 ? `
                        <div class="flex flex-wrap gap-1 mb-3">
                            ${post.hashtags.map(h => `<span class="text-xs text-purple-400">#${h}</span>`).join(' ')}
                        </div>
                    ` : ''}
                    <div class="flex items-center justify-between pt-3 border-t border-white/10">
                        ${scheduledInfo}
                        <div class="flex items-center gap-1 ml-auto">
                            <button onclick="copySocialPost('${post.id}')" class="p-1.5 text-gray-400 hover:text-white hover:bg-white/10 rounded transition" title="Copy">
                                <i class="fas fa-copy text-xs"></i>
                            </button>
                            <button onclick="deleteSocialPost('${post.id}')" class="p-1.5 text-gray-400 hover:text-red-400 hover:bg-red-500/10 rounded transition" title="Delete">
                                <i class="fas fa-trash text-xs"></i>
                            </button>
                        </div>
                    </div>
                </div>
            `}).join('');
        }
        
        function copySocialPost(postId) {
            const post = allSocial.find(p => p.id === postId);
            if (!post) return;
            
            let text = post.content || '';
            if (post.hashtags?.length > 0) {
                text += '\n\n' + post.hashtags.map(h => '#' + h).join(' ');
            }
            
            navigator.clipboard.writeText(text);
            alert('‚úì Copied to clipboard!');
        }
        
        async function deleteSocialPost(postId) {
            if (!confirm('Delete this social post?')) return;
            
            try {
                const response = await fetch(`${API_URL}/api/social/${postId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${AUTH_TOKEN}`
                    }
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Failed to delete');
                }
                
                allSocial = allSocial.filter(s => s.id !== postId);
                renderSocial();
                updateStats();
                
            } catch (error) {
                console.error('Delete error:', error);
                alert('Error: ' + error.message);
            }
        }

        function filterSocial(filter) {
            socialFilter = filter;
            ['all', 'gbp', 'facebook'].forEach(f => {
                document.getElementById(`social-${f}`).classList.remove('border-2', 'border-purple-500');
            });
            document.getElementById(`social-${filter}`).classList.add('border-2', 'border-purple-500');
            renderSocial();
        }

        function getPlatformIcon(platform) {
            const icons = {
                'gbp': '<i class="fab fa-google text-blue-400"></i>',
                'facebook': '<i class="fab fa-facebook text-blue-500"></i>',
                'instagram': '<i class="fab fa-instagram text-pink-500"></i>'
            };
            return icons[platform] || '<i class="fas fa-share-alt text-gray-400"></i>';
        }

        function getPlatformName(platform) {
            const names = { 'gbp': 'Google Business', 'facebook': 'Facebook', 'instagram': 'Instagram' };
            return names[platform] || platform;
        }

        // ==========================================
        // SEO
        // ==========================================
        function renderSEO() {
            // Keywords
            const keywordsEl = document.getElementById('keywordsList');
            const allKeywords = [...(currentClient?.primary_keywords || []), ...(currentClient?.secondary_keywords || [])];
            keywordsEl.innerHTML = allKeywords.length > 0 
                ? allKeywords.map((k, i) => `
                    <div class="flex items-center gap-2 p-2 rounded-lg ${i < (currentClient?.primary_keywords?.length || 0) ? 'bg-purple-500/20' : 'bg-white/5'}">
                        <span class="text-sm text-gray-300">${k}</span>
                        ${i < (currentClient?.primary_keywords?.length || 0) ? '<span class="ml-auto text-xs text-purple-400">Primary</span>' : ''}
                    </div>
                `).join('')
                : '<p class="text-gray-500 text-sm">No keywords defined</p>';

            // Competitors
            const compsEl = document.getElementById('competitorsList');
            compsEl.innerHTML = currentClient?.competitors?.length > 0
                ? currentClient.competitors.map(c => `
                    <div class="flex items-center gap-2 p-2 rounded-lg bg-white/5">
                        <i class="fas fa-globe text-orange-400"></i>
                        <span class="text-sm text-gray-300">${c}</span>
                    </div>
                `).join('')
                : '<p class="text-gray-500 text-sm">No competitors defined</p>';

            // Service Pages
            const servicesEl = document.getElementById('servicePagesList');
            servicesEl.innerHTML = currentClient?.service_pages?.length > 0
                ? currentClient.service_pages.map(s => `
                    <div class="flex items-center gap-2 p-2 rounded-lg bg-white/5">
                        <i class="fas fa-link text-green-400"></i>
                        <div class="flex-1">
                            <span class="text-sm text-gray-300">${s.title || s.keyword}</span>
                            <span class="text-xs text-gray-500 block">${s.url}</span>
                        </div>
                    </div>
                `).join('')
                : '<p class="text-gray-500 text-sm">No service pages defined</p>';

            // USPs
            const uspsEl = document.getElementById('uspsList');
            uspsEl.innerHTML = currentClient?.unique_selling_points?.length > 0
                ? currentClient.unique_selling_points.map(u => `
                    <div class="flex items-center gap-2 p-2 rounded-lg bg-white/5">
                        <i class="fas fa-star text-yellow-400"></i>
                        <span class="text-sm text-gray-300">${u}</span>
                    </div>
                `).join('')
                : '<p class="text-gray-500 text-sm">No USPs defined</p>';
            
            // Load competitor insights
            loadCompetitorInsights();
        }
        
        async function loadCompetitorInsights() {
            const table = document.getElementById('competitorInsightsTable');
            if (!table) return;
            
            if (!currentClient) {
                table.innerHTML = '<tr><td colspan="4" class="text-center py-4 text-gray-500">Select a client to view insights</td></tr>';
                return;
            }
            
            // Generate sample insights based on client keywords
            const keywords = currentClient.primary_keywords || [];
            const geo = currentClient.geo || '';
            
            if (keywords.length === 0) {
                table.innerHTML = '<tr><td colspan="4" class="text-center py-4 text-gray-500">No keywords to analyze</td></tr>';
                return;
            }
            
            // Simulate competitor data
            const insights = keywords.slice(0, 5).map((kw, i) => {
                const yourRank = Math.random() > 0.3 ? Math.floor(Math.random() * 20) + 1 : null;
                const compRank = Math.floor(Math.random() * 10) + 1;
                const gap = yourRank ? yourRank - compRank : null;
                
                return {
                    keyword: `${kw || ''} ${geo}`.trim(),
                    yourRank,
                    compRank,
                    gap
                };
            });
            
            table.innerHTML = insights.map(item => {
                const rankClass = (rank) => {
                    if (!rank) return 'text-red-400';
                    if (rank <= 3) return 'text-green-400';
                    if (rank <= 10) return 'text-blue-400';
                    return 'text-yellow-400';
                };
                
                const gapDisplay = item.gap === null ? '<span class="text-red-400">Not ranking</span>' :
                    item.gap > 0 ? `<span class="text-red-400">-${item.gap} behind</span>` :
                    item.gap < 0 ? `<span class="text-green-400">+${Math.abs(item.gap)} ahead</span>` :
                    '<span class="text-gray-400">Tied</span>';
                
                return `
                    <tr class="border-b border-white/5 hover:bg-white/5">
                        <td class="py-3 text-white">${escapeHtml(item.keyword)}</td>
                        <td class="py-3 text-center ${rankClass(item.yourRank)} font-bold">${item.yourRank ? '#' + item.yourRank : '‚Äî'}</td>
                        <td class="py-3 text-center ${rankClass(item.compRank)}">#${item.compRank}</td>
                        <td class="py-3 text-center">${gapDisplay}</td>
                    </tr>
                `;
            }).join('');
        }

        // ==========================================
        // CONTENT GENERATION
        // ==========================================
        
        function populateKeywordDropdown() {
            const select = document.getElementById('blogKeyword');
            if (!currentClient) return;
            
            select.innerHTML = '<option value="">Choose a keyword...</option>';
            
            // Add primary keywords
            if (currentClient.primary_keywords?.length > 0) {
                const primaryGroup = document.createElement('optgroup');
                primaryGroup.label = 'üéØ Primary Keywords';
                currentClient.primary_keywords.forEach(kw => {
                    const option = document.createElement('option');
                    option.value = kw;
                    option.textContent = kw;
                    primaryGroup.appendChild(option);
                });
                select.appendChild(primaryGroup);
            }
            
            // Add secondary keywords
            if (currentClient.secondary_keywords?.length > 0) {
                const secondaryGroup = document.createElement('optgroup');
                secondaryGroup.label = 'üìù Secondary Keywords';
                currentClient.secondary_keywords.forEach(kw => {
                    const option = document.createElement('option');
                    option.value = kw;
                    option.textContent = kw;
                    secondaryGroup.appendChild(option);
                });
                select.appendChild(secondaryGroup);
            }
        }
        
        async function generateBlog() {
            const keyword = document.getElementById('customBlogKeyword').value.trim() || 
                           document.getElementById('blogKeyword').value;
            
            if (!keyword) {
                alert('Please select or enter a keyword');
                return;
            }
            
            if (!currentClient) {
                alert('Please select a client first');
                return;
            }
            
            const wordCount = parseInt(document.getElementById('blogWordCount').value);
            const faqCount = parseInt(document.getElementById('blogFaqs').value);
            const generateImage = document.getElementById('blogGenerateImage').checked;
            
            const btn = document.getElementById('btnGenerateBlog');
            const progress = document.getElementById('blogProgress');
            
            btn.disabled = true;
            btn.innerHTML = '<div class="spinner w-5 h-5 mr-2"></div> Generating...';
            progress.classList.remove('hidden');
            document.getElementById('blogProgressText').textContent = 'Starting blog generation...';
            
            try {
                // Start async generation
                const startResponse = await fetch('/api/content/blog/generate-async', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${AUTH_TOKEN}`
                    },
                    body: JSON.stringify({
                        client_id: currentClient.id,
                        keyword: keyword,
                        word_count: wordCount,
                        include_faq: faqCount > 0,
                        faq_count: faqCount
                    })
                });
                
                if (!startResponse.ok) {
                    const errorData = await startResponse.json().catch(() => ({ error: `Server returned ${startResponse.status}` }));
                    throw new Error(errorData.error || `Server error: ${startResponse.status}`);
                }
                
                const startResult = await startResponse.json();
                const taskId = startResult.task_id;
                
                document.getElementById('blogProgressText').textContent = 'Generating 1,500+ word SEO blog post with FAQs and internal links...';
                
                // Poll for completion
                let attempts = 0;
                const maxAttempts = 90; // 3 minutes max (2 sec intervals)
                
                while (attempts < maxAttempts) {
                    await new Promise(resolve => setTimeout(resolve, 2000)); // Wait 2 seconds
                    
                    const statusResponse = await fetch(`/api/content/blog/task/${taskId}`, {
                        headers: { 'Authorization': `Bearer ${AUTH_TOKEN}` }
                    });
                    
                    const status = await statusResponse.json();
                    
                    if (status.status === 'complete') {
                        const blogId = status.blog_id;
                        const blogTitle = status.title || keyword;
                        
                        // Generate featured image if enabled
                        if (generateImage && blogId) {
                            document.getElementById('blogProgressText').textContent = '‚úì Blog created! Generating featured image...';
                            
                            try {
                                const imageResponse = await fetch(`${API_URL}/api/images/generate`, {
                                    method: 'POST',
                                    headers: {
                                        'Content-Type': 'application/json',
                                        'Authorization': `Bearer ${AUTH_TOKEN}`
                                    },
                                    body: JSON.stringify({
                                        prompt: `${keyword} - professional blog header image for ${currentClient.business_name || 'business'}`,
                                        style: 'blog_header',
                                        size: '1792x1024',
                                        client_id: currentClient.id
                                    })
                                });
                                
                                const imageResult = await imageResponse.json();
                                
                                if (imageResult.success && imageResult.url) {
                                    await fetch(`${API_URL}/api/content/blog/${blogId}`, {
                                        method: 'PATCH',
                                        headers: {
                                            'Content-Type': 'application/json',
                                            'Authorization': `Bearer ${AUTH_TOKEN}`
                                        },
                                        body: JSON.stringify({
                                            featured_image_url: imageResult.url
                                        })
                                    });
                                    
                                    document.getElementById('blogProgressText').textContent = '‚úì Blog post + featured image generated!';
                                } else {
                                    document.getElementById('blogProgressText').textContent = '‚úì Blog created (image generation unavailable)';
                                }
                            } catch (imgError) {
                                console.warn('Image generation failed:', imgError);
                                document.getElementById('blogProgressText').textContent = '‚úì Blog created (image skipped)';
                            }
                        } else {
                            document.getElementById('blogProgressText').textContent = '‚úì Blog post generated successfully!';
                        }
                        
                        // Refresh the blogs list
                        setTimeout(() => {
                            progress.classList.add('hidden');
                            loadClient(currentClient.id);
                            showTab('blogs');
                            alert(`Blog post "${blogTitle}" generated successfully!`);
                        }, 1500);
                        
                        return; // Success - exit function
                    }
                    
                    if (status.status === 'error') {
                        throw new Error(status.error || 'Blog generation failed');
                    }
                    
                    // Update progress message
                    if (status.status === 'generating') {
                        const dots = '.'.repeat((attempts % 3) + 1);
                        document.getElementById('blogProgressText').textContent = `Generating SEO content${dots} (${Math.floor(attempts * 2 / 60)}m ${(attempts * 2) % 60}s)`;
                    }
                    
                    attempts++;
                }
                
                throw new Error('Generation timed out after 3 minutes');
                
            } catch (error) {
                console.error('Blog generation error:', error);
                document.getElementById('blogProgressText').textContent = `Error: ${error.message}`;
                alert(`Failed to generate blog: ${error.message}`);
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-magic"></i> Generate Blog Post';
            }
        }
        
        async function generateSocial() {
            const topic = document.getElementById('socialTopic').value.trim();
            
            if (!topic) {
                alert('Please enter a topic');
                return;
            }
            
            if (!currentClient) {
                alert('Please select a client first');
                return;
            }
            
            const platforms = [];
            if (document.getElementById('platformGbp').checked) platforms.push('gbp');
            if (document.getElementById('platformFacebook').checked) platforms.push('facebook');
            if (document.getElementById('platformInstagram').checked) platforms.push('instagram');
            
            if (platforms.length === 0) {
                alert('Please select at least one platform');
                return;
            }
            
            const btn = document.getElementById('btnGenerateSocial');
            const progress = document.getElementById('socialProgress');
            
            btn.disabled = true;
            btn.innerHTML = '<div class="spinner w-5 h-5 mr-2"></div> Generating...';
            progress.classList.remove('hidden');
            
            let generated = 0;
            
            for (const platform of platforms) {
                document.getElementById('socialProgressText').textContent = `Generating ${platform.toUpperCase()} post...`;
                
                try {
                    await fetch('/api/content/social/generate', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${AUTH_TOKEN}`
                        },
                        body: JSON.stringify({
                            client_id: currentClient.id,
                            topic: topic,
                            platform: platform
                        })
                    });
                    generated++;
                } catch (error) {
                    console.error(`Social generation error (${platform}):`, error);
                }
            }
            
            document.getElementById('socialProgressText').textContent = `‚úì Generated ${generated} social posts!`;
            
            setTimeout(() => {
                progress.classList.add('hidden');
                loadClient(currentClient.id);
                showTab('social');
            }, 1500);
            
            btn.disabled = false;
            btn.innerHTML = '<i class="fas fa-magic"></i> Generate Social Posts';
        }
        
        // ==========================================
        // AI IMAGE GENERATION
        // ==========================================
        
        let lastGeneratedImageUrl = null;
        
        async function generateImage() {
            const prompt = document.getElementById('imagePrompt').value.trim();
            
            if (!prompt) {
                alert('Please describe the image you want to create');
                return;
            }
            
            const style = document.getElementById('imageStyle').value;
            const size = document.getElementById('imageSize').value;
            
            const btn = document.getElementById('btnGenerateImage');
            const progress = document.getElementById('imageProgress');
            const preview = document.getElementById('imagePreview');
            
            btn.disabled = true;
            btn.innerHTML = '<div class="spinner w-5 h-5 mr-2"></div> Generating...';
            progress.classList.remove('hidden');
            preview.classList.add('hidden');
            
            try {
                const response = await fetch(`${API_URL}/api/images/generate`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${AUTH_TOKEN}`
                    },
                    body: JSON.stringify({
                        prompt: prompt,
                        style: style,
                        size: size,
                        client_id: currentClient?.id
                    })
                });
                
                const data = await response.json();
                
                if (data.success && data.url) {
                    // Show preview
                    lastGeneratedImageUrl = data.url;
                    document.getElementById('generatedImage').src = data.url;
                    document.getElementById('imageDownload').href = data.url;
                    document.getElementById('imageProvider').textContent = `Generated with ${data.provider?.toUpperCase() || 'AI'}`;
                    preview.classList.remove('hidden');
                    
                    document.getElementById('imageProgressText').textContent = '‚úì Image generated!';
                } else {
                    alert('Image generation failed: ' + (data.error || 'Unknown error'));
                }
            } catch (error) {
                alert('Error: ' + error.message);
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-wand-magic-sparkles"></i> Generate Image';
                setTimeout(() => progress.classList.add('hidden'), 1500);
            }
        }
        
        async function generateSocialImages() {
            const prompt = document.getElementById('imagePrompt').value.trim();
            
            if (!prompt) {
                alert('Please describe the image you want to create');
                return;
            }
            
            if (!currentClient) {
                alert('Please select a client first');
                return;
            }
            
            const btn = document.getElementById('btnGenerateSocialImages');
            const progress = document.getElementById('imageProgress');
            
            btn.disabled = true;
            progress.classList.remove('hidden');
            document.getElementById('imageProgressText').textContent = 'Generating images for all platforms...';
            
            try {
                const response = await fetch(`${API_URL}/api/images/generate-for-social`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${AUTH_TOKEN}`
                    },
                    body: JSON.stringify({
                        topic: prompt,
                        client_id: currentClient.id,
                        platforms: ['facebook', 'instagram', 'linkedin']
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    document.getElementById('imageProgressText').textContent = 
                        `‚úì Generated ${data.generated_count}/${data.total_platforms} platform images!`;
                    
                    // Show first successful image in preview
                    for (const [platform, result] of Object.entries(data.images || {})) {
                        if (result.success && result.url) {
                            lastGeneratedImageUrl = result.url;
                            document.getElementById('generatedImage').src = result.url;
                            document.getElementById('imageDownload').href = result.url;
                            document.getElementById('imageProvider').textContent = `${platform} - ${result.provider?.toUpperCase() || 'AI'}`;
                            document.getElementById('imagePreview').classList.remove('hidden');
                            break;
                        }
                    }
                } else {
                    alert('Image generation failed: ' + (data.error || 'Unknown error'));
                }
            } catch (error) {
                alert('Error: ' + error.message);
            } finally {
                btn.disabled = false;
                setTimeout(() => progress.classList.add('hidden'), 2000);
            }
        }
        
        function copyImageUrl() {
            if (lastGeneratedImageUrl) {
                // Construct full URL
                const fullUrl = lastGeneratedImageUrl.startsWith('http') 
                    ? lastGeneratedImageUrl 
                    : window.location.origin + lastGeneratedImageUrl;
                
                navigator.clipboard.writeText(fullUrl).then(() => {
                    // Show brief feedback
                    const btn = event.target.closest('button');
                    const originalIcon = btn.innerHTML;
                    btn.innerHTML = '<i class="fas fa-check text-green-400 text-sm"></i>';
                    setTimeout(() => {
                        btn.innerHTML = originalIcon;
                    }, 1000);
                });
            }
        }
        
        async function generateBulk() {
            if (!currentClient) {
                alert('Please select a client first');
                return;
            }
            
            const blogCount = parseInt(document.getElementById('bulkBlogCount').value);
            const socialCount = parseInt(document.getElementById('bulkSocialCount').value);
            
            if (blogCount === 0 && socialCount === 0) {
                alert('Please select at least one item to generate');
                return;
            }
            
            // Check if client has keywords
            const availableKeywords = [
                ...(currentClient.primary_keywords || []),
                ...(currentClient.secondary_keywords || [])
            ];
            
            if (blogCount > 0 && availableKeywords.length === 0) {
                alert('This client has no keywords defined. Please add keywords first or use the single blog generator with a custom keyword.');
                return;
            }
            
            if (blogCount > availableKeywords.length) {
                if (!confirm(`This client only has ${availableKeywords.length} keyword(s). Generate ${availableKeywords.length} blogs instead of ${blogCount}?`)) {
                    return;
                }
            }
            
            const btn = document.getElementById('btnGenerateBulk');
            const progress = document.getElementById('bulkProgress');
            const progressBar = document.getElementById('bulkProgressBar');
            const progressCount = document.getElementById('bulkProgressCount');
            const progressLog = document.getElementById('bulkProgressLog');
            
            btn.disabled = true;
            btn.innerHTML = '<div class="spinner w-5 h-5 mr-2"></div> Generating...';
            progress.classList.remove('hidden');
            progressLog.innerHTML = '';
            
            const actualBlogCount = Math.min(blogCount, availableKeywords.length);
            const actualSocialTopics = Math.min(socialCount, availableKeywords.length);
            const totalItems = actualBlogCount + (actualSocialTopics * 3); // 3 platforms
            let completed = 0;
            
            // Get keywords for blogs
            const keywords = availableKeywords.slice(0, actualBlogCount);
            
            // Generate blogs
            for (let i = 0; i < keywords.length; i++) {
                const keyword = keywords[i];
                progressLog.innerHTML += `<div class="text-blue-400">üìù Generating blog: ${keyword}...</div>`;
                progressLog.scrollTop = progressLog.scrollHeight;
                
                try {
                    const response = await fetch('/api/content/blog/generate', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${AUTH_TOKEN}`
                        },
                        body: JSON.stringify({
                            client_id: currentClient.id,
                            keyword: keyword,
                            word_count: 1500,
                            include_faq: true,
                            faq_count: 5,
                            generate_schema: true
                        })
                    });
                    
                    if (response.ok) {
                        progressLog.innerHTML += `<div class="text-green-400">‚úì Blog: ${keyword}</div>`;
                    } else {
                        progressLog.innerHTML += `<div class="text-red-400">‚úó Failed: ${keyword}</div>`;
                    }
                } catch (error) {
                    progressLog.innerHTML += `<div class="text-red-400">‚úó Error: ${keyword}</div>`;
                }
                
                completed++;
                progressCount.textContent = `${completed} / ${totalItems}`;
                progressBar.style.width = totalItems > 0 ? `${(completed / totalItems) * 100}%` : '100%';
            }
            
            // Generate social posts
            const platforms = ['gbp', 'facebook', 'instagram'];
            const topics = availableKeywords.slice(0, socialCount);
            
            if (socialCount > 0 && topics.length === 0) {
                progressLog.innerHTML += `<div class="text-yellow-400">‚ö† No keywords for social posts - skipping</div>`;
            }
            
            for (const topic of topics) {
                for (const platform of platforms) {
                    progressLog.innerHTML += `<div class="text-blue-400">üì± Generating ${platform}: ${topic}...</div>`;
                    progressLog.scrollTop = progressLog.scrollHeight;
                    
                    try {
                        await fetch('/api/content/social/generate', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${AUTH_TOKEN}`
                            },
                            body: JSON.stringify({
                                client_id: currentClient.id,
                                topic: topic,
                                platform: platform
                            })
                        });
                        progressLog.innerHTML += `<div class="text-green-400">‚úì ${platform}: ${topic}</div>`;
                    } catch (error) {
                        progressLog.innerHTML += `<div class="text-red-400">‚úó ${platform}: ${topic}</div>`;
                    }
                    
                    completed++;
                    progressCount.textContent = `${completed} / ${totalItems}`;
                    progressBar.style.width = totalItems > 0 ? `${(completed / totalItems) * 100}%` : '100%';
                }
            }
            
            progressLog.innerHTML += `<div class="text-purple-400 font-bold mt-2">üéâ Bulk generation complete!</div>`;
            
            setTimeout(() => {
                loadClient(currentClient.id);
                showTab('blogs');
            }, 2000);
            
            btn.disabled = false;
            btn.innerHTML = '<i class="fas fa-rocket"></i> Generate All';
        }

        // Close modal on escape
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') closeBlogModal();
        });
        
        // ==========================================
        // ONBOARDING TOUR
        // ==========================================
        const tourSteps = [
            {
                element: '#tab-generate',
                title: 'Generate Content',
                content: 'Click here to create new blog posts and social media content with AI. Select a keyword and click generate!',
                position: 'bottom'
            },
            {
                element: '#tab-blogs',
                title: 'Blog Posts',
                content: 'View all your generated blog posts here. Click any post to preview, edit, or export it.',
                position: 'bottom'
            },
            {
                element: '#tab-social',
                title: 'Social Media',
                content: 'Manage your social media content for Google Business, Facebook, and Instagram.',
                position: 'bottom'
            },
            {
                element: '#tab-calendar',
                title: 'Content Calendar',
                content: 'Plan and schedule your content. Use Auto-Schedule to create a posting plan automatically.',
                position: 'bottom'
            },
            {
                element: '#clientSelector',
                title: 'Switch Clients',
                content: 'Use this dropdown to switch between different client accounts.',
                position: 'bottom'
            }
        ];
        
        let currentTourStep = 0;
        let tourActive = false;
        
        function startTour() {
            if (tourSteps.length === 0) return;
            tourActive = true;
            currentTourStep = 0;
            showTourStep(0);
        }
        
        function showTourStep(index) {
            // Remove any existing tour elements
            document.querySelectorAll('.tour-tooltip, .tour-highlight').forEach(el => el.remove());
            
            if (index >= tourSteps.length) {
                endTour();
                return;
            }
            
            const step = tourSteps[index];
            const element = document.querySelector(step.element);
            
            if (!element) {
                // Skip to next step if element not found
                showTourStep(index + 1);
                return;
            }
            
            // Add highlight
            element.classList.add('tour-highlight');
            
            // Create tooltip
            const tooltip = document.createElement('div');
            tooltip.className = `tour-tooltip ${step.position}`;
            tooltip.innerHTML = `
                <div class="flex items-center gap-2 mb-2">
                    <div class="w-8 h-8 rounded-full bg-purple-100 flex items-center justify-center">
                        <i class="fas fa-lightbulb text-purple-600"></i>
                    </div>
                    <h3 class="font-bold text-gray-900">${step.title}</h3>
                </div>
                <p class="text-gray-600 text-sm mb-4">${step.content}</p>
                <div class="flex items-center justify-between">
                    <div class="tour-progress">
                        ${tourSteps.map((_, i) => `<div class="tour-progress-dot ${i === index ? 'active' : ''}"></div>`).join('')}
                    </div>
                    <div class="flex gap-2">
                        <button onclick="endTour()" class="px-3 py-1 text-gray-500 text-sm hover:text-gray-700">Skip</button>
                        <button onclick="nextTourStep()" class="px-4 py-1 bg-purple-600 text-white text-sm rounded-lg hover:bg-purple-700">
                            ${index === tourSteps.length - 1 ? 'Finish' : 'Next'}
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(tooltip);
            
            // Position tooltip
            const rect = element.getBoundingClientRect();
            const tooltipRect = tooltip.getBoundingClientRect();
            
            let top, left;
            switch (step.position) {
                case 'bottom':
                    top = rect.bottom + 16;
                    left = rect.left + (rect.width / 2) - (tooltipRect.width / 2);
                    break;
                case 'top':
                    top = rect.top - tooltipRect.height - 16;
                    left = rect.left + (rect.width / 2) - (tooltipRect.width / 2);
                    break;
                case 'left':
                    top = rect.top + (rect.height / 2) - (tooltipRect.height / 2);
                    left = rect.left - tooltipRect.width - 16;
                    break;
                case 'right':
                    top = rect.top + (rect.height / 2) - (tooltipRect.height / 2);
                    left = rect.right + 16;
                    break;
            }
            
            // Keep tooltip in viewport
            left = Math.max(16, Math.min(left, window.innerWidth - tooltipRect.width - 16));
            top = Math.max(16, Math.min(top, window.innerHeight - tooltipRect.height - 16));
            
            tooltip.style.top = `${top}px`;
            tooltip.style.left = `${left}px`;
        }
        
        function nextTourStep() {
            const currentElement = document.querySelector(tourSteps[currentTourStep]?.element);
            if (currentElement) currentElement.classList.remove('tour-highlight');
            
            currentTourStep++;
            if (currentTourStep >= tourSteps.length) {
                endTour();
            } else {
                showTourStep(currentTourStep);
            }
        }
        
        function endTour() {
            tourActive = false;
            document.querySelectorAll('.tour-tooltip, .tour-highlight').forEach(el => {
                if (el.classList.contains('tour-highlight')) {
                    el.classList.remove('tour-highlight');
                } else {
                    el.remove();
                }
            });
            
            // Mark tour as completed
            localStorage.setItem('mcp_tour_completed', 'true');
        }
        
        // Show tour for first-time users
        // ==========================================
        // REPORTS
        // ==========================================
        function updateReportStats() {
            if (!currentClient) return;
            
            document.getElementById('reportBlogs').textContent = allBlogs.length;
            document.getElementById('reportSocial').textContent = allSocial.length;
            
            const totalWords = allBlogs.reduce((sum, b) => sum + (b.word_count || 0), 0);
            document.getElementById('reportWords').textContent = totalWords.toLocaleString();
            
            // Calculate average SEO score
            if (allBlogs.length > 0) {
                const scores = allBlogs.map(b => calculateSEOScore(b).score);
                const avgScore = Math.round(scores.reduce((a, b) => a + b, 0) / scores.length);
                document.getElementById('reportSeoScore').textContent = avgScore + '/100';
            } else {
                document.getElementById('reportSeoScore').textContent = '--';
            }
        }
        
        function generateMonthlyReport() {
            if (!currentClient) {
                alert('Please select a client first');
                return;
            }
            
            const branding = JSON.parse(localStorage.getItem('mcp_branding') || '{}');
            const agencyName = branding.agencyName || 'MCP Framework';
            const totalWords = allBlogs.reduce((sum, b) => sum + (b.word_count || 0), 0);
            const avgScore = allBlogs.length > 0 
                ? Math.round(allBlogs.map(b => calculateSEOScore(b).score).reduce((a, b) => a + b, 0) / allBlogs.length)
                : 0;
            
            // Get status counts
            const statusCounts = {
                draft: allBlogs.filter(b => b.status === 'draft').length,
                scheduled: allBlogs.filter(b => b.status === 'scheduled').length,
                approved: allBlogs.filter(b => b.status === 'approved').length,
                published: allBlogs.filter(b => b.status === 'published').length
            };
            
            const reportHTML = `
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Monthly Content Report - ${currentClient.business_name}</title>
    <style>
        @page { size: letter; margin: 0.5in; }
        @media print {
            body { -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; }
            .no-print { display: none !important; }
        }
        * { box-sizing: border-box; }
        body { font-family: 'Segoe UI', Arial, sans-serif; color: #333; max-width: 850px; margin: 0 auto; padding: 20px; line-height: 1.5; }
        .no-print { position: fixed; top: 20px; right: 20px; z-index: 100; }
        .no-print button { background: #667eea; color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 600; }
        .no-print button:hover { background: #5a67d8; }
        .header { background: linear-gradient(135deg, #667eea, #764ba2); color: white; padding: 40px; border-radius: 16px; margin-bottom: 30px; }
        .header h1 { margin: 0 0 10px 0; font-size: 28px; font-weight: 700; }
        .header p { margin: 0; opacity: 0.9; font-size: 16px; }
        .header .date { font-size: 14px; margin-top: 15px; opacity: 0.8; }
        .stats { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin-bottom: 30px; }
        .stat-box { background: #f8fafc; padding: 20px; border-radius: 12px; text-align: center; border: 1px solid #e2e8f0; }
        .stat-box h3 { margin: 0; font-size: 32px; color: #667eea; font-weight: 700; }
        .stat-box p { margin: 5px 0 0 0; color: #64748b; font-size: 13px; }
        .section { margin-bottom: 30px; background: white; padding: 25px; border-radius: 12px; border: 1px solid #e2e8f0; }
        .section h2 { color: #1e293b; border-bottom: 2px solid #667eea; padding-bottom: 10px; margin-top: 0; font-size: 18px; }
        .content-table { width: 100%; border-collapse: collapse; font-size: 13px; }
        .content-table th { background: #f1f5f9; padding: 10px; text-align: left; font-weight: 600; border-bottom: 2px solid #e2e8f0; }
        .content-table td { padding: 10px; border-bottom: 1px solid #e2e8f0; }
        .content-table tr:last-child td { border-bottom: none; }
        .status-badge { display: inline-block; padding: 3px 8px; border-radius: 4px; font-size: 11px; font-weight: 600; text-transform: uppercase; }
        .status-draft { background: #f1f5f9; color: #64748b; }
        .status-scheduled { background: #dbeafe; color: #1d4ed8; }
        .status-approved { background: #dcfce7; color: #15803d; }
        .status-published { background: #d1fae5; color: #047857; }
        .keyword-tag { display: inline-block; background: #ede9fe; color: #7c3aed; padding: 4px 10px; border-radius: 6px; font-size: 12px; margin: 3px; }
        .summary-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; }
        .summary-item { display: flex; justify-content: space-between; padding: 10px; background: #f8fafc; border-radius: 8px; }
        .footer { text-align: center; color: #94a3b8; font-size: 12px; margin-top: 40px; padding-top: 20px; border-top: 1px solid #e2e8f0; }
    </style>
</head>
<body>
    <div class="no-print">
        <button onclick="window.print()">üìÑ Print / Save as PDF</button>
    </div>
    
    <div class="header">
        <h1>Monthly Content Report</h1>
        <p>${currentClient.business_name}</p>
        <p class="date">Report Period: ${new Date().toLocaleDateString('en-US', { month: 'long', year: 'numeric' })}</p>
    </div>
    
    <div class="stats">
        <div class="stat-box">
            <h3>${allBlogs.length}</h3>
            <p>Blog Posts</p>
        </div>
        <div class="stat-box">
            <h3>${allSocial.length}</h3>
            <p>Social Posts</p>
        </div>
        <div class="stat-box">
            <h3>${totalWords.toLocaleString()}</h3>
            <p>Total Words</p>
        </div>
        <div class="stat-box">
            <h3>${avgScore}/100</h3>
            <p>Avg SEO Score</p>
        </div>
    </div>
    
    <div class="section">
        <h2>üìä Content Status Summary</h2>
        <div class="summary-grid">
            <div class="summary-item"><span>Draft</span><strong>${statusCounts.draft}</strong></div>
            <div class="summary-item"><span>Scheduled</span><strong>${statusCounts.scheduled}</strong></div>
            <div class="summary-item"><span>Approved</span><strong>${statusCounts.approved}</strong></div>
            <div class="summary-item"><span>Published</span><strong>${statusCounts.published}</strong></div>
        </div>
    </div>
    
    <div class="section">
        <h2>üìù Blog Posts Created</h2>
        ${allBlogs.length > 0 ? `
        <table class="content-table">
            <thead>
                <tr>
                    <th>Title</th>
                    <th>Keyword</th>
                    <th>Words</th>
                    <th>Status</th>
                </tr>
            </thead>
            <tbody>
                ${allBlogs.slice(0, 20).map(b => `
                <tr>
                    <td>${b.title || 'Untitled'}</td>
                    <td>${b.primary_keyword || '-'}</td>
                    <td>${b.word_count || 0}</td>
                    <td><span class="status-badge status-${b.status || 'draft'}">${b.status || 'draft'}</span></td>
                </tr>
                `).join('')}
            </tbody>
        </table>
        ${allBlogs.length > 20 ? `<p style="text-align:center; color:#64748b; margin-top:10px;">...and ${allBlogs.length - 20} more posts</p>` : ''}
        ` : '<p style="color:#64748b">No blog posts created yet</p>'}
    </div>
    
    <div class="section">
        <h2>üéØ Keywords Targeted</h2>
        <div>
            ${(currentClient.primary_keywords || []).map(k => `<span class="keyword-tag">${k}</span>`).join('')}
            ${(currentClient.primary_keywords || []).length === 0 ? '<p style="color:#64748b">No keywords defined</p>' : ''}
        </div>
    </div>
    
    <div class="footer">
        <p>Generated by ${agencyName}</p>
        <p>${new Date().toLocaleString()}</p>
    </div>
</body>
</html>`;
            
            // Open in new window for print/PDF
            const printWindow = window.open('', '_blank');
            printWindow.document.write(reportHTML);
            printWindow.document.close();
        }
        
        function exportInventoryCSV() {
            if (!currentClient) {
                alert('Please select a client first');
                return;
            }
            
            let csv = '';
            
            if (document.getElementById('exportBlogs').checked && allBlogs.length > 0) {
                csv += 'BLOG POSTS\n';
                csv += 'Title,Keyword,Word Count,Status,Created\n';
                allBlogs.forEach(b => {
                    csv += `"${(b.title || '').replace(/"/g, '""')}","${b.primary_keyword || ''}",${b.word_count || 0},"${b.status || 'draft'}","${b.created_at || ''}"\n`;
                });
                csv += '\n';
            }
            
            if (document.getElementById('exportSocial').checked && allSocial.length > 0) {
                csv += 'SOCIAL POSTS\n';
                csv += 'Platform,Topic,Status,Created\n';
                allSocial.forEach(s => {
                    csv += `"${s.platform || ''}","${(s.topic || '').replace(/"/g, '""')}","${s.status || 'draft'}","${s.created_at || ''}"\n`;
                });
                csv += '\n';
            }
            
            if (document.getElementById('exportKeywords').checked) {
                csv += 'KEYWORDS\n';
                csv += 'Keyword,Type\n';
                (currentClient.primary_keywords || []).forEach(k => {
                    csv += `"${k}","primary"\n`;
                });
                (currentClient.secondary_keywords || []).forEach(k => {
                    csv += `"${k}","secondary"\n`;
                });
            }
            
            if (!csv) {
                alert('No data selected for export');
                return;
            }
            
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${currentClient.business_name?.replace(/[^a-z0-9]/gi, '-').toLowerCase() || 'client'}-content-inventory.csv`;
            a.click();
        }
        
        function exportInventoryHTML() {
            if (!currentClient) {
                alert('Please select a client first');
                return;
            }
            
            let content = `
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Content Inventory - ${currentClient.business_name}</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 1000px; margin: 0 auto; padding: 20px; }
        h1 { color: #1e293b; }
        h2 { color: #334155; margin-top: 30px; }
        table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
        th, td { padding: 10px; text-align: left; border-bottom: 1px solid #e2e8f0; }
        th { background: #f8fafc; color: #64748b; font-weight: 600; }
        .status-draft { color: #f59e0b; }
        .status-published { color: #10b981; }
    </style>
</head>
<body>
    <h1>Content Inventory: ${currentClient.business_name}</h1>
    <p>Generated: ${new Date().toLocaleString()}</p>
`;
            
            if (document.getElementById('exportBlogs').checked && allBlogs.length > 0) {
                content += `<h2>Blog Posts (${allBlogs.length})</h2><table><tr><th>Title</th><th>Keyword</th><th>Words</th><th>Status</th></tr>`;
                allBlogs.forEach(b => {
                    content += `<tr><td>${escapeHtml(b.title || 'Untitled')}</td><td>${escapeHtml(b.primary_keyword || '')}</td><td>${b.word_count || 0}</td><td class="status-${b.status || 'draft'}">${b.status || 'draft'}</td></tr>`;
                });
                content += '</table>';
            }
            
            if (document.getElementById('exportSocial').checked && allSocial.length > 0) {
                content += `<h2>Social Posts (${allSocial.length})</h2><table><tr><th>Platform</th><th>Topic</th><th>Status</th></tr>`;
                allSocial.forEach(s => {
                    content += `<tr><td>${escapeHtml(s.platform || '')}</td><td>${escapeHtml(s.topic || '')}</td><td class="status-${s.status || 'draft'}">${s.status || 'draft'}</td></tr>`;
                });
                content += '</table>';
            }
            
            if (document.getElementById('exportKeywords').checked) {
                const keywords = [...(currentClient.primary_keywords || []), ...(currentClient.secondary_keywords || [])];
                if (keywords.length > 0) {
                    content += `<h2>Keywords (${keywords.length})</h2><ul>`;
                    keywords.forEach(k => content += `<li>${escapeHtml(k)}</li>`);
                    content += '</ul>';
                }
            }
            
            content += '</body></html>';
            
            const blob = new Blob([content], { type: 'text/html' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${currentClient.business_name?.replace(/[^a-z0-9]/gi, '-').toLowerCase() || 'client'}-content-inventory.html`;
            a.click();
        }
        
        function generateClientSummary() {
            if (!currentClient) {
                alert('Please select a client first');
                return;
            }
            
            const branding = JSON.parse(localStorage.getItem('mcp_branding') || '{}');
            const agencyName = branding.agencyName || 'MCP Framework';
            const totalWords = allBlogs.reduce((sum, b) => sum + (b.word_count || 0), 0);
            
            const summaryHTML = `
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Client Summary - ${currentClient.business_name}</title>
    <style>
        @page { size: letter; margin: 0.5in; }
        body { font-family: Arial, sans-serif; color: #333; max-width: 800px; margin: 0 auto; }
        .header { display: flex; justify-content: space-between; align-items: center; padding-bottom: 20px; border-bottom: 3px solid #667eea; margin-bottom: 30px; }
        .header h1 { margin: 0; color: #1e293b; }
        .header .agency { color: #667eea; font-weight: bold; }
        .client-info { background: #f8fafc; padding: 20px; border-radius: 12px; margin-bottom: 30px; }
        .client-info h2 { margin: 0 0 10px 0; color: #667eea; }
        .metrics { display: flex; gap: 20px; margin-bottom: 30px; }
        .metric { flex: 1; text-align: center; padding: 20px; background: linear-gradient(135deg, #667eea, #764ba2); color: white; border-radius: 12px; }
        .metric h3 { margin: 0; font-size: 32px; }
        .metric p { margin: 5px 0 0 0; opacity: 0.9; }
        .section { margin-bottom: 25px; }
        .section h3 { color: #334155; margin-bottom: 10px; }
        .tag { display: inline-block; background: #e2e8f0; padding: 4px 12px; border-radius: 20px; margin: 4px; font-size: 14px; }
        .footer { text-align: center; color: #94a3b8; font-size: 11px; padding-top: 20px; border-top: 1px solid #e2e8f0; }
    </style>
</head>
<body>
    <div class="header">
        <h1>Client Summary</h1>
        <div class="agency">${escapeHtml(agencyName)}</div>
    </div>
    
    <div class="client-info">
        <h2>${escapeHtml(currentClient.business_name || 'Client')}</h2>
        <p><strong>Industry:</strong> ${escapeHtml(currentClient.industry || 'N/A')} | <strong>Location:</strong> ${escapeHtml(currentClient.geo || 'N/A')}</p>
    </div>
    
    <div class="metrics">
        <div class="metric">
            <h3>${allBlogs.length}</h3>
            <p>Blog Posts</p>
        </div>
        <div class="metric">
            <h3>${allSocial.length}</h3>
            <p>Social Posts</p>
        </div>
        <div class="metric">
            <h3>${totalWords.toLocaleString()}</h3>
            <p>Words Written</p>
        </div>
    </div>
    
    <div class="section">
        <h3>Target Keywords</h3>
        <div>
            ${(currentClient.primary_keywords || []).slice(0, 8).map(k => `<span class="tag">${escapeHtml(k)}</span>`).join('')}
            ${(currentClient.primary_keywords || []).length > 8 ? `<span class="tag">+${(currentClient.primary_keywords || []).length - 8} more</span>` : ''}
        </div>
    </div>
    
    <div class="section">
        <h3>Recent Content</h3>
        <ul>
            ${allBlogs.slice(0, 5).map(b => `<li>${escapeHtml(b.title || 'Untitled')} (${b.word_count || 0} words)</li>`).join('')}
            ${allBlogs.length === 0 ? '<li>No content yet</li>' : ''}
        </ul>
    </div>
    
    <div class="section">
        <h3>Next Steps</h3>
        <ul>
            <li>Continue publishing ${currentClient.primary_keywords?.[0] || 'targeted'} content weekly</li>
            <li>Maintain social media posting schedule (3x/week)</li>
            <li>Monitor keyword rankings and adjust strategy</li>
        </ul>
    </div>
    
    <div class="footer">
        <p>Prepared by ${escapeHtml(agencyName)} ‚Ä¢ ${new Date().toLocaleDateString()}</p>
    </div>
</body>
</html>`;
            
            const blob = new Blob([summaryHTML], { type: 'text/html' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${currentClient.business_name?.replace(/[^a-z0-9]/gi, '-').toLowerCase() || 'client'}-summary.html`;
            a.click();
        }
        
        function checkFirstTimeUser() {
            const tourCompleted = localStorage.getItem('mcp_tour_completed');
            if (!tourCompleted) {
                // Wait a moment for the dashboard to load, then offer the tour
                setTimeout(() => {
                    if (confirm('Welcome! Would you like a quick tour of the Content Dashboard?')) {
                        startTour();
                    } else {
                        localStorage.setItem('mcp_tour_completed', 'true');
                    }
                }, 1000);
            }
        }
        
        // Call after login
        const originalLoadClients = loadClients;
        loadClients = async function() {
            await originalLoadClients();
            checkFirstTimeUser();
        };
        
        // ==========================================
        // RANK TRACKING
        // ==========================================
        
        let rankingsData = null;
        let rankHistoryChart = null;
        
        async function refreshRankings() {
            if (!currentClient) {
                alert('Please select a client first');
                return;
            }
            
            const btn = document.getElementById('refreshRankBtn');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Checking...';
            btn.disabled = true;
            
            try {
                const response = await fetch(`${API_URL}/api/monitoring/rankings?client_id=${currentClient.id}`, {
                    headers: { 'Authorization': `Bearer ${AUTH_TOKEN}` }
                });
                
                if (!response.ok) {
                    const err = await response.json();
                    throw new Error(err.error || 'Failed to check rankings');
                }
                
                rankingsData = await response.json();
                renderRankings();
                
            } catch (error) {
                console.error('Rankings error:', error);
                alert('Error checking rankings: ' + error.message);
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }
        
        async function loadRankingHistory() {
            if (!currentClient) return;
            
            try {
                const response = await fetch(`${API_URL}/api/monitoring/rankings/history?client_id=${currentClient.id}&days=30`, {
                    headers: { 'Authorization': `Bearer ${AUTH_TOKEN}` }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    if (data.history && data.history.length > 0) {
                        renderRankingHistory(data.history);
                    }
                }
            } catch (e) {
                console.log('No ranking history yet');
            }
        }
        
        function renderRankings() {
            if (!rankingsData || !rankingsData.keywords) return;
            
            const keywords = rankingsData.keywords;
            
            // Update stats
            const positions = keywords.filter(k => k.position && k.position <= 100).map(k => k.position);
            const avgPos = positions.length > 0 
                ? Math.round(positions.reduce((a, b) => a + b, 0) / positions.length) 
                : '--';
            
            document.getElementById('rankAvgPosition').textContent = positions.length > 0 ? `#${avgPos}` : '#--';
            document.getElementById('rankTop3').textContent = keywords.filter(k => k.position && k.position <= 3).length;
            document.getElementById('rankTop10').textContent = keywords.filter(k => k.position && k.position <= 10).length;
            document.getElementById('rankTrafficValue').textContent = `$${Math.round(rankingsData.traffic_value || 0).toLocaleString()}`;
            
            // Render table
            const tbody = document.getElementById('rankingsTable');
            
            if (keywords.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="4" class="py-8 text-center text-gray-500">
                            No keywords configured. Add keywords in client settings.
                        </td>
                    </tr>
                `;
                return;
            }
            
            // Sort by position (ranked first)
            keywords.sort((a, b) => {
                if (!a.position) return 1;
                if (!b.position) return -1;
                return a.position - b.position;
            });
            
            tbody.innerHTML = keywords.map(kw => {
                const pos = kw.position ? `#${kw.position}` : '--';
                const posClass = kw.position 
                    ? (kw.position <= 3 ? 'text-green-400' : kw.position <= 10 ? 'text-blue-400' : kw.position <= 20 ? 'text-yellow-400' : 'text-gray-400')
                    : 'text-gray-500';
                
                let changeHtml = '--';
                if (kw.change) {
                    if (kw.change > 0) {
                        changeHtml = `<span class="text-green-400"><i class="fas fa-arrow-up mr-1"></i>${kw.change}</span>`;
                    } else if (kw.change < 0) {
                        changeHtml = `<span class="text-red-400"><i class="fas fa-arrow-down mr-1"></i>${Math.abs(kw.change)}</span>`;
                    } else {
                        changeHtml = '<span class="text-gray-500">-</span>';
                    }
                }
                
                return `
                    <tr class="border-b border-white/5 hover:bg-white/5">
                        <td class="py-3 text-white">${kw.keyword}</td>
                        <td class="py-3 text-center font-bold ${posClass}">${pos}</td>
                        <td class="py-3 text-center">${changeHtml}</td>
                        <td class="py-3 text-right text-gray-400">${kw.search_volume ? kw.search_volume.toLocaleString() : '--'}</td>
                    </tr>
                `;
            }).join('');
            
            // Update improved/declined sections
            const improved = keywords.filter(k => k.change && k.change > 0);
            const declined = keywords.filter(k => k.change && k.change < 0);
            
            document.getElementById('improvedKeywords').innerHTML = improved.length > 0
                ? improved.slice(0, 5).map(k => `
                    <div class="flex justify-between items-center p-2 bg-green-500/10 rounded">
                        <span class="text-white">${k.keyword}</span>
                        <span class="text-green-400">+${k.change}</span>
                    </div>
                `).join('')
                : '<p class="text-gray-500 text-sm">No improvements detected yet</p>';
            
            document.getElementById('declinedKeywords').innerHTML = declined.length > 0
                ? declined.slice(0, 5).map(k => `
                    <div class="flex justify-between items-center p-2 bg-red-500/10 rounded">
                        <span class="text-white">${k.keyword}</span>
                        <span class="text-red-400">${k.change}</span>
                    </div>
                `).join('')
                : '<p class="text-gray-500 text-sm">No declines detected</p>';
        }
        
        function renderRankingHistory(history) {
            // Group by keyword and date
            const byKeyword = {};
            history.forEach(h => {
                if (!byKeyword[h.keyword]) {
                    byKeyword[h.keyword] = [];
                }
                byKeyword[h.keyword].push({
                    date: h.checked_at,
                    position: h.position
                });
            });
            
            // Get top 5 keywords by frequency
            const topKeywords = Object.entries(byKeyword)
                .sort((a, b) => b[1].length - a[1].length)
                .slice(0, 5);
            
            if (topKeywords.length === 0) return;
            
            // Get unique dates
            const allDates = [...new Set(history.map(h => h.checked_at.split('T')[0]))].sort();
            const recentDates = allDates.slice(-14); // Last 14 days
            
            // Prepare chart data
            const datasets = topKeywords.map(([keyword, data], idx) => {
                const colors = ['#8b5cf6', '#3b82f6', '#10b981', '#f59e0b', '#ef4444'];
                
                const positions = recentDates.map(date => {
                    const match = data.find(d => d.date.startsWith(date));
                    return match ? match.position : null;
                });
                
                return {
                    label: keyword.length > 20 ? keyword.substring(0, 20) + '...' : keyword,
                    data: positions,
                    borderColor: colors[idx % colors.length],
                    backgroundColor: colors[idx % colors.length] + '20',
                    tension: 0.3,
                    fill: false
                };
            });
            
            // Create or update chart
            const ctx = document.getElementById('rankHistoryChart').getContext('2d');
            
            if (rankHistoryChart) {
                rankHistoryChart.destroy();
            }
            
            rankHistoryChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: recentDates.map(d => new Date(d).toLocaleDateString('en-US', { month: 'short', day: 'numeric' })),
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'bottom',
                            labels: { color: '#9ca3af', font: { size: 10 } }
                        }
                    },
                    scales: {
                        y: {
                            reverse: true, // Lower position = better
                            min: 1,
                            max: 50,
                            grid: { color: 'rgba(255,255,255,0.1)' },
                            ticks: { color: '#9ca3af' }
                        },
                        x: {
                            grid: { color: 'rgba(255,255,255,0.1)' },
                            ticks: { color: '#9ca3af' }
                        }
                    }
                }
            });
        }
        
        // ==========================================
        // COMPETITOR DASHBOARD
        // ==========================================
        
        let competitorData = null;
        
        async function refreshCompetitorDashboard() {
            if (!currentClient) return;
            
            const btn = document.querySelector('[onclick="refreshCompetitorDashboard()"]');
            if (btn) {
                btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Loading...';
                btn.disabled = true;
            }
            
            try {
                const response = await fetch(`${API_URL}/api/monitoring/competitor-dashboard/${currentClient.id}`, {
                    headers: { 'Authorization': `Bearer ${AUTH_TOKEN}` }
                });
                
                if (response.ok) {
                    competitorData = await response.json();
                    renderCompetitorDashboard();
                } else {
                    console.error('Failed to load competitor data');
                }
            } catch (error) {
                console.error('Competitor dashboard error:', error);
            } finally {
                if (btn) {
                    btn.innerHTML = '<i class="fas fa-sync-alt"></i> Refresh Data';
                    btn.disabled = false;
                }
            }
            
            // Also load social connections
            loadSocialConnections();
        }
        
        function renderCompetitorDashboard() {
            if (!competitorData) return;
            
            const { summary, competitors, content_gaps, ranking_battles, client_rankings } = competitorData;
            
            // Update stats
            document.getElementById('compCount').textContent = summary.total_competitors || 0;
            document.getElementById('compGaps').textContent = summary.content_gaps_found || 0;
            document.getElementById('compKeywords').textContent = summary.client_keywords_tracked || 0;
            
            // Calculate win rate from battles
            const wins = ranking_battles.filter(b => b.winning).length;
            const total = ranking_battles.length;
            const winRate = total > 0 ? Math.round((wins / total) * 100) : 0;
            document.getElementById('compWinRate').textContent = winRate + '%';
            
            // Render competitor cards
            const cardsHtml = competitors.length ? competitors.map(comp => `
                <div class="bg-white/5 rounded-xl p-4 border border-white/10 hover:border-purple-500/50 transition cursor-pointer" onclick="viewCompetitor('${comp.id}')">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 rounded-lg bg-gradient-to-br from-purple-500 to-pink-500 flex items-center justify-center">
                                <i class="fas fa-building text-white"></i>
                            </div>
                            <div>
                                <div class="font-medium text-white">${comp.name || comp.domain}</div>
                                <div class="text-xs text-gray-500">${comp.domain}</div>
                            </div>
                        </div>
                        <div class="text-right">
                            <div class="text-sm font-bold text-white">${comp.total_pages}</div>
                            <div class="text-xs text-gray-500">pages</div>
                        </div>
                    </div>
                    <div class="mt-3 flex items-center gap-2 text-xs">
                        <span class="px-2 py-1 bg-green-500/20 text-green-400 rounded">${comp.blog_posts} blogs</span>
                        <span class="px-2 py-1 bg-blue-500/20 text-blue-400 rounded">${comp.service_pages} services</span>
                    </div>
                </div>
            `).join('') : '<p class="text-gray-500 text-sm">No competitors tracked. Add them in intake.</p>';
            
            document.getElementById('competitorCards').innerHTML = cardsHtml;
            
            // Render ranking battles
            const battlesHtml = ranking_battles.length ? ranking_battles.slice(0, 10).map(battle => `
                <div class="flex items-center justify-between p-3 rounded-lg ${battle.winning ? 'bg-green-500/10 border border-green-500/20' : 'bg-red-500/10 border border-red-500/20'}">
                    <div class="flex-1">
                        <div class="font-medium text-white text-sm">${battle.keyword}</div>
                        <div class="text-xs text-gray-500">vs ${battle.competitor}</div>
                    </div>
                    <div class="flex items-center gap-4 text-sm">
                        <div class="text-center">
                            <div class="font-bold ${battle.winning ? 'text-green-400' : 'text-gray-400'}">#${battle.client_position}</div>
                            <div class="text-xs text-gray-500">You</div>
                        </div>
                        <i class="fas ${battle.winning ? 'fa-check-circle text-green-400' : 'fa-times-circle text-red-400'}"></i>
                        <div class="text-center">
                            <div class="font-bold ${!battle.winning ? 'text-red-400' : 'text-gray-400'}">#${battle.competitor_position}</div>
                            <div class="text-xs text-gray-500">Them</div>
                        </div>
                    </div>
                </div>
            `).join('') : '<p class="text-gray-500 text-sm">No ranking battles found. Check rankings first.</p>';
            
            document.getElementById('rankingBattles').innerHTML = battlesHtml;
            
            // Render content gaps
            const gapsHtml = content_gaps.length ? content_gaps.slice(0, 9).map(gap => `
                <div class="bg-white/5 rounded-lg p-3 border border-white/10 hover:border-yellow-500/50 transition cursor-pointer group" onclick="generateFromGap('${encodeURIComponent(gap.topic_suggestion)}')">
                    <div class="flex items-start gap-2">
                        <i class="fas fa-lightbulb text-yellow-400 mt-1"></i>
                        <div class="flex-1">
                            <div class="text-sm text-white group-hover:text-yellow-400 transition">${gap.title}</div>
                            <div class="text-xs text-gray-500 mt-1">From: ${gap.competitor}</div>
                        </div>
                        <i class="fas fa-plus text-gray-500 group-hover:text-yellow-400"></i>
                    </div>
                </div>
            `).join('') : '<p class="text-gray-500 text-sm col-span-full">No content gaps detected yet.</p>';
            
            document.getElementById('contentGaps').innerHTML = gapsHtml;
        }
        
        function viewCompetitor(competitorId) {
            // Could open a detailed comparison modal
            alert('Detailed competitor view coming soon! ID: ' + competitorId);
        }
        
        function generateFromGap(topic) {
            const decodedTopic = decodeURIComponent(topic);
            // Switch to generate tab and pre-fill topic
            showTab('generate');
            const topicInput = document.getElementById('blogTopic');
            if (topicInput) {
                topicInput.value = decodedTopic;
            }
        }
        
        // ==========================================
        // SOCIAL CONNECTIONS
        // ==========================================
        
        async function loadSocialConnections() {
            if (!currentClient) return;
            
            try {
                const response = await fetch(`${API_URL}/api/social/connections/${currentClient.id}`, {
                    headers: { 'Authorization': `Bearer ${AUTH_TOKEN}` }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    renderSocialConnections(data.connections);
                }
            } catch (error) {
                console.error('Failed to load social connections:', error);
            }
        }
        
        function renderSocialConnections(connections) {
            const platforms = ['gbp', 'facebook', 'instagram', 'linkedin'];
            
            platforms.forEach(platform => {
                const conn = connections[platform];
                const statusEl = document.getElementById(`${platform}-status`);
                const btnEl = document.getElementById(`${platform}-btn`);
                
                if (statusEl && btnEl) {
                    if (conn.connected) {
                        statusEl.textContent = 'Connected';
                        statusEl.classList.remove('text-gray-500');
                        statusEl.classList.add('text-green-400');
                        btnEl.textContent = 'Disconnect';
                        btnEl.classList.add('bg-red-500/20', 'hover:bg-red-500/30');
                        btnEl.classList.remove('bg-white/10', 'hover:bg-white/20');
                        btnEl.onclick = () => disconnectSocial(platform);
                    } else {
                        statusEl.textContent = 'Not connected';
                        statusEl.classList.remove('text-green-400');
                        statusEl.classList.add('text-gray-500');
                        btnEl.textContent = 'Connect';
                        btnEl.classList.remove('bg-red-500/20', 'hover:bg-red-500/30');
                        btnEl.classList.add('bg-white/10', 'hover:bg-white/20');
                        btnEl.onclick = () => connectSocial(platform);
                    }
                }
            });
        }
        
        // OAuth state for handling callbacks
        let pendingOAuthState = null;
        
        // Check for OAuth callback on page load
        async function handleOAuthCallback() {
            const urlParams = new URLSearchParams(window.location.search);
            const oauthSuccess = urlParams.get('oauth_success');
            const oauthError = urlParams.get('oauth_error');
            const platform = urlParams.get('platform');
            const state = urlParams.get('state');
            const clientId = urlParams.get('client_id');
            
            if (oauthSuccess && state) {
                // Clean URL first
                window.history.replaceState({}, document.title, window.location.pathname);
                
                // Restore client context if provided
                if (clientId && (!currentClient || currentClient.id !== clientId)) {
                    try {
                        await loadClient(clientId);
                    } catch (e) {
                        console.error('Failed to restore client context:', e);
                    }
                }
                
                // OAuth successful, show account selection
                pendingOAuthState = state;
                showAccountSelection(platform, state);
            } else if (oauthError) {
                alert(`OAuth Error: ${decodeURIComponent(oauthError)} for ${platform}`);
                window.history.replaceState({}, document.title, window.location.pathname);
            }
        }
        
        async function connectSocial(platform) {
            const platformNames = {
                'gbp': 'Google Business Profile',
                'google': 'Google Business Profile',
                'facebook': 'Facebook',
                'instagram': 'Instagram',
                'linkedin': 'LinkedIn'
            };
            
            // Check if OAuth is configured
            try {
                const configResponse = await fetch(`${API_URL}/api/oauth/config`, {
                    headers: { 'Authorization': `Bearer ${AUTH_TOKEN}` }
                });
                const configData = await configResponse.json();
                
                const oauthPlatform = platform === 'instagram' ? 'facebook' : (platform === 'gbp' ? 'google' : platform);
                const isConfigured = configData.platforms?.[oauthPlatform]?.configured;
                
                if (isConfigured) {
                    // Use OAuth flow
                    await initiateOAuth(platform);
                } else {
                    // Fall back to manual entry
                    await manualConnect(platform, platformNames);
                }
            } catch (error) {
                console.error('OAuth config check failed:', error);
                // Fall back to manual
                await manualConnect(platform, platformNames);
            }
        }
        
        async function initiateOAuth(platform) {
            const oauthPlatform = platform === 'gbp' ? 'google' : platform;
            
            try {
                const response = await fetch(`${API_URL}/api/oauth/authorize/${oauthPlatform}`, {
                    method: 'POST',
                    headers: { 
                        'Authorization': `Bearer ${AUTH_TOKEN}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ client_id: currentClient.id })
                });
                
                const data = await response.json();
                
                if (response.ok && data.auth_url) {
                    // Redirect to OAuth provider
                    window.location.href = data.auth_url;
                } else {
                    alert(`OAuth error: ${data.error || 'Unknown error'}`);
                }
            } catch (error) {
                alert('Failed to initiate OAuth: ' + error.message);
            }
        }
        
        async function showAccountSelection(platform, state) {
            try {
                const response = await fetch(`${API_URL}/api/oauth/accounts/${platform}`, {
                    method: 'POST',
                    headers: { 
                        'Authorization': `Bearer ${AUTH_TOKEN}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ state: state })
                });
                
                const data = await response.json();
                
                if (!response.ok) {
                    alert(`Error: ${data.error}`);
                    return;
                }
                
                if (!data.accounts || data.accounts.length === 0) {
                    alert('No accounts found. Make sure you have admin access to the pages/accounts.');
                    return;
                }
                
                // Show account selection modal
                showAccountSelectionModal(data.accounts, state);
                
            } catch (error) {
                alert('Failed to get accounts: ' + error.message);
            }
        }
        
        function showAccountSelectionModal(accounts, state) {
            // Create modal overlay
            const overlay = document.createElement('div');
            overlay.id = 'oauth-modal-overlay';
            overlay.className = 'fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center z-50';
            
            let accountsHtml = accounts.map((acc, idx) => {
                const icon = acc.type.includes('facebook') ? 'fab fa-facebook text-blue-500' :
                            acc.type.includes('instagram') ? 'fab fa-instagram text-pink-500' :
                            acc.type.includes('linkedin') ? 'fab fa-linkedin text-blue-600' :
                            'fab fa-google text-red-500';
                const subtitle = acc.type.replace('_', ' ').replace(/(^\w|\s\w)/g, m => m.toUpperCase());
                
                return `
                    <button onclick="selectOAuthAccount(${idx})" 
                            class="w-full p-4 bg-white/5 hover:bg-white/10 rounded-xl flex items-center gap-4 transition text-left"
                            data-account='${JSON.stringify(acc)}'>
                        <div class="w-12 h-12 rounded-full bg-white/10 flex items-center justify-center">
                            ${acc.picture ? `<img src="${acc.picture}" class="w-full h-full rounded-full object-cover">` : `<i class="${icon} text-xl"></i>`}
                        </div>
                        <div class="flex-1">
                            <div class="font-medium text-white">${acc.name}</div>
                            <div class="text-sm text-gray-400">${subtitle}</div>
                        </div>
                        <i class="fas fa-chevron-right text-gray-500"></i>
                    </button>
                `;
            }).join('');
            
            overlay.innerHTML = `
                <div class="bg-gray-900 rounded-2xl p-6 max-w-md w-full mx-4 border border-white/10">
                    <div class="flex items-center justify-between mb-6">
                        <h3 class="text-xl font-bold text-white">Select Account</h3>
                        <button onclick="closeOAuthModal()" class="text-gray-400 hover:text-white">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <p class="text-gray-400 mb-4">Choose which account to connect:</p>
                    <div class="space-y-3 max-h-80 overflow-y-auto" id="oauth-accounts-list" data-state="${state}">
                        ${accountsHtml}
                    </div>
                </div>
            `;
            
            document.body.appendChild(overlay);
        }
        
        function closeOAuthModal() {
            const overlay = document.getElementById('oauth-modal-overlay');
            if (overlay) overlay.remove();
            pendingOAuthState = null;
        }
        
        async function selectOAuthAccount(index) {
            const container = document.getElementById('oauth-accounts-list');
            const state = container.dataset.state;
            const buttons = container.querySelectorAll('button');
            const accountData = JSON.parse(buttons[index].dataset.account);
            
            try {
                const response = await fetch(`${API_URL}/api/oauth/connect`, {
                    method: 'POST',
                    headers: { 
                        'Authorization': `Bearer ${AUTH_TOKEN}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        state: state,
                        account_type: accountData.type,
                        account_id: accountData.id,
                        account_name: accountData.name,
                        page_access_token: accountData.access_token,
                        facebook_page_id: accountData.facebook_page_id
                    })
                });
                
                const data = await response.json();
                
                if (response.ok && data.success) {
                    closeOAuthModal();
                    alert(`‚úì ${accountData.name} connected successfully!`);
                    loadSocialConnections();
                } else {
                    alert(`Connection failed: ${data.error}`);
                }
            } catch (error) {
                alert('Failed to connect: ' + error.message);
            }
        }
        
        async function manualConnect(platform, platformNames) {
            // Fallback to manual token entry when OAuth not configured
            const accessToken = prompt(`Enter ${platformNames[platform]} Access Token:\n\n(OAuth not configured - using manual entry)`);
            if (!accessToken) return;
            
            let extraData = {};
            
            if (platform === 'facebook') {
                const pageId = prompt('Enter Facebook Page ID:');
                if (!pageId) return;
                extraData.page_id = pageId;
            } else if (platform === 'instagram') {
                const accountId = prompt('Enter Instagram Business Account ID:');
                if (!accountId) return;
                extraData.account_id = accountId;
            } else if (platform === 'linkedin') {
                const orgId = prompt('Enter LinkedIn Organization ID:');
                if (!orgId) return;
                extraData.org_id = orgId;
            } else if (platform === 'gbp') {
                const locationId = prompt('Enter GBP Location ID:');
                if (!locationId) return;
                extraData.location_id = locationId;
            }
            
            try {
                const response = await fetch(`${API_URL}/api/social/connect/${currentClient.id}/${platform}`, {
                    method: 'POST',
                    headers: { 
                        'Authorization': `Bearer ${AUTH_TOKEN}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        access_token: accessToken,
                        ...extraData
                    })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    alert(`‚úì ${platformNames[platform]} connected successfully!`);
                    loadSocialConnections();
                } else {
                    alert(`Connection failed: ${data.error}`);
                }
            } catch (error) {
                alert('Connection failed: ' + error.message);
            }
        }
        
        async function disconnectSocial(platform) {
            if (!confirm(`Are you sure you want to disconnect ${platform}?`)) return;
            
            try {
                const response = await fetch(`${API_URL}/api/social/disconnect/${currentClient.id}/${platform}`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${AUTH_TOKEN}` }
                });
                
                if (response.ok) {
                    alert('Disconnected successfully');
                    loadSocialConnections();
                }
            } catch (error) {
                alert('Disconnect failed: ' + error.message);
            }
        }
        
        // ==========================================
        // CHATBOT MANAGEMENT
        // ==========================================
        
        let chatbotConfig = null;
        
        async function loadChatbotConfig() {
            if (!currentClient) return;
            
            try {
                const response = await fetch(`${API_URL}/api/chatbot/config/${currentClient.id}`, {
                    headers: { 'Authorization': `Bearer ${AUTH_TOKEN}` }
                });
                
                if (response.ok) {
                    chatbotConfig = await response.json();
                    populateChatbotForm(chatbotConfig);
                    loadChatbotAnalytics();
                    loadEmbedCode();
                    loadRecentConversations();
                }
            } catch (error) {
                console.error('Failed to load chatbot config:', error);
            }
        }
        
        function populateChatbotForm(config) {
            document.getElementById('chatbotEnabled').checked = config.is_active;
            document.getElementById('chatbotName').value = config.name || 'Support Assistant';
            document.getElementById('chatbotPosition').value = config.position || 'bottom-right';
            document.getElementById('chatbotColor').value = config.primary_color || '#8b5cf6';
            document.getElementById('chatbotColorText').value = config.primary_color || '#8b5cf6';
            document.getElementById('chatbotColor2').value = config.secondary_color || '#ec4899';
            document.getElementById('chatbotColor2Text').value = config.secondary_color || '#ec4899';
            document.getElementById('chatbotWelcome').value = config.welcome_message || 'Hi! How can I help you today?';
            document.getElementById('chatbotCollectName').checked = config.collect_name !== false;
            document.getElementById('chatbotCollectEmail').checked = config.collect_email !== false;
            document.getElementById('chatbotCollectPhone').checked = config.collect_phone !== false;
            document.getElementById('chatbotLeadTrigger').value = config.lead_capture_trigger || 'after_3_messages';
            document.getElementById('chatbotEmailNotify').checked = config.email_notifications !== false;
            document.getElementById('chatbotNotifyEmail').value = config.notification_email || '';
            
            // Update preview
            updateChatbotPreview();
        }
        
        async function loadChatbotAnalytics() {
            if (!currentClient || !chatbotConfig) return;
            
            try {
                const response = await fetch(`${API_URL}/api/chatbot/analytics/${currentClient.id}`, {
                    headers: { 'Authorization': `Bearer ${AUTH_TOKEN}` }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    document.getElementById('chatbotConversations').textContent = data.total_conversations || 0;
                    document.getElementById('chatbotLeads').textContent = data.total_leads || 0;
                    document.getElementById('chatbotRating').textContent = data.avg_rating ? data.avg_rating.toFixed(1) : '--';
                }
            } catch (error) {
                console.error('Failed to load chatbot analytics:', error);
            }
        }
        
        async function loadEmbedCode() {
            if (!currentClient || !chatbotConfig) return;
            
            try {
                const response = await fetch(`${API_URL}/api/chatbot/config/${currentClient.id}/embed-code`, {
                    headers: { 'Authorization': `Bearer ${AUTH_TOKEN}` }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    document.getElementById('chatbotEmbedCode').textContent = data.embed_code;
                }
            } catch (error) {
                document.getElementById('chatbotEmbedCode').textContent = '<!-- Error loading embed code -->';
            }
        }
        
        async function loadRecentConversations() {
            if (!currentClient) return;
            
            try {
                const response = await fetch(`${API_URL}/api/chatbot/conversations?client_id=${currentClient.id}&limit=5`, {
                    headers: { 'Authorization': `Bearer ${AUTH_TOKEN}` }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    const container = document.getElementById('recentConversations');
                    
                    if (data.conversations && data.conversations.length > 0) {
                        container.innerHTML = data.conversations.map(conv => `
                            <div class="p-3 glass rounded-lg">
                                <div class="flex items-center justify-between mb-1">
                                    <span class="text-white font-medium text-sm">${escapeHtml(conv.visitor_name || 'Anonymous')}</span>
                                    <span class="text-xs text-gray-500">${getTimeAgo(conv.last_message_at)}</span>
                                </div>
                                <div class="flex items-center gap-2 text-xs">
                                    <span class="text-gray-400">${conv.message_count} messages</span>
                                    ${conv.is_lead_captured ? '<span class="text-green-400">‚úì Lead</span>' : ''}
                                </div>
                            </div>
                        `).join('');
                    } else {
                        container.innerHTML = '<p class="text-gray-500 text-sm text-center py-4">No conversations yet</p>';
                    }
                }
            } catch (error) {
                console.error('Failed to load conversations:', error);
            }
        }
        
        function getTimeAgo(dateString) {
            if (!dateString) return '';
            const date = new Date(dateString);
            const now = new Date();
            const seconds = Math.floor((now - date) / 1000);
            
            if (seconds < 60) return 'Just now';
            if (seconds < 3600) return `${Math.floor(seconds / 60)}m ago`;
            if (seconds < 86400) return `${Math.floor(seconds / 3600)}h ago`;
            return `${Math.floor(seconds / 86400)}d ago`;
        }
        
        function toggleChatbot() {
            // Will save when user clicks save button
        }
        
        async function saveChatbotConfig() {
            if (!currentClient) {
                alert('Please select a client first');
                return;
            }
            
            const config = {
                is_active: document.getElementById('chatbotEnabled').checked,
                name: document.getElementById('chatbotName').value,
                position: document.getElementById('chatbotPosition').value,
                primary_color: document.getElementById('chatbotColor').value,
                secondary_color: document.getElementById('chatbotColor2').value,
                welcome_message: document.getElementById('chatbotWelcome').value,
                collect_name: document.getElementById('chatbotCollectName').checked,
                collect_email: document.getElementById('chatbotCollectEmail').checked,
                collect_phone: document.getElementById('chatbotCollectPhone').checked,
                lead_capture_trigger: document.getElementById('chatbotLeadTrigger').value,
                email_notifications: document.getElementById('chatbotEmailNotify').checked,
                notification_email: document.getElementById('chatbotNotifyEmail').value
            };
            
            try {
                const response = await fetch(`${API_URL}/api/chatbot/config/${currentClient.id}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${AUTH_TOKEN}`
                    },
                    body: JSON.stringify(config)
                });
                
                if (response.ok) {
                    const data = await response.json();
                    chatbotConfig = data.config;
                    alert('‚úì Chatbot settings saved successfully!');
                    loadEmbedCode();
                } else {
                    const error = await response.json();
                    alert('Failed to save: ' + (error.error || 'Unknown error'));
                }
            } catch (error) {
                alert('Failed to save chatbot settings');
                console.error(error);
            }
        }
        
        function updateChatbotPreview() {
            const color1 = document.getElementById('chatbotColor').value;
            const color2 = document.getElementById('chatbotColor2').value;
            const name = document.getElementById('chatbotName').value;
            const welcome = document.getElementById('chatbotWelcome').value;
            
            const bubble = document.getElementById('previewBubble');
            const header = document.getElementById('previewHeader');
            const nameEl = document.getElementById('previewName');
            const messageEl = document.getElementById('previewMessage');
            
            bubble.style.background = `linear-gradient(135deg, ${color1}, ${color2})`;
            header.style.background = `linear-gradient(135deg, ${color1}, ${color2})`;
            nameEl.textContent = name || 'Support Assistant';
            messageEl.textContent = welcome || 'Hi! How can I help you today?';
        }
        
        // Color picker sync
        document.getElementById('chatbotColor')?.addEventListener('input', function() {
            document.getElementById('chatbotColorText').value = this.value;
            updateChatbotPreview();
        });
        document.getElementById('chatbotColorText')?.addEventListener('input', function() {
            document.getElementById('chatbotColor').value = this.value;
            updateChatbotPreview();
        });
        document.getElementById('chatbotColor2')?.addEventListener('input', function() {
            document.getElementById('chatbotColor2Text').value = this.value;
            updateChatbotPreview();
        });
        document.getElementById('chatbotColor2Text')?.addEventListener('input', function() {
            document.getElementById('chatbotColor2').value = this.value;
            updateChatbotPreview();
        });
        document.getElementById('chatbotName')?.addEventListener('input', updateChatbotPreview);
        document.getElementById('chatbotWelcome')?.addEventListener('input', updateChatbotPreview);
        
        // Preview toggle
        document.getElementById('previewBubble')?.addEventListener('click', function() {
            const window = document.getElementById('previewWindow');
            window.classList.toggle('hidden');
        });
        
        function copyEmbedCode() {
            const code = document.getElementById('chatbotEmbedCode').textContent;
            navigator.clipboard.writeText(code).then(() => {
                alert('‚úì Embed code copied to clipboard!');
            }).catch(() => {
                // Fallback
                const textarea = document.createElement('textarea');
                textarea.value = code;
                document.body.appendChild(textarea);
                textarea.select();
                document.execCommand('copy');
                document.body.removeChild(textarea);
                alert('‚úì Embed code copied to clipboard!');
            });
        }
        
        function viewAllConversations() {
            alert('Full conversation view coming soon! For now, conversations are listed here.');
        }
        
        // ==========================================
        // MCP SUPPORT CHATBOT
        // ==========================================
        
        let mcpSupportOpen = false;
        let mcpSupportHistory = [];
        
        function toggleMCPSupport() {
            mcpSupportOpen = !mcpSupportOpen;
            const chatWindow = document.getElementById('mcpSupportWindow');
            const chatBubble = document.getElementById('mcpSupportBubble');
            
            if (mcpSupportOpen) {
                chatWindow.classList.remove('hidden');
                chatWindow.classList.add('flex');
                chatBubble.classList.add('hidden');
                document.getElementById('mcpSupportInput').focus();
            } else {
                chatWindow.classList.add('hidden');
                chatWindow.classList.remove('flex');
                chatBubble.classList.remove('hidden');
            }
        }
        
        async function sendMCPSupportMessage() {
            const input = document.getElementById('mcpSupportInput');
            const message = input.value.trim();
            if (!message) return;
            
            input.value = '';
            
            // Add user message
            addMCPMessage('user', message);
            mcpSupportHistory.push({ role: 'user', content: message });
            
            // Show typing
            document.getElementById('mcpSupportTyping').classList.remove('hidden');
            
            try {
                const response = await fetch('/api/chatbot/mcp-support/message', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        message: message,
                        history: mcpSupportHistory.slice(-10) // Last 10 messages
                    })
                });
                
                const data = await response.json();
                
                document.getElementById('mcpSupportTyping').classList.add('hidden');
                
                addMCPMessage('assistant', data.response);
                mcpSupportHistory.push({ role: 'assistant', content: data.response });
                
            } catch (error) {
                document.getElementById('mcpSupportTyping').classList.add('hidden');
                addMCPMessage('assistant', 'Sorry, I had trouble responding. Please try again!');
            }
        }
        
        function addMCPMessage(role, content) {
            const container = document.getElementById('mcpSupportMessages');
            const div = document.createElement('div');
            div.className = role === 'user' 
                ? 'ml-auto bg-gradient-to-r from-blue-600 to-cyan-600 text-white rounded-2xl rounded-br-sm px-4 py-2 max-w-[80%]'
                : 'bg-gray-700 text-gray-100 rounded-2xl rounded-bl-sm px-4 py-2 max-w-[80%]';
            div.textContent = content;
            container.appendChild(div);
            container.scrollTop = container.scrollHeight;
        }
    </script>
    
    <!-- MCP Support Chatbot -->
    <div id="mcpSupportBubble" onclick="toggleMCPSupport()" 
         class="fixed bottom-6 right-6 w-14 h-14 bg-gradient-to-r from-purple-600 to-pink-600 rounded-full cursor-pointer shadow-lg hover:shadow-xl transition-all hover:scale-105 flex items-center justify-center z-50"
         title="Need help? Ask MCP Support">
        <svg class="w-7 h-7 text-white" fill="currentColor" viewBox="0 0 24 24">
            <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
        </svg>
    </div>
    
    <div id="mcpSupportWindow" class="hidden fixed bottom-6 right-6 w-96 h-[500px] bg-gray-800 rounded-2xl shadow-2xl flex-col z-50 border border-gray-700 overflow-hidden">
        <!-- Header -->
        <div class="bg-gradient-to-r from-purple-600 to-pink-600 p-4 flex items-center gap-3">
            <div class="w-10 h-10 bg-white/20 rounded-full flex items-center justify-center">
                <svg class="w-6 h-6 text-white" fill="currentColor" viewBox="0 0 24 24">
                    <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 17h-2v-2h2v2zm2.07-7.75l-.9.92C13.45 12.9 13 13.5 13 15h-2v-.5c0-1.1.45-2.1 1.17-2.83l1.24-1.26c.37-.36.59-.86.59-1.41 0-1.1-.9-2-2-2s-2 .9-2 2H8c0-2.21 1.79-4 4-4s4 1.79 4 4c0 .88-.36 1.68-.93 2.25z"/>
                </svg>
            </div>
            <div class="flex-1">
                <div class="text-white font-semibold">MCP Support</div>
                <div class="text-white/70 text-sm">How can I help?</div>
            </div>
            <button onclick="toggleMCPSupport()" class="w-8 h-8 rounded-lg bg-white/20 hover:bg-white/30 flex items-center justify-center transition">
                <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                </svg>
            </button>
        </div>
        
        <!-- Messages -->
        <div id="mcpSupportMessages" class="flex-1 overflow-y-auto p-4 space-y-3">
            <div class="bg-gray-700 text-gray-100 rounded-2xl rounded-bl-sm px-4 py-2 max-w-[80%]">
                üëã Hi! I'm your MCP assistant. I can help you navigate the dashboard, generate content, find features, and more. What would you like to do?
            </div>
        </div>
        
        <!-- Typing indicator -->
        <div id="mcpSupportTyping" class="hidden px-4 pb-2">
            <div class="bg-gray-700 rounded-2xl px-4 py-2 inline-flex gap-1 items-center">
                <span class="w-2 h-2 bg-gray-400 rounded-full animate-bounce"></span>
                <span class="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style="animation-delay: 0.1s"></span>
                <span class="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style="animation-delay: 0.2s"></span>
            </div>
        </div>
        
        <!-- Input -->
        <div class="p-4 border-t border-gray-700">
            <div class="flex gap-2">
                <input type="text" id="mcpSupportInput" 
                       placeholder="Ask me anything about MCP..."
                       onkeypress="if(event.key==='Enter')sendMCPSupportMessage()"
                       class="flex-1 bg-gray-700 border border-gray-600 rounded-full px-4 py-2 text-white placeholder-gray-400 focus:outline-none focus:border-purple-500">
                <button onclick="sendMCPSupportMessage()" 
                        class="w-10 h-10 bg-gradient-to-r from-purple-600 to-pink-600 rounded-full flex items-center justify-center hover:opacity-90 transition">
                    <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/>
                    </svg>
                </button>
            </div>
        </div>
    </div>
</body>
</html>
